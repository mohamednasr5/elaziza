<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ุชุณุฌูู ุงูุชุตููุช โ ูุฌูุน ุงูุนุฒูุฒุฉ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* [ููุณ ุงูุชูุณููุงุช ููุง ุฃุฑุณูุชูุง ููุง ุฏุงุนู ููุชุบููุฑ] */
  </style>
</head>
<body>
<!-- ูุงูุฐุฉ ูููุฉ ุงูุณุฑ -->
<div id="password-modal">
  <div class="pass-box">
    <div class="pass-title">ูุฌูุน ุงูุนุฒูุฒุฉ ุงูุงูุชุฎุงุจู</div>
    <div class="pass-subtitle">ูุณู ุงูุฅุดุฑุงู</div>
    <div class="pass-text">ูู ูุถูู ุฃุฏุฎู ูููุฉ ุงูุณุฑ ุงูุฎุงุตุฉ ุจุงููุณู</div>
    <div class="pass-row">
      <input type="password" id="password-input" class="pass-input" placeholder="โขโขโขโขโขโข" autocomplete="off">
      <span class="pass-toggle" onclick="togglePass()">๐</span>
    </div>
    <button class="pass-btn" onclick="checkPass()">ุชุณุฌูู ุงูุฏุฎูู</button>
    <div id="pw-err" class="pass-err">ูููุฉ ุงูุณุฑ ุบูุฑ ุตุญูุญุฉ</div>
  </div>
</div>

<!-- ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ -->
<div class="container hidden" id="main-container">
  <div class="welcome-header" id="welcome-message"></div>
  <h2>ุชุณุฌูู ุงูุชุตููุช</h2>
  <div class="subtitle">ูุธุงู ุญุตุฑ ูุชุณุฌูู ุงูุฃุตูุงุช - ูุฌูุน ุงูุนุฒูุฒุฉ</div>

  <form id="vote-form" autocomplete="off">
    <label>ุงุณู ุงููุงุฎุจ:</label>
    <input type="text" id="voter-name" placeholder="ุงูุชุจ ุงูุงุณู ูุงููุงู" autocomplete="off">

    <label>ุงุฎุชุฑ ุงููุฑุดุญ (ุญุฏ ุฃูุตู 2):</label>
    <div class="candidate-list" id="candidate-list"></div>

    <div class="sec-box">
      <span>ุญุงูุฉ ุงูุตูุช:</span>
      <label><input type="radio" name="vvalid" value="ุตุญูุญ"> ุตุญูุญ</label>
      <label><input type="radio" name="vvalid" value="ุจุงุทู"> ุจุงุทู</label>
    </div>

    <div class="btn-row">
      <button type="submit" class="btn-primary">ุชุณุฌูู ุงูุชุตููุช</button>
      <button type="reset" class="btn-reset">ูุณุญ</button>
    </div>

    <div id="msg-warn" class="msg-warn"></div>
    <div id="msg-confirm" class="msg-confirm"></div>
  </form>

  <div class="sig">ุชู ุชุทููุฑ ุงููุธุงู ุจูุงุณุทุฉ ุงููููุฏุณ ูุญูุฏ ุญูุงุฏ</div>
</div>

<!-- Firebase + Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC9j__hwloitAcYuLOyP-ydoB3ffHng0wM",
  authDomain: "elaziza-9c09f.firebaseapp.com",
  databaseURL: "https://elaziza-9c09f-default-rtdb.firebaseio.com",
  projectId: "elaziza-9c09f",
  storageBucket: "elaziza-9c09f.appspot.com",
  messagingSenderId: "166855726580",
  appId: "1:166855726580:web:f9ced2806b65265a8e95a1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let userType = null;

// ูููุฉ ุงูุณุฑ
window.checkPass = function () {
  const pass = document.getElementById("password-input").value.trim();

  if (pass === "205050") userType = "men";
  else if (pass === "506070") userType = "women";
  else {
    showWarnPass();
    return;
  }

  document.getElementById("password-modal").classList.add("hidden");
  document.getElementById("main-container").classList.remove("hidden");
  document.getElementById("welcome-message").textContent =
    userType === "men" ? "ูุฑุญุจุง ุจูู โ ุฑุฌุงู ๐ง" : "ูุฑุญุจุง ุจูู โ ูุณุงุก ๐ฉ";
};

function showWarnPass() {
  const err = document.getElementById("pw-err");
  err.style.display = "block";
  setTimeout(() => err.style.display = "none", 1500);
}

// ุงุธูุงุฑ ูููุฉ ุงูุณุฑ
window.togglePass = function () {
  const p = document.getElementById("password-input");
  p.type = p.type === "password" ? "text" : "password";
};

// ุงููุฑุดุญูู (ููุง ูู ุจุฏูู ุชุนุฏูู)
const candidates = [
  ["1","ุงููุงุจ ุงูุนูุฏู","๐"],
  ["2","ูุญูุฏ ุงูุนุชูุงูู","๐"],
  ["3","ุฃุญูุฏ ุงูุญุฏูุฏู","๐ฆ"],
  ["4","ุนุงุฏู ุงูุฌูุงุฑ","๐ฆ"],
  ["5","ุงุญูุฏ ูุญูุฏ ูุญูุฏ ุณูุฑู","๐ฃ"],
  ["6","ูููุฏ ุชูุณูุฑ ุงูุงููุฑ","๐"],
  ["7","ููุงู ุงูุนูุณูู","๐"],
  ["8","ุงูุจุฏูู ุฌููุฒ","๐"],
  ["9","ุงุญูุฏ ุงูุฑูุณ","๐ฆ"],
  ["10","ุฃุญูุฏ ุนูู","โ"],
  ["11","ุญุณู ุงููููุงุท","๐ฟ"],
  ["12","ุนูุฑู ูุญูุฏ ุจุญูุฑู","๐"],
  ["13","ุงูุณูุฏ ุทูุงู","๐ซ"],
  ["14","ูุญูุฏ ุฏูุฏู","๐"],
  ["15","ูุฌุฏู ุงูุฃููุฑ","๐"]
];

const listBox = document.getElementById("candidate-list");

candidates.forEach(c => {
  const item = document.createElement("div");
  item.className = "candidate-item";
  const box = document.createElement("input");
  box.type = "checkbox";
  box.value = c[1];
  box.className = "candidate-checkbox";
  item.innerHTML = `
    <div class="c-left">
      <div class="num-circle">${c[0]}</div>
      <div class="c-name">${c[1]}</div>
    </div>
    <div class="c-right"><span class="c-icon">${c[2]}</span></div>`;
  item.appendChild(box);
  item.addEventListener("click", e => {
    if (e.target !== box) box.checked = !box.checked;
    limitSelect();
  });
  box.addEventListener("change", limitSelect);
  listBox.appendChild(item);
});

function limitSelect() {
  const selected = document.querySelectorAll(".candidate-checkbox:checked");
  if (selected.length > 2) {
    selected[selected.length - 1].checked = false;
    showWarn("ูููู ุงุฎุชูุงุฑ ูุฑุดุญูู ููุท");
  }
}

function invalidName(name) {
  if (name.length < 4) return true;
  if (/[0-9]/.test(name)) return true;
  if (/[^ุก-ู\s]/.test(name)) return true;
  return false;
}

async function isNameUsed(name) {
  if (!userType) return false;
  const q = query(ref(db, `votes_${userType}`), orderByChild("name"), equalTo(name));
  const snap = await get(q);
  return snap.exists();
}

document.getElementById("vote-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!userType) return showWarn("ูุฌุจ ุงุฎุชูุงุฑ ุงููุณู");

  const name = document.getElementById("voter-name").value.trim();
  const selected = [...document.querySelectorAll(".candidate-checkbox:checked")].map(c => c.value);
  const validity = document.querySelector('input[name="vvalid"]:checked');

  if (invalidName(name)) return showWarn("ุงูุงุณู ุบูุฑ ุตุญูุญ");
  if (selected.length === 0) return showWarn("ุงุฎุชุฑ ูุฑุดุญ ูุงุญุฏ ุนูู ุงูุฃูู");
  if (!validity) return showWarn("ุญุฏุฏ ุญุงูุฉ ุงูุตูุช");
  if (await isNameUsed(name)) return showWarn("ูุฐุง ุงูุงุณู ูุณุฌู ูุณุจููุง");

  push(ref(db, `votes_${userType}`), {
    name,
    selected,
    vote_validity: validity.value,
    timestamp: Date.now()
  }).then(() => {
    showConfirm("ุชู ุชุณุฌูู ุงูุชุตููุช โ");
    document.getElementById("vote-form").reset();
    document.querySelectorAll(".candidate-checkbox").forEach(c => c.checked = false);
  }).catch(err => showWarn("ุฎุทุฃ ุฃุซูุงุก ุงูุชุณุฌูู: " + err.message));
});

function showWarn(msg) {
  const el = document.getElementById("msg-warn");
  el.textContent = msg;
  el.style.display = "block";
  setTimeout(() => el.style.display = "none", 2500);
}
function showConfirm(msg) {
  const el = document.getElementById("msg-confirm");
  el.textContent = msg;
  el.style.display = "block";
  setTimeout(() => el.style.display = "none", 2500);
}
</script>
</body>
</html>
