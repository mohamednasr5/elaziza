<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ™ÿµŸàŸäÿ™ - ÿßŸÑÿπÿ≤Ÿäÿ≤ÿ©</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
/* ---------------------- RESET + BASE ---------------------- */
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:"Cairo",sans-serif;
}

body{
  background:linear-gradient(135deg,#4e65ff 0%,#8a76ff 100%);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:20px;
  color:#fff;
  overflow-x:hidden;
}

/* ---------------------- CONTAINER ------------------------- */
.container{
  width:100%;
  max-width:820px;
  background:#ffffff;
  color:#222;
  padding:40px 35px;
  border-radius:22px;
  box-shadow:0 35px 80px rgba(0,0,0,0.25);
  animation:fadeIn .6s ease;
  position:relative;
}

@keyframes fadeIn{
  from{opacity:0; transform:translateY(40px);}
  to{opacity:1; transform:translateY(0);}
}

/* ---------------------- TITLE ------------------------------ */
h2{
  text-align:center;
  background:linear-gradient(135deg,#4e65ff 0%,#8a76ff 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  font-size:2.3em;
  font-weight:900;
  letter-spacing:1px;
  margin-bottom:10px;
}

/* ---------------------- COMMITTEE BOX ---------------------- */
.committee-info{
  text-align:center;
  margin-top:12px;
  margin-bottom:28px;
  background:#f6f7ff;
  padding:16px;
  border-radius:16px;
  border-right:6px solid #4e65ff;
  box-shadow:0 8px 20px rgba(0,0,0,0.05);
}

.committee-name{
  font-size:1.15em;
  font-weight:800;
  color:#4e65ff;
  margin-bottom:6px;
}

.committee-address{
  font-size:0.92em;
  font-weight:600;
  color:#666;
}

/* ---------------------- INPUTS ----------------------------- */
label{
  font-weight:800;
  color:#333;
  margin-top:20px;
  display:block;
  font-size:1.05em;
}

input[type=text]{
  width:100%;
  padding:13px 14px;
  border-radius:14px;
  border:2px solid #dfe4ff;
  background:#fafaff;
  font-size:1em;
  transition:all .25s;
}

input[type=text]:focus{
  outline:none;
  border-color:#4e65ff;
  box-shadow:0 0 0 4px rgba(78,101,255,0.15);
}

/* ---------------------- CANDIDATE LIST --------------------- */
.candidate-list{
  margin-top:16px;
  background:#fafaff;
  border:2px solid #dfe4ff;
  border-radius:16px;
  max-height:380px;
  overflow-y:auto;
  padding:14px;
  scroll-behavior:smooth;
}

.candidate-item{
  background:#fff;
  border:1px solid #e5e8ff;
  padding:14px 12px;
  border-radius:14px;
  margin-bottom:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  transition:all .25s;
  cursor:pointer;
  border-right:5px solid #4e65ff;
}

.candidate-item:hover{
  background:#f0f2ff;
  border-color:#4e65ff;
  box-shadow:0 6px 16px rgba(78,101,255,0.25);
}

.candidate-item.selected{
  background:linear-gradient(135deg,#4e65ff 0%,#8a76ff 100%);
  color:#fff;
  border-right-color:#fff;
}

.c-left{
  display:flex;
  align-items:center;
  gap:14px;
  flex:1;
}

.num-circle{
  width:36px;
  height:36px;
  border-radius:50%;
  background:#4e65ff;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1em;
  font-weight:900;
  box-shadow:0 3px 8px rgba(0,0,0,0.15);
}

.candidate-item.selected .num-circle{
  background:#fff;
  color:#4e65ff;
}

.c-right .c-icon{
  font-size:1.9em;
}

/* ---------------------- RADIO AREA ------------------------- */
.sec-box{
  margin-top:22px;
  background:#f5f7ff;
  border:2px solid #dfe4ff;
  border-radius:16px;
  padding:18px;
  box-shadow:0 8px 20px rgba(0,0,0,0.05);
}

.sec-title{
  font-weight:900;
  color:#4e65ff;
  display:block;
  margin-bottom:14px;
  font-size:1.15em;
}

.radio-group{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
}

.radio-item{
  display:flex;
  align-items:center;
  gap:8px;
  cursor:pointer;
  padding:12px;
  background:#fff;
  border-radius:14px;
  border:2px solid #dfe4ff;
  transition:all .25s;
}

.radio-item:hover{
  border-color:#4e65ff;
  background:#f0f2ff;
}

.radio-item.selected{
  background:#4e65ff;
  color:#fff;
  border-color:#4e65ff;
}

/* ---------------------- BUTTONS --------------------------- */
.btn-row{
  display:flex;
  gap:14px;
  margin-top:28px;
}

button{
  flex:1;
  padding:14px;
  border:none;
  border-radius:14px;
  cursor:pointer;
  font-weight:900;
  font-size:1.08em;
  transition:all .25s;
}

.btn-primary{
  background:linear-gradient(135deg,#4e65ff 0%,#8a76ff 100%);
  color:#fff;
}

.btn-primary:hover{
  transform:translateY(-3px);
  box-shadow:0 8px 20px rgba(78,101,255,0.35);
}

.btn-reset{
  background:#e1e6ff;
  color:#4e65ff;
}

.btn-logout{
  background:#ffe5e8;
  color:#c62828;
}

.btn-reset:hover{
  background:#d5ddff;
}

.btn-logout:hover{
  background:#ffccd1;
}

/* ---------------------- FLASH MESSAGES --------------------- */
.msg-warn, .msg-confirm{
  display:none;
  margin-top:18px;
  padding:14px;
  border-radius:12px;
  text-align:center;
  font-weight:800;
  animation:slideDown .25s ease;
}

@keyframes slideDown{
  from{opacity:0; transform:translateY(-12px);}
  to{opacity:1; transform:translateY(0);}
}

.msg-warn{
  background:#ffe5e7;
  color:#b0191a;
  border-right:5px solid #b0191a;
}

.msg-confirm{
  background:#e8f8ee;
  color:#1b8f3a;
  border-right:5px solid #1b8f3a;
}

/* ---------------------- FLOATING BUBBLE ------------------- */
#bubble{
  position:fixed;
  bottom:24px;
  right:24px;
  background:#fff;
  color:#222;
  padding:18px;
  border-radius:16px;
  box-shadow:0 8px 35px rgba(0,0,0,0.35);
  font-size:1.05em;
  font-weight:700;
  display:none;
  width:340px;
  max-width:calc(100vw - 60px);
  animation:slide .4s ease;
  border-right:6px solid #4e65ff;
  z-index:99999;
}

@keyframes slide{
  from{transform:translateY(20px); opacity:0;}
  to{transform:translateY(0); opacity:1;}
}

#bubble.active{
  display:flex;
  align-items:flex-start;
  gap:12px;
}

#bubble-icon{
  font-size:1.7em;
  min-width:32px;
  text-align:center;
  margin-top:2px;
}

#bubble-close{
  background:none;
  border:none;
  font-size:1.6em;
  color:#777;
  cursor:pointer;
  padding:0;
  transition:.25s;
  opacity:.6;
}

#bubble-close:hover{
  opacity:1;
  color:#4e65ff;
}

/* ---------------------- SIGNATURE -------------------------- */
.sig{
  text-align:left;
  margin-top:32px;
  color:#888;
  font-style:italic;
  font-size:.88em;
}

/* ---------------------- MOBILE ----------------------------- */
@media(max-width:600px){
  .container{ padding:24px; }
  h2{ font-size:1.8em; }
  .radio-group{ grid-template-columns:1fr; }
  .candidate-list{ max-height:420px; }
}
*{ margin:0; padding:0; box-sizing:border-box; font-family:"Cairo",sans-serif; }
body{
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  min-height:100vh; display:flex; justify-content:center; align-items:center;
  padding:20px; color:#fff;
}
.hidden{ display:none !important; }

.container{
  width:100%; max-width:800px; background:#fff; color:#222;
  padding:35px; border-radius:20px;
  box-shadow:0 20px 60px rgba(0,0,0,.3);
  animation:fade .5s ease;
}
@keyframes fade{
  from{opacity:0; transform:translateY(20px);}
  to{opacity:1; transform:translateY(0);}
}

h2{
  text-align:center; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  font-size:2.2em; font-weight:900;
}

.committee-info{
  text-align:center; margin-top:12px; margin-bottom:25px;
  background:linear-gradient(135deg,#f5f7ff 0%,#eff2ff 100%);
  padding:14px; border-radius:12px; border-left:4px solid #667eea;
}

.committee-name{
  font-size:1.1em; font-weight:700; color:#667eea; margin-bottom:4px;
}

.committee-address{
  font-size:0.9em; color:#666; font-weight:500;
}

label{ font-weight:700; color:#333; margin-top:18px; display:block; }
input[type=text]{
  width:100%; padding:13px 14px; border-radius:12px;
  border:2px solid #e0e7ff; background:#f8f9ff; font-size:1em; transition:all 0.3s;
}
input[type=text]:focus{
  outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,0.1);
}

.candidate-list{
  margin-top:14px; background:#f8f9ff; border:2px solid #e0e7ff;
  border-radius:14px; max-height:350px; overflow-y:auto; padding:12px;
}
.candidate-item{
  background:#fff; border:1px solid #e8ecff; padding:12px;
  border-radius:12px; margin-bottom:10px;
  display:flex; justify-content:space-between; align-items:center;
  transition:all 0.3s; cursor:pointer; border-left:4px solid #667eea;
}
.candidate-item:hover{ 
  background:linear-gradient(135deg,#f5f7ff 0%,#eff2ff 100%);
  border-color:#667eea; box-shadow:0 4px 12px rgba(102,126,234,0.2);
}
.candidate-item.selected{
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  color:#fff; border-left-color:#fff;
}
.c-left{ display:flex; align-items:center; gap:12px; flex:1; }
.num-circle{
  width:32px; height:32px; border-radius:50%;
  background:#667eea; color:#fff;
  display:flex; align-items:center; justify-content:center;
  font-size:0.95em; font-weight:900;
}
.candidate-item.selected .num-circle{
  background:#fff; color:#667eea;
}
.c-name{ font-weight:700; }
.c-right{ display:flex; align-items:center; gap:10px; }
.c-icon{ font-size:1.8em; }
input[type="checkbox"]{ width:20px; height:20px; cursor:pointer; accent-color:#667eea; }

.sec-box{
  margin-top:18px; background:linear-gradient(135deg,#f5f7ff 0%,#eff2ff 100%);
  border:2px solid #e0e7ff; border-radius:12px; padding:16px;
}
.sec-title{ font-weight:700; color:#667eea; display:block; margin-bottom:12px; font-size:1.05em; }
.radio-group{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.radio-item{
  display:flex; align-items:center; gap:8px; cursor:pointer;
  padding:10px; background:#fff; border-radius:10px;
  border:2px solid #e0e7ff; transition:all 0.3s;
}
.radio-item:hover{ border-color:#667eea; background:#f8f9ff; }
.radio-item input[type="radio"]{ width:18px; height:18px; cursor:pointer; }
.radio-item.selected{
  background:#667eea; color:#fff; border-color:#667eea;
}
.radio-item.selected input[type="radio"]{ accent-color:#fff; }

.btn-row{ display:flex; gap:12px; margin-top:25px; }
button{
  flex:1; padding:13px; border:none; border-radius:12px;
  cursor:pointer; font-weight:700; font-size:1.05em; transition:all 0.3s;
}
.btn-primary{ background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; }
.btn-primary:hover{ transform:translateY(-2px); }
.btn-reset{ background:#e0e7ff; color:#667eea; font-weight:700; }
.btn-reset:hover{ background:#d3ddff; }
.btn-logout{ background:#ffebee; color:#c62828; font-weight:700; }
.btn-logout:hover{ background:#ffcdd2; }

.msg-warn, .msg-confirm{
  display:none; margin-top:15px; padding:13px; border-radius:10px;
  text-align:center; font-weight:700; animation:slideDown 0.3s ease;
}
@keyframes slideDown{
  from{opacity:0; transform:translateY(-10px);}
  to{opacity:1; transform:translateY(0);}
}
.msg-warn{ background:#ffebee; color:#c62828; border-left:4px solid #c62828; }
.msg-confirm{ background:#e8f5e9; color:#2e7d32; border-left:4px solid #2e7d32; }

#bubble{
  position:fixed; bottom:25px; right:25px;
  background:#fff; color:#222;
  padding:16px; border-radius:12px;
  box-shadow:0 8px 24px rgba(0,0,0,.3);
  font-size:1em; font-weight:700;
  display:none; width:320px; max-width:calc(100vw - 50px);
  animation:slide .4s ease; border-left:4px solid #667eea;
  z-index:99999;
}

#bubble.active{
  display:flex;
  align-items:flex-start;
  gap:12px;
}

#bubble-icon{
  font-size:1.6em;
  min-width:28px;
  text-align:center;
  margin-top:2px;
}

#bubble-content{
  flex:1;
  line-height:1.5;
}

#bubble-close{
  background:none;
  border:none;
  font-size:1.4em;
  color:#999;
  cursor:pointer;
  padding:0;
  min-width:28px;
  text-align:center;
  transition:all 0.3s;
  opacity:0.6;
}

#bubble-close:hover{
  opacity:1;
  color:#667eea;
}

@keyframes slide{
  from{transform:translateY(20px);opacity:0;}
  to{transform:translateY(0);opacity:1;}
}

.sig{text-align:left; margin-top:25px; color:#999; font-style:italic; font-size:0.85em;}

@media(max-width:600px){
  .container{ padding:20px; }
  h2{ font-size:1.6em; }
  .radio-group{ grid-template-columns:1fr; }
  .candidate-list{ max-height:400px; }
}
</style>
</head>

<body>

<div id="bubble">
  <div id="bubble-icon">üí¨</div>
  <div id="bubble-content"></div>
  <button id="bubble-close" onclick="closeBubble()">√ó</button>
</div>

<div class="container" id="main-container">
  <h2 id="welcome-title">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ™ÿµŸàŸäÿ™ - ÿßŸÑÿπÿ≤Ÿäÿ≤ÿ©</h2>
  <div class="committee-info">
    <div class="committee-name" id="committee-name-display"></div>
    <div class="committee-address" id="committee-address-display"></div>
  </div>

  <form id="vote-form">
    <label>ÿßÿ≥ŸÖ ÿßŸÑŸÜÿßÿÆÿ®:</label>
    <input type="text" id="voter-name" placeholder="ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑŸÜÿßÿÆÿ® (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)">

    <label>ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ±ÿ¥ÿ≠ (ÿ≠ÿ™Ÿâ 2):</label>
    <div class="candidate-list" id="candidate-list"></div>

    <div class="sec-box">
      <span class="sec-title">ÿ≠ÿßŸÑÿ© ÿßŸÑÿµŸàÿ™:</span>
      <div class="radio-group">
        <label class="radio-item">
          <input type="radio" name="vvalid" value="ÿµÿ≠Ÿäÿ≠">
          <span>‚úì ÿµÿ≠Ÿäÿ≠</span>
        </label>
        <label class="radio-item">
          <input type="radio" name="vvalid" value="ÿ®ÿßÿ∑ŸÑ">
          <span>‚úó ÿ®ÿßÿ∑ŸÑ</span>
        </label>
      </div>
    </div>

    <div class="btn-row">
      <button type="submit" class="btn-primary">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ™ÿµŸàŸäÿ™</button>
      <button type="reset" class="btn-reset">ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑</button>
      <button type="button" class="btn-logout" onclick="logout()">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</button>
    </div>

    <div id="msg-warn" class="msg-warn"></div>
    <div id="msg-confirm" class="msg-confirm"></div>
  </form>

  <div class="sig">
    ÿ™ŸÖ ÿßŸÑÿ®ÿ±ŸÖÿ¨ÿ© ÿ®Ÿàÿßÿ≥ÿ∑ÿ© 
    <a href="https://www.facebook.com/en.mohamed.nasr" target="_blank" 
       style="color:#1e3c72; font-weight:900; text-decoration:underline;">
       ÿßŸÑŸÖŸáŸÜÿØÿ≥ ŸÖÿ≠ŸÖÿØ ÿ≠ŸÖÿßÿØ
    </a>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging.js";

// ÿ™ŸáŸäÿ¶ÿ© Firebase ŸÑŸÑÿ£ÿ≠ŸÖÿØŸäÿ© (ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™)
const firebaseConfig = {
  apiKey: "AIzaSyBmgHAmoZKm2RRXg42KWdQHD4e5hAUtBbc",
  authDomain: "azizaonly-2ab60.firebaseapp.com",
  databaseURL: "https://azizaonly-2ab60-default-rtdb.firebaseio.com",
  projectId: "azizaonly-2ab60",
  storageBucket: "azizaonly-2ab60.firebasestorage.app",
  messagingSenderId: "447237336190",
  appId: "1:447237336190:web:eab8a2b524b0dcdd5a3c2f",
  measurementId: "G-3DYLFJC5YH"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const messaging = getMessaging(app);

// VAPID Key ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ (Ÿäÿ¨ÿ® ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸäŸá ŸÖŸÜ Firebase Console)
const VAPID_KEY = "BBc4i5tl6yb0Z584Vb5J4n-zHzSEMRZzW-Bh63PFkyJ5nkjx4-3qb3c_gn4BpwnN1ewUD47tx5UWedR06ulmW_o";

let committeeNumber = 0;
let committeeName = "";
let closedNotifications = new Set();

// ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÜŸàÿπ ÿßŸÑŸÑÿ¨ŸÜÿ© ŸÖŸÜ URL
const urlParams = new URLSearchParams(window.location.search);
const committeeType = urlParams.get('type');

// ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑŸàÿµŸàŸÑ
if(!committeeType || (committeeType !== 'women' && committeeType !== 'men')){
  window.location.href = 'index.html';
}

// ÿ™ÿ≠ÿØŸäÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿ¨ŸÜÿ©
if(committeeType === 'women'){
  committeeNumber = 24;
  committeeName = "ŸÖÿ¨ŸÖÿπ ÿßŸÑÿπÿ≤Ÿäÿ≤ÿ© ŸÑÿ¨ŸÜÿ© ÿßŸÑŸÜÿ≥ÿßÿ°";
} else {
  committeeNumber = 25;
  committeeName = "ŸÖÿ¨ŸÖÿπ ÿßŸÑÿπÿ≤Ÿäÿ≤ÿ© ŸÑÿ¨ŸÜÿ© ÿßŸÑÿ±ÿ¨ÿßŸÑ";
}

document.getElementById("welcome-title").textContent = "ÿßŸÑŸÑÿ¨ŸÜÿ© " + committeeNumber;
document.getElementById("committee-name-display").textContent = committeeName;
document.getElementById("committee-address-display").textContent = "ŸÖÿØÿ±ÿ≥ÿ© ŸÖÿ¨ŸÖÿπ ÿßŸÑÿπÿ≤Ÿäÿ≤ÿ© ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿäÿ©";

// ÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ Ÿàÿ™ÿ≥ÿ¨ŸäŸÑ FCM Token
async function requestNotificationPermission() {
  try {
    const permission = await Notification.requestPermission();
    
    if (permission === 'granted') {
      console.log('ÿ™ŸÖ ŸÖŸÜÿ≠ ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');
      
      // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ FCM Token
      const currentToken = await getToken(messaging, { vapidKey: VAPID_KEY });
      
      if (currentToken) {
        console.log('FCM Token:', currentToken);
        // ŸäŸÖŸÉŸÜŸÉ ÿ≠ŸÅÿ∏ ÿßŸÑŸÄ Token ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖÿÆÿµÿµÿ©
        saveTokenToDatabase(currentToken);
      } else {
        console.log('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ Token');
      }
    } else {
      console.log('ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');
    }
  } catch (error) {
    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™:', error);
  }
}

// ÿ≠ŸÅÿ∏ Token ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
function saveTokenToDatabase(token) {
  const tokenRef = ref(db, `fcm_tokens/${committeeNumber}/${Date.now()}`);
  set(tokenRef, {
    token: token,
    committee: committeeNumber,
    timestamp: Date.now()
  }).catch(err => console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ Token:', err));
}

// ÿßÿ≥ÿ™ŸÇÿ®ÿßŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
onMessage(messaging, (payload) => {
  console.log('ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿ±ÿ≥ÿßŸÑÿ©:', payload);
  
  const notificationTitle = payload.notification?.title || 'ÿ•ÿ¥ÿπÿßÿ± ÿ¨ÿØŸäÿØ';
  const notificationBody = payload.notification?.body || 'ŸÑÿØŸäŸÉ ÿ•ÿ¥ÿπÿßÿ± ÿ¨ÿØŸäÿØ';
  
  showFloatingNotification(notificationBody, notificationTitle);
});

// ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ∫ŸÑŸÇÿ© ŸÖŸÜ localStorage
function loadClosedNotifications() {
  const stored = localStorage.getItem("closedNotifications_aziza");
  if (stored) {
    try {
      closedNotifications = new Set(JSON.parse(stored));
    } catch (e) {
      console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™:", e);
      closedNotifications = new Set();
    }
  }
}

function saveClosedNotifications() {
  try {
    localStorage.setItem(
      "closedNotifications_aziza",
      JSON.stringify(Array.from(closedNotifications))
    );
  } catch (e) {
    console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™:", e);
  }
}

loadClosedNotifications();

// ÿ•ÿπÿØÿßÿØ ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
function setupNotificationListeners(committee){
  try {
    const allNotificationsRef = ref(db, "notifications/all");
    let lastAllTimestamp = 0;
    
    onValue(allNotificationsRef, (snapshot) => {
      const data = snapshot.val();
      if(data && typeof data === 'object'){
        Object.entries(data).forEach(([key, notif]) => {
          if(notif && notif.message && notif.timestamp && notif.timestamp > lastAllTimestamp){
            lastAllTimestamp = notif.timestamp;
            showFloatingNotification(notif.message, "üì¢ ÿ•ÿ¥ÿπÿßÿ± ÿπÿßŸÖ");
          }
        });
      }
    }, (error) => {
      console.log("ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©...");
    });

    if(committee > 0){
      const committeeNotificationsRef = ref(db, `notifications/committee_${committee}`);
      let lastCommitteeTimestamp = 0;
      
      onValue(committeeNotificationsRef, (snapshot) => {
        const data = snapshot.val();
        if(data && typeof data === 'object'){
          Object.entries(data).forEach(([key, notif]) => {
            if(notif && notif.message && notif.timestamp && notif.timestamp > lastCommitteeTimestamp){
              lastCommitteeTimestamp = notif.timestamp;
              showFloatingNotification(notif.message, "üì© ÿ•ÿ¥ÿπÿßÿ± ŸÑÿ¨ŸÜÿ™ŸÉ");
            }
          });
        }
      }, (error) => {
        console.log("ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÑÿ¨ŸÜÿ©...");
      });
    }
  } catch(e) {
    console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿπÿØÿßÿØ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπŸäŸÜ:", e);
  }
}

function showFloatingNotification(msg, type){
  const bubble = document.getElementById("bubble");
  const content = document.getElementById("bubble-content");
  const icon = document.getElementById("bubble-icon");
  
  const notificationId = type + "_" + Date.now();
  bubble.dataset.notificationId = notificationId;
  
  if(closedNotifications.has(notificationId)){
    return;
  }
  
  content.textContent = msg;
  
  if(type.includes("ÿπÿßŸÖ") || type.includes("üì¢")){
    bubble.style.borderLeft = "4px solid #667eea";
    icon.textContent = "üì¢";
  } else if(type.includes("ŸÑÿ¨ŸÜÿ™ŸÉ") || type.includes("üì©")){
    bubble.style.borderLeft = "4px solid #11998e";
    icon.textContent = "üì©";
  } else {
    bubble.style.borderLeft = "4px solid #ffcc00";
    icon.textContent = "üí¨";
  }
  
  bubble.classList.add("active");
  
  // ÿ•ÿ∫ŸÑÿßŸÇ ÿ™ŸÑŸÇÿßÿ¶Ÿä ÿ®ÿπÿØ 10 ÿ´ŸàÿßŸÜŸä
  setTimeout(() => {
    if(bubble.classList.contains("active")){
      closeBubble();
    }
  }, 10000);
}

window.closeBubble = function(){
  const bubble = document.getElementById("bubble");
  const notificationId = bubble.dataset.notificationId;
  
  if(notificationId){
    closedNotifications.add(notificationId);
    saveClosedNotifications();
  }
  
  bubble.classList.remove("active");
};

window.logout = function(){
  window.location.href = 'index.html';
};

// ÿ®ÿØÿ° ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
setupNotificationListeners(committeeNumber);

// ÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
requestNotificationPermission();

const candidates = [
  ["1","ÿßŸäŸáÿßÿ® ÿßŸÑÿπŸÖÿØŸá","üëë"],
  ["2","ŸÖÿ≠ŸÖÿØ ÿßŸÑÿπÿ™ŸÖÿßŸÜŸâ","üçû"],
  ["3","ÿ£ÿ≠ŸÖÿØ ÿßŸÑÿ≠ÿØŸäÿØŸâ","ü¶Å"],
  ["4","ÿπÿßÿØŸÑ ÿßŸÑÿ¨Ÿäÿßÿ±","ü¶Ö"],
  ["5","ÿßÿ≠ŸÖÿØ ŸÖÿ≠ŸÖÿØ ŸÖÿ≠ŸÖÿØ ÿ≥ŸÖÿ±Ÿá","üí£"],
  ["6","ŸàŸÑŸäÿØ ÿ™Ÿäÿ≥Ÿäÿ± ÿßŸÑÿßŸÖŸäÿ±","üêä"],
  ["7","ŸÉŸÖÿßŸÑ ÿßŸÑÿπŸäÿ≥ŸàŸâ","üåÄ"],
  ["8","ÿßŸÑÿ®ÿØŸàŸâ ÿ¨ŸÖŸäÿ≤","üêã"],
  ["9","ÿßÿ≠ŸÖÿØ ÿßŸÑÿ±Ÿäÿ≥","ü¶Ç"],
  ["10","ÿ£ÿ≠ŸÖÿØ ÿπŸàŸÅ","‚úã"],
  ["11","ÿ≠ÿ≥ŸÜ ÿßŸÑŸÖŸÑŸáÿßÿ∑","üåø"],
  ["12","ÿπŸÖÿ±Ÿà ŸÖÿ≠ŸÖÿØ ÿ®ÿ≠Ÿäÿ±Ÿâ","üöå"],
  ["13","ÿßŸÑÿ≥ŸäÿØ ÿ∑ŸÖÿßŸÜ","üî´"],
  ["14","ŸÖÿ≠ŸÖÿØ ÿØŸÜÿØŸÜ","üöÅ"],
  ["15","ŸÖÿ¨ÿØŸâ ÿßŸÑÿ£ŸÖŸäÿ±","üñä"]
];

const listBox = document.getElementById("candidate-list");
candidates.forEach((c, idx) => {
  const item = document.createElement("div");
  item.className = "candidate-item";

  const checkbox = document.createElement("input");
  checkbox.type = "checkbox";
  checkbox.value = c[1];
  checkbox.className = "candidate-checkbox";

  item.innerHTML = `<div class="c-left"><div class="num-circle">${c[0]}</div><div class="c-name">${c[1]}</div></div><div class="c-right"><span class="c-icon">${c[2]}</span></div>`;
  item.appendChild(checkbox);

  item.addEventListener("click", (e) => {
    if(e.target !== checkbox) checkbox.checked = !checkbox.checked;
    checkLimit();
    updateStyle();
  });

  checkbox.addEventListener("change", () => {
    checkLimit();
    updateStyle();
  });

  listBox.appendChild(item);
});

function updateStyle(){
  document.querySelectorAll(".candidate-item").forEach((item) => {
    if(item.querySelector("input[type='checkbox']").checked) 
      item.classList.add("selected");
    else 
      item.classList.remove("selected");
  });
}

function checkLimit(){
  const sel = document.querySelectorAll('.candidate-checkbox:checked');
  if(sel.length > 2){
    sel[sel.length - 1].checked = false;
    showWarn("ŸäŸÖŸÉŸÜ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖÿ±ÿ¥ÿ≠ŸäŸÜ ŸÅŸÇÿ∑");
    updateStyle();
  }
}

function showWarn(msg){
  const el = document.getElementById("msg-warn");
  el.textContent = msg;
  el.style.display = "block";
  setTimeout(() => el.style.display = "none", 2500);
}

function showConfirm(msg){
  const el = document.getElementById("msg-confirm");
  el.textContent = msg;
  el.style.display = "block";
  setTimeout(() => el.style.display = "none", 3000);
}

document.querySelectorAll("input[type='radio']").forEach(radio => {
  radio.addEventListener("change", function(){
    document.querySelectorAll(".radio-item").forEach(item => item.classList.remove("selected"));
    this.closest(".radio-item").classList.add("selected");
  });
});

document.getElementById("vote-form").addEventListener("submit", function(e){
  e.preventDefault();

  let name = document.getElementById("voter-name").value.trim();
  if(!name) name = "ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ";

  const sel = Array.from(document.querySelectorAll('.candidate-checkbox:checked')).map(v => v.value);
  const val = document.querySelector('input[name="vvalid"]:checked');

  if(sel.length < 1) return showWarn("ÿßÿÆÿ™ÿ± ŸÖÿ±ÿ¥ÿ≠ Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ");
  if(!val) return showWarn("ÿßÿÆÿ™ÿ± ÿ≠ÿßŸÑÿ© ÿßŸÑÿµŸàÿ™");

  const voteKey = Date.now();
  const votePath = `votes/aziza/${voteKey}`;
  const voteRef = ref(db, votePath);
  
  set(voteRef, {
    name: name,
    selected: sel,
    vote_validity: val.value,
    committee: committeeNumber,
    timestamp: voteKey
  }).then(() => {
    showConfirm("‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!");
    document.getElementById("vote-form").reset();
    updateStyle();
    document.querySelectorAll(".radio-item").forEach(item => item.classList.remove("selected"));
  }).catch(err => {
    showWarn("‚ùå ÿÆÿ∑ÿ£: " + err.message);
  });
});
</script>

</body>
</html>
