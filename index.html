<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµÙˆÙŠØª - Ø§Ù„Ø¹Ø²ÙŠØ²Ø©</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
    /* --- Reset & Base Styles --- */
    * { 
        margin: 0; padding: 0; box-sizing: border-box; 
        font-family: "Cairo", sans-serif; 
        -webkit-tap-highlight-color: transparent; /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙˆÙ…ÙŠØ¶ Ø§Ù„Ø£Ø²Ø±Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù„Ù…Ø³ */
    }

    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 15px;
        color: #333;
    }

    .hidden { display: none !important; }

    /* --- Main Container --- */
    .container {
        width: 100%;
        max-width: 800px;
        background: #fff;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, .3);
        animation: fade .5s ease;
        margin: auto;
    }

    @keyframes fade {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* --- Headers --- */
    h2 {
        text-align: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-size: 2em;
        font-weight: 900;
        margin-bottom: 10px;
    }

    .committee-info {
        text-align: center;
        margin-bottom: 20px;
        background: #f5f7ff;
        padding: 15px;
        border-radius: 12px;
        border-right: 4px solid #667eea; /* Ø¬Ø¹Ù„ Ø§Ù„Ø®Ø· ÙŠÙ…ÙŠÙ† Ù„Ø£Ù†Ù‡ Ø¹Ø±Ø¨ÙŠ */
    }

    .committee-name {
        font-size: 1.1em;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 5px;
    }

    .committee-address {
        font-size: 0.9em;
        color: #666;
        font-weight: 500;
    }

    /* --- Form Elements --- */
    label {
        font-weight: 700;
        color: #333;
        margin-top: 15px;
        margin-bottom: 8px;
        display: block;
        font-size: 1rem;
    }

    input[type=text] {
        width: 100%;
        padding: 12px 15px;
        border-radius: 12px;
        border: 2px solid #e0e7ff;
        background: #f8f9ff;
        font-size: 1rem;
        transition: all 0.3s;
    }

    input[type=text]:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    /* --- Candidate List --- */
    .candidate-list {
        margin-top: 10px;
        background: #f8f9ff;
        border: 2px solid #e0e7ff;
        border-radius: 14px;
        max-height: 50vh; /* Ø§Ø±ØªÙØ§Ø¹ Ù…Ø±Ù† */
        overflow-y: auto;
        padding: 10px;
        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        scrollbar-width: thin;
        scrollbar-color: #667eea #f8f9ff;
    }

    .candidate-list::-webkit-scrollbar { width: 6px; }
    .candidate-list::-webkit-scrollbar-thumb { background-color: #667eea; border-radius: 10px; }

    .candidate-item {
        background: #fff;
        border: 1px solid #e8ecff;
        padding: 12px;
        border-radius: 12px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
        cursor: pointer;
        border-right: 4px solid transparent; /* Ù…ÙƒØ§Ù† Ù„Ù„Ø¨ÙˆØ±Ø¯Ø± */
        user-select: none;
    }

    .candidate-item:hover {
        background: #f0f4ff;
        border-color: #667eea;
    }

    .candidate-item.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        border-color: #764ba2;
        transform: scale(0.99);
    }

    .c-left {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
    }

    .num-circle {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #e0e7ff;
        color: #667eea;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9em;
        font-weight: 900;
        flex-shrink: 0;
    }

    .candidate-item.selected .num-circle {
        background: #fff;
        color: #667eea;
    }

    .c-name {
        font-weight: 700;
        font-size: 0.95rem;
        line-height: 1.4;
    }

    .c-right {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .c-icon { font-size: 1.5em; }

    input[type="checkbox"] {
        width: 22px;
        height: 22px;
        cursor: pointer;
        accent-color: #fff; /* Ù„ÙˆÙ† Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØµØ­ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø±Ø¨Ø¹ */
    }
    
    /* ØªØ¹Ø¯ÙŠÙ„ Ù„ÙˆÙ† Ø§Ù„Ø´ÙŠÙƒ Ø¨ÙˆÙƒØ³ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ */
    .candidate-item:not(.selected) input[type="checkbox"] {
        accent-color: #667eea;
    }

    /* --- Section Box (Status) --- */
    .sec-box {
        margin-top: 20px;
        background: #f5f7ff;
        border: 2px solid #e0e7ff;
        border-radius: 12px;
        padding: 15px;
    }

    .sec-title {
        font-weight: 700;
        color: #667eea;
        display: block;
        margin-bottom: 10px;
        font-size: 1rem;
    }

    .radio-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .radio-item {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        cursor: pointer;
        padding: 12px;
        background: #fff;
        border-radius: 10px;
        border: 2px solid #e0e7ff;
        transition: all 0.3s;
        font-weight: 700;
    }

    .radio-item:hover { border-color: #667eea; background: #fff; }
    
    .radio-item.selected {
        background: #667eea;
        color: #fff;
        border-color: #667eea;
    }

    .radio-item input[type="radio"] {
        width: 18px;
        height: 18px;
        accent-color: #fff; 
        display: none; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø§Ø¯ÙŠÙˆ ÙˆØ§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø´ÙƒÙ„ Ø§Ù„Ø²Ø± */
    }
    
    /* Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ø¦Ø±Ø© ÙˆÙ‡Ù…ÙŠØ© Ù„Ù„Ø±Ø§Ø¯ÙŠÙˆ */
    .radio-item::before {
        content: '';
        width: 18px;
        height: 18px;
        border: 2px solid #ddd;
        border-radius: 50%;
        background: #fff;
        display: inline-block;
    }
    .radio-item.selected::before {
        border-color: #fff;
        background: radial-gradient(circle, #667eea 40%, #fff 45%);
    }


    /* --- Buttons --- */
    .btn-row {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    button {
        padding: 14px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1rem;
        transition: transform 0.2s;
        flex: 1;
        min-width: 120px; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    }

    button:active { transform: scale(0.97); }

    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; flex: 2; }
    .btn-reset { background: #e0e7ff; color: #667eea; }
    .btn-logout { background: #ffebee; color: #c62828; }

    /* --- Messages --- */
    .msg-warn, .msg-confirm {
        display: none;
        margin-top: 15px;
        padding: 12px;
        border-radius: 10px;
        text-align: center;
        font-weight: 700;
        animation: slideDown 0.3s ease;
    }
    
    .msg-warn { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
    .msg-confirm { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* --- Notification Bubble --- */
    #bubble {
        position: fixed;
        bottom: 20px; 
        right: 20px;
        background: #fff;
        color: #222;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        font-size: 0.95em;
        font-weight: 700;
        display: none;
        width: 300px;
        max-width: 90%;
        animation: slideUp .4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border-right: 4px solid #667eea; /* Ø¹Ø±Ø¨ÙŠ: ÙŠÙ…ÙŠÙ† */
        z-index: 9999;
        align-items: flex-start;
        gap: 12px;
    }
    
    #bubble.active { display: flex; }

    #bubble-icon { font-size: 1.5em; }
    #bubble-content { flex: 1; line-height: 1.5; }
    #bubble-close {
        background: transparent; color: #999;
        font-size: 1.5em; padding: 0; margin: 0;
        min-width: auto; width: auto; flex: 0;
    }

    @keyframes slideUp {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    /* --- Footer --- */
    .sig {
        text-align: center;
        margin-top: 25px;
        color: #888;
        font-size: 0.8em;
    }
    .sig a { text-decoration: none; }

    /* --- Responsive Design --- */
    @media (max-width: 600px) {
        body { padding: 10px; align-items: flex-start; } /* Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ */
        .container { 
            padding: 20px; 
            border-radius: 15px;
            margin-top: 10px;
            margin-bottom: 60px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„ÙÙ‚Ø§Ø¹Ø© */
        }
        
        h2 { font-size: 1.5em; }
        
        .candidate-list { max-height: 45vh; }
        
        .btn-row { flex-direction: column; }
        .btn-primary { order: 1; width: 100%; }
        .btn-reset { order: 2; }
        .btn-logout { order: 3; }

        /* Ø±ÙØ¹ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© ÙÙˆÙ‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        #bubble { bottom: 10px; left: 10px; right: 10px; width: auto; }
    }
</style>
</head>

<body>

<div id="bubble">
  <div id="bubble-icon">ğŸ’¬</div>
  <div id="bubble-content"></div>
  <button id="bubble-close" onclick="closeBubble()">Ã—</button>
</div>

<div class="container" id="main-container">
  <h2 id="welcome-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµÙˆÙŠØª - Ø§Ù„Ø¹Ø²ÙŠØ²Ø©</h2>
  
  <div class="committee-info">
    <div class="committee-name" id="committee-name-display">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <div class="committee-address" id="committee-address-display">Ù…Ø¯Ø±Ø³Ø© Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ø²ÙŠØ²Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©</div>
  </div>

  <form id="vote-form">
    <label for="voter-name">Ø§Ø³Ù… Ø§Ù„Ù†Ø§Ø®Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
    <input type="text" id="voter-name" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§..." autocomplete="off">

    <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø´Ø­ (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 2):</label>
    <div class="candidate-list" id="candidate-list"></div>

    <div class="sec-box">
      <span class="sec-title">Ø­Ø§Ù„Ø© Ø§Ù„ØµÙˆØª:</span>
      <div class="radio-group">
        <label class="radio-item">
          <input type="radio" name="vvalid" value="ØµØ­ÙŠØ­">
          <span>âœ“ ØµØ­ÙŠØ­</span>
        </label>
        <label class="radio-item">
          <input type="radio" name="vvalid" value="Ø¨Ø§Ø·Ù„">
          <span>âœ— Ø¨Ø§Ø·Ù„</span>
        </label>
      </div>
    </div>

    <div class="btn-row">
      <button type="submit" class="btn-primary">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµÙˆÙŠØª</button>
      <button type="reset" class="btn-reset">ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
      <button type="button" class="btn-logout" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="msg-warn" class="msg-warn"></div>
    <div id="msg-confirm" class="msg-confirm"></div>
  </form>

  <div class="sig">
    ØªÙ… Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© Ø¨ÙˆØ§Ø³Ø·Ø© 
    <a href="https://www.facebook.com/en.mohamed.nasr" target="_blank" 
       style="color:#667eea; font-weight:900;">
       Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯
    </a>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging.js";

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (ÙƒÙ…Ø§ Ù‡ÙŠ)
const firebaseConfig = {
  apiKey: "AIzaSyBmgHAmoZKm2RRXg42KWdQHD4e5hAUtBbc",
  authDomain: "azizaonly-2ab60.firebaseapp.com",
  databaseURL: "https://azizaonly-2ab60-default-rtdb.firebaseio.com",
  projectId: "azizaonly-2ab60",
  storageBucket: "azizaonly-2ab60.firebasestorage.app",
  messagingSenderId: "447237336190",
  appId: "1:447237336190:web:eab8a2b524b0dcdd5a3c2f",
  measurementId: "G-3DYLFJC5YH"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const messaging = getMessaging(app);
const VAPID_KEY = "BBc4i5tl6yb0Z584Vb5J4n-zHzSEMRZzW-Bh63PFkyJ5nkjx4-3qb3c_gn4BpwnN1ewUD47tx5UWedR06ulmW_o";

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¬Ù†Ø©
let committeeNumber = 0;
let committeeName = "";
let closedNotifications = new Set();

// ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù„Ø¬Ù†Ø© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
const urlParams = new URLSearchParams(window.location.search);
const committeeType = urlParams.get('type');

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
if(!committeeType || (committeeType !== 'women' && committeeType !== 'men')){
  window.location.href = 'index.html';
}

if(committeeType === 'women'){
  committeeNumber = 24;
  committeeName = "Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ø²ÙŠØ²Ø© - Ù„Ø¬Ù†Ø© Ø§Ù„Ù†Ø³Ø§Ø¡";
} else {
  committeeNumber = 25;
  committeeName = "Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ø²ÙŠØ²Ø© - Ù„Ø¬Ù†Ø© Ø§Ù„Ø±Ø¬Ø§Ù„";
}

// ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
document.getElementById("welcome-title").textContent = "Ø§Ù„Ù„Ø¬Ù†Ø© Ø±Ù‚Ù… " + committeeNumber;
document.getElementById("committee-name-display").textContent = committeeName;

// --- Notification Logic ---
async function requestNotificationPermission() {
  try {
    const permission = await Notification.requestPermission();
    if (permission === 'granted') {
      const currentToken = await getToken(messaging, { vapidKey: VAPID_KEY });
      if (currentToken) {
        saveTokenToDatabase(currentToken);
      }
    }
  } catch (error) {
    console.error('Error requesting permission:', error);
  }
}

function saveTokenToDatabase(token) {
  const tokenRef = ref(db, `fcm_tokens/${committeeNumber}/${Date.now()}`);
  set(tokenRef, {
    token: token,
    committee: committeeNumber,
    timestamp: Date.now()
  }).catch(err => console.error(err));
}

onMessage(messaging, (payload) => {
  const title = payload.notification?.title || 'Ø¥Ø´Ø¹Ø§Ø±';
  const body = payload.notification?.body || 'Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©';
  showFloatingNotification(body, title);
});

function loadClosedNotifications() {
  const stored = localStorage.getItem("closedNotifications_aziza");
  if (stored) {
    try { closedNotifications = new Set(JSON.parse(stored)); } 
    catch (e) { closedNotifications = new Set(); }
  }
}
function saveClosedNotifications() {
  localStorage.setItem("closedNotifications_aziza", JSON.stringify(Array.from(closedNotifications)));
}
loadClosedNotifications();

function setupNotificationListeners(committee){
  try {
    const allNotificationsRef = ref(db, "notifications/all");
    let lastAllTimestamp = 0;
    onValue(allNotificationsRef, (snapshot) => {
      const data = snapshot.val();
      if(data){
        Object.entries(data).forEach(([key, notif]) => {
          if(notif && notif.message && notif.timestamp > lastAllTimestamp){
            lastAllTimestamp = notif.timestamp;
            showFloatingNotification(notif.message, "ğŸ“¢ Ø¹Ø§Ù…");
          }
        });
      }
    });

    if(committee > 0){
      const commRef = ref(db, `notifications/committee_${committee}`);
      let lastCommTimestamp = 0;
      onValue(commRef, (snapshot) => {
        const data = snapshot.val();
        if(data){
          Object.entries(data).forEach(([key, notif]) => {
            if(notif && notif.message && notif.timestamp > lastCommTimestamp){
              lastCommTimestamp = notif.timestamp;
              showFloatingNotification(notif.message, "ğŸ“© Ù„Ø¬Ù†ØªÙƒ");
            }
          });
        }
      });
    }
  } catch(e) { console.error(e); }
}

function showFloatingNotification(msg, type){
  const bubble = document.getElementById("bubble");
  const content = document.getElementById("bubble-content");
  const icon = document.getElementById("bubble-icon");
  
  const notificationId = type + "_" + msg.substring(0, 10) + "_" + Date.now(); // Unique ID approximation
  bubble.dataset.notificationId = notificationId;
  
  // Ù„Ø§ ØªØ¸Ù‡Ø± Ø¥Ø°Ø§ ØªÙ… Ø¥ØºÙ„Ø§Ù‚Ù‡Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹ (ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ø±Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ù„Ø¥Ø´Ø¹Ø§Ø± ID Ø«Ø§Ø¨Øª)
  // Ø­Ø§Ù„ÙŠØ§Ù‹ Ø³Ù†Ø¸Ù‡Ø± ÙƒÙ„ Ø¬Ø¯ÙŠØ¯

  content.textContent = msg;
  
  if(type.includes("Ø¹Ø§Ù…") || type.includes("ğŸ“¢")){
    bubble.style.borderRight = "4px solid #667eea";
    icon.textContent = "ğŸ“¢";
  } else if(type.includes("Ù„Ø¬Ù†ØªÙƒ") || type.includes("ğŸ“©")){
    bubble.style.borderRight = "4px solid #11998e";
    icon.textContent = "ğŸ“©";
  } else {
    bubble.style.borderRight = "4px solid #ffcc00";
    icon.textContent = "ğŸ’¬";
  }
  
  bubble.classList.add("active");
  setTimeout(() => { if(bubble.classList.contains("active")) closeBubble(); }, 10000);
}

window.closeBubble = function(){
  const bubble = document.getElementById("bubble");
  bubble.classList.remove("active");
};

window.logout = function(){
  window.location.href = 'index.html';
};

setupNotificationListeners(committeeNumber);
requestNotificationPermission();

// --- Candidates List ---
const candidates = [
  ["1","Ø§ÙŠÙ‡Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø¯Ù‡","ğŸ‘‘"],
  ["2","Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹ØªÙ…Ø§Ù†Ù‰","ğŸ"],
  ["3","Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯Ù‰","ğŸ¦"],
  ["4","Ø¹Ø§Ø¯Ù„ Ø§Ù„Ø¬ÙŠØ§Ø±","ğŸ¦…"],
  ["5","Ø§Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø³Ù…Ø±Ù‡","ğŸ’£"],
  ["6","ÙˆÙ„ÙŠØ¯ ØªÙŠØ³ÙŠØ± Ø§Ù„Ø§Ù…ÙŠØ±","ğŸŠ"],
  ["7","ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹ÙŠØ³ÙˆÙ‰","ğŸŒ€"],
  ["8","Ø§Ù„Ø¨Ø¯ÙˆÙ‰ Ø¬Ù…ÙŠØ²","ğŸ‹"],
  ["9","Ø§Ø­Ù…Ø¯ Ø§Ù„Ø±ÙŠØ³","ğŸ¦‚"],
  ["10","Ø£Ø­Ù…Ø¯ Ø¹ÙˆÙ","âœ‹"],
  ["11","Ø­Ø³Ù† Ø§Ù„Ù…Ù„Ù‡Ø§Ø·","ğŸŒ¿"],
  ["12","Ø¹Ù…Ø±Ùˆ Ù…Ø­Ù…Ø¯ Ø¨Ø­ÙŠØ±Ù‰","ğŸšŒ"],
  ["13","Ø§Ù„Ø³ÙŠØ¯ Ø·Ù…Ø§Ù†","ğŸ”«"],
  ["14","Ù…Ø­Ù…Ø¯ Ø¯Ù†Ø¯Ù†","ğŸš"],
  ["15","Ù…Ø¬Ø¯Ù‰ Ø§Ù„Ø£Ù…ÙŠØ±","ğŸ–Š"]
];

const listBox = document.getElementById("candidate-list");

candidates.forEach((c) => {
  const item = document.createElement("div");
  item.className = "candidate-item";
  
  // Checkbox Element
  const checkbox = document.createElement("input");
  checkbox.type = "checkbox";
  checkbox.value = c[1];
  checkbox.className = "candidate-checkbox";

  // HTML Structure
  item.innerHTML = `
    <div class="c-left">
        <div class="num-circle">${c[0]}</div>
        <div class="c-name">${c[1]}</div>
    </div>
    <div class="c-right">
        <span class="c-icon">${c[2]}</span>
    </div>
  `;
  
  // Append checkbox to right side
  item.querySelector('.c-right').appendChild(checkbox);

  // Event Listener for the whole row
  item.addEventListener("click", (e) => {
    // Prevent double toggle if clicking directly on checkbox
    if (e.target !== checkbox) {
        checkbox.checked = !checkbox.checked;
    }
    checkLimitAndStyle();
  });

  // Listener for direct checkbox interaction
  checkbox.addEventListener("change", checkLimitAndStyle);

  listBox.appendChild(item);
});

function checkLimitAndStyle() {
    const checkboxes = document.querySelectorAll('.candidate-checkbox');
    const checked = document.querySelectorAll('.candidate-checkbox:checked');

    // Limit Check
    if (checked.length > 2) {
        // Uncheck the one that was just clicked (or the last one found)
        // Since we don't know exactly which one triggered in this scope easily without 'this',
        // we can uncheck the last one in the array which is likely valid logic visually
        // But better UX: uncheck the specific target. 
        // For simplicity: uncheck the last checked one in DOM order or prevent.
        
        // Let's disable the change on the 3rd one
        // But we need to revert.
        
        // Hack: Revert the change immediately inside the event usually, 
        // but here we just find all checked and uncheck the last one.
        // This function runs AFTER change.
        
        // Find which one pushed it over limit? Hard to know without passing event.
        // Use simple logic: Uncheck the last one in the list.
        /* This simple logic might annoy user if they clicked top then bottom. 
           Ideally pass 'this'. But let's just show warning and uncheck last found. */
        
        // Better: Uncheck the one that made it > 2. 
        // We will re-enforce the limit by unchecking the newly added one? 
        // Actually, let's just uncheck the last one in the checked nodelist.
        checked[checked.length - 1].checked = false;
        showWarn("âš ï¸ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±Ø´Ø­ÙŠÙ† Ø§Ø«Ù†ÙŠÙ† ÙÙ‚Ø·");
    }

    // Styling Update
    document.querySelectorAll(".candidate-item").forEach(div => {
        const cb = div.querySelector("input[type='checkbox']");
        if (cb.checked) div.classList.add("selected");
        else div.classList.remove("selected");
    });
}

function showWarn(msg){
  const el = document.getElementById("msg-warn");
  el.textContent = msg;
  el.style.display = "block";
  setTimeout(() => el.style.display = "none", 3000);
}

function showConfirm(msg){
  const el = document.getElementById("msg-confirm");
  el.textContent = msg;
  el.style.display = "block";
  setTimeout(() => el.style.display = "none", 3000);
}

// Radio Button Styling Logic
document.querySelectorAll("input[name='vvalid']").forEach(radio => {
    radio.addEventListener("change", function() {
        document.querySelectorAll(".radio-item").forEach(item => item.classList.remove("selected"));
        if(this.checked) {
            this.closest(".radio-item").classList.add("selected");
        }
    });
});

// Reset Button Logic
document.querySelector("button[type='reset']").addEventListener("click", function(){
    setTimeout(() => {
        document.querySelectorAll(".candidate-item").forEach(i => i.classList.remove("selected"));
        document.querySelectorAll(".radio-item").forEach(i => i.classList.remove("selected"));
    }, 10);
});

// Form Submission
document.getElementById("vote-form").addEventListener("submit", function(e){
  e.preventDefault();

  let name = document.getElementById("voter-name").value.trim();
  if(!name) name = "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";

  const sel = Array.from(document.querySelectorAll('.candidate-checkbox:checked')).map(v => v.value);
  const valInput = document.querySelector('input[name="vvalid"]:checked');

  if(sel.length < 1) return showWarn("â— ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±Ø´Ø­ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
  if(!valInput) return showWarn("â— ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„ØµÙˆØª (ØµØ­ÙŠØ­/Ø¨Ø§Ø·Ù„)");

  const voteKey = Date.now();
  const votePath = `votes/aziza/${voteKey}`;
  const voteRef = ref(db, votePath);
  
  // Disable button to prevent double submit
  const submitBtn = document.querySelector("button[type='submit']");
  submitBtn.disabled = true;
  submitBtn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

  set(voteRef, {
    name: name,
    selected: sel,
    vote_validity: valInput.value,
    committee: committeeNumber,
    timestamp: voteKey
  }).then(() => {
    showConfirm("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ù†Ø¬Ø§Ø­!");
    document.getElementById("vote-form").reset();
    
    // Reset Styles
    document.querySelectorAll(".candidate-item").forEach(i => i.classList.remove("selected"));
    document.querySelectorAll(".radio-item").forEach(i => i.classList.remove("selected"));
    
  }).catch(err => {
    showWarn("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + err.message);
  }).finally(() => {
    submitBtn.disabled = false;
    submitBtn.textContent = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµÙˆÙŠØª";
  });
});
</script>

</body>
</html>
