<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© - Ø§Ù„Ø¹Ø²ÙŠØ²Ø©</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
    :root {
        --primary: #11998e;
        --secondary: #38ef7d;
        --danger: #eb3349;
        --warning: #f6ad55;
        --info: #63b3ed;
        --dark: #1a202c;
        --light: #f7fafc;
        --card-bg: #ffffff;
        --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Cairo", sans-serif; outline: none; }
    
    body {
        background: #f0f2f5;
        color: var(--dark);
        min-height: 100vh;
        padding-bottom: 50px;
        font-size: 14px;
    }

    /* --- Lock Screen --- */
    #lock-screen {
        position: fixed; inset: 0;
        background: linear-gradient(135deg, var(--primary), var(--dark));
        display: flex; justify-content: center; align-items: center;
        z-index: 10000;
        padding: 20px;
    }

    .lock-box {
        background: rgba(255, 255, 255, 0.95);
        padding: 40px; width: 100%; max-width: 400px;
        border-radius: 24px; text-align: center;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
    }

    .lock-box h2 { color: var(--primary); margin-bottom: 10px; font-size: 1.8rem; }
    .lock-input-group { position: relative; margin: 20px 0; }
    
    .lock-box input {
        width: 100%; padding: 15px; border-radius: 12px;
        border: 2px solid #e2e8f0; font-size: 1.1rem; text-align: center;
        transition: 0.3s;
    }
    .lock-box input:focus { border-color: var(--primary); }
    
    .lock-btn {
        width: 100%; padding: 15px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        color: white; border: none; border-radius: 12px;
        font-size: 1.1rem; font-weight: bold; cursor: pointer;
        transition: transform 0.2s;
    }
    .lock-btn:active { transform: scale(0.98); }

    /* --- Dashboard --- */
    .hidden { display: none !important; }
    .container { max-width: 1400px; margin: auto; padding: 15px; }

    /* Header */
    .header {
        display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
        gap: 15px; margin-bottom: 25px; background: var(--card-bg);
        padding: 20px; border-radius: 16px; box-shadow: var(--shadow);
    }
    .header-title h1 { font-size: 1.5rem; font-weight: 900; background: linear-gradient(90deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .header-badges { display: flex; gap: 10px; align-items: center; }
    
    .badge { padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; display: flex; align-items: center; gap: 6px; }
    .badge-admin { background: #e2e8f0; color: var(--dark); }
    .badge-live { background: #def7ec; color: #03543f; }
    .dot { width: 8px; height: 8px; background: #38ef7d; border-radius: 50%; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

    /* Stats Cards */
    .grid-cards { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 15px; 
        margin-bottom: 30px; 
    }
    .stat-card {
        background: var(--card-bg); padding: 20px; border-radius: 16px;
        box-shadow: var(--shadow); border-bottom: 4px solid var(--primary);
        transition: transform 0.2s;
        display: flex; flex-direction: column; justify-content: space-between;
    }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-title { color: #718096; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; }
    .stat-value { font-size: 1.8rem; font-weight: 800; color: var(--dark); }
    .stat-sub { font-size: 0.75rem; color: #a0aec0; margin-top: 5px; }

    /* Layout Grid */
    .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 30px; }
    
    /* Panels */
    .panel { background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: var(--shadow); height: 100%; display: flex; flex-direction: column; }
    .panel h3 { margin-bottom: 15px; font-size: 1.1rem; color: var(--primary); border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
    canvas { width: 100% !important; height: auto !important; max-height: 300px; }

    /* Committee Actions */
    .comm-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .comm-box {
        padding: 15px; border-radius: 12px; background: #f7fafc; border: 1px solid #e2e8f0;
        cursor: pointer; transition: 0.3s;
    }
    .comm-box:hover { background: var(--primary); color: white; border-color: var(--primary); }
    .comm-box h4 { font-size: 1rem; margin-bottom: 5px; }
    .comm-stats { font-size: 0.8rem; opacity: 0.8; }

    /* Notify Section */
    .notify-area textarea {
        width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px;
        resize: none; height: 80px; margin-bottom: 10px; transition: 0.3s;
    }
    .notify-area textarea:focus { border-color: var(--primary); }
    .notify-options { display: flex; gap: 15px; margin-bottom: 10px; }
    
    /* Table Section */
    .table-controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    .search-box { flex: 1; padding: 10px 15px; border-radius: 10px; border: 1px solid #cbd5e0; min-width: 200px; }
    .btn-action { padding: 10px 15px; border: none; border-radius: 10px; cursor: pointer; color: white; font-weight: bold; font-size: 0.85rem; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
    .btn-blue { background: #4299e1; }
    .btn-green { background: #48bb78; }
    .btn-red { background: #f56565; }
    .btn-action:hover { opacity: 0.9; transform: translateY(-1px); }

    .table-wrap { overflow-x: auto; border-radius: 12px; border: 1px solid #e2e8f0; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; min-width: 650px; }
    thead { background: #f7fafc; }
    th, td { padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; }
    th { color: #4a5568; white-space: nowrap; }
    tr:hover { background: #f8fff9; }
    
    .status-ok { color: var(--primary); font-weight: bold; background: #e6fffa; padding: 4px 8px; border-radius: 6px; white-space: nowrap; font-size: 0.8rem; }
    .status-bad { color: var(--danger); font-weight: bold; background: #fff5f5; padding: 4px 8px; border-radius: 6px; white-space: nowrap; font-size: 0.8rem; }

    /* Ranking List */
    .ranking-item { 
        display: flex; justify-content: space-between; align-items: center; padding: 10px;
        border-bottom: 1px solid #eee; transition: 0.2s;
    }
    .ranking-item:last-child { border-bottom: none; }
    .ranking-item:hover { background: #f9fafb; padding-right: 10px; }
    .rank-bar-bg { flex: 1; height: 8px; background: #edf2f7; margin: 0 15px; border-radius: 4px; overflow: hidden; }
    .rank-bar-fill { height: 100%; background: var(--primary); border-radius: 4px; }

    /* Popups */
    .overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.6);
        display: flex; justify-content: center; align-items: center; z-index: 5000;
        backdrop-filter: blur(4px); padding: 20px;
    }
    .popup {
        background: white; width: 100%; max-width: 500px; border-radius: 16px;
        padding: 25px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        animation: slideUp 0.3s ease; max-height: 90vh; overflow-y: auto;
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .popup-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 1.2rem; font-weight: bold; color: var(--dark); }
    .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #a0aec0; }
    
    /* Edit List */
    .edit-option { display: flex; justify-content: space-between; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
    .edit-option:hover { background: #f7fafc; }
    .edit-option input { width: 20px; height: 20px; accent-color: var(--primary); }

    /* Stats Popup Detail Styles */
    .detail-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
    }
    .detail-box {
        background: #f8fafc; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #edf2f7;
    }
    .detail-val { font-size: 1.4rem; font-weight: 800; color: var(--dark); }
    .detail-lbl { font-size: 0.8rem; color: #718096; margin-top: 5px; }
    .status-indicator {
        padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px; font-weight: bold;
    }
    .is-active { background: #def7ec; color: #03543f; border: 1px solid #38ef7d; }
    .is-inactive { background: #fed7d7; color: #9b2c2c; border: 1px solid #f56565; }

    /* Toast Notification */
    .toast {
        position: fixed; bottom: 20px; right: 20px; background: var(--dark); color: white;
        padding: 12px 24px; border-radius: 8px; z-index: 9999; font-weight: bold;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; animation: fadeIn 0.3s;
    }
    @keyframes fadeIn { from{ opacity:0; transform: translateY(10px);} to{ opacity:1; transform: translateY(0);} }

    /* Responsive Adjustments */
    @media (max-width: 1024px) {
        .main-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 600px) {
        .header { flex-direction: column; align-items: flex-start; padding: 15px; }
        .header-badges { width: 100%; justify-content: space-between; margin-top: 10px; }
        .comm-grid { grid-template-columns: 1fr; }
        .table-controls { flex-direction: column; }
        .btn-action, .search-box { width: 100%; }
        .stat-value { font-size: 1.5rem; }
        .grid-cards { grid-template-columns: 1fr 1fr; }
    }
</style>
</head>
<body>

<div id="lock-screen">
    <div class="lock-box">
        <h2>ğŸ” Ø§Ù„Ø¹Ø²ÙŠØ²Ø© ÙƒÙ†ØªØ±ÙˆÙ„</h2>
        <p style="color:#718096; margin-bottom:20px;">Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</p>
        <div class="lock-input-group">
            <input type="password" id="lock-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        </div>
        <button class="lock-btn" onclick="unlockSystem()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <div id="login-error" style="color: var(--danger); margin-top: 10px; display: none;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!</div>
    </div>
</div>

<div id="dashboard" class="container hidden">
    
    <div class="header">
        <div class="header-title">
            <h1>ğŸ›ï¸ Ù„ÙˆØ­Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø²ÙŠØ²Ø©</h1>
            <p style="color:#718096; font-size:0.9rem;">Ù…ØªØ§Ø¨Ø¹Ø© Ø­ÙŠØ© Ù„Ù„Ø¬Ù†Ø© 24 (Ø±Ø¬Ø§Ù„) ÙˆØ§Ù„Ù„Ø¬Ù†Ø© 25 (Ù†Ø³Ø§Ø¡)</p>
        </div>
        <div class="header-badges">
            <div class="badge badge-live"><div class="dot"></div> <span id="conn-status">Ù…ØªØµÙ„</span></div>
            <div class="badge badge-admin" id="user-role">Ø²Ø§Ø¦Ø±</div>
        </div>
    </div>

    <div class="grid-cards">
        <div class="stat-card">
            <div class="stat-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª</div>
            <div class="stat-value" id="total-votes">0</div>
            <div class="stat-sub">ÙÙŠ Ø§Ù„Ù„Ø¬Ù†ØªÙŠÙ†</div>
        </div>
        
        <div class="stat-card" style="border-bottom-color: var(--info);">
            <div class="stat-title">Ø£ØµÙˆØ§Øª Ø¢Ø®Ø± Ø³Ø§Ø¹Ø©</div>
            <div class="stat-value" style="color:var(--info)" id="last-hour-votes">0</div>
            <div class="stat-sub">Ù…Ø¤Ø´Ø± Ø§Ù„Ø²Ø®Ù…</div>
        </div>

        <div class="stat-card" style="border-bottom-color: var(--warning);">
            <div class="stat-title">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©</div>
            <div class="stat-value" style="color:var(--warning)" id="avg-per-min">0</div>
            <div class="stat-sub">Ù…Ù†Ø° Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙˆÙŠØª</div>
        </div>

        <div class="stat-card">
            <div class="stat-title">Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</div>
            <div class="stat-value" style="color:var(--primary)" id="valid-votes">0</div>
            <div class="stat-sub">Ø¨Ù†Ø³Ø¨Ø© <span id="valid-percent">0%</span></div>
        </div>
        
        <div class="stat-card">
            <div class="stat-title">Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ø¨Ø§Ø·Ù„Ø©</div>
            <div class="stat-value" style="color:var(--danger)" id="invalid-votes">0</div>
            <div class="stat-sub">Ø¨Ù†Ø³Ø¨Ø© <span id="invalid-percent">0%</span></div>
        </div>
    </div>

    <div class="main-grid">
        
        <div style="display: flex; flex-direction: column; gap: 25px;">
            <div class="panel">
                <h3>ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†</h3>
                <div style="position: relative; flex: 1; min-height: 250px;">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
            <div class="panel">
                <h3>ğŸ“ˆ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ (Ø¨Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©)</h3>
                <div style="position: relative; flex: 1; min-height: 200px;">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>
        </div>

        <div style="display: flex; flex-direction: column; gap: 25px;">
            <div class="panel">
                <h3>ğŸ¢ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¬Ø§Ù† (Ø§Ø¶ØºØ· Ù„Ù„ØªÙØ§ØµÙŠÙ„)</h3>
                <div class="comm-grid">
                    <div class="comm-box" onclick="showCommitteeDetails(24)">
                        <h4>Ù„Ø¬Ù†Ø© 24 (Ø±Ø¬Ø§Ù„)</h4>
                        <div class="comm-stats" id="comm-24-stats">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                    </div>
                    <div class="comm-box" onclick="showCommitteeDetails(25)">
                        <h4>Ù„Ø¬Ù†Ø© 25 (Ù†Ø³Ø§Ø¡)</h4>
                        <div class="comm-stats" id="comm-25-stats">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                    </div>
                </div>
            </div>

            <div class="panel" style="flex:1;">
                <h3>ğŸ† ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ¯Ø§Ø±Ø©</h3>
                <div id="ranking-container" style="max-height: 400px; overflow-y: auto;"></div>
            </div>

            <div class="panel">
                <h3>ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡</h3>
                <div class="notify-area">
                    <div class="notify-options">
                        <label><input type="radio" name="n-target" value="24" checked> Ø±Ø¬Ø§Ù„</label>
                        <label style="margin-right:10px;"><input type="radio" name="n-target" value="25"> Ù†Ø³Ø§Ø¡</label>
                    </div>
                    <textarea id="notify-msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„ØªØ¸Ù‡Ø± ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„ØªØµÙˆÙŠØª..."></textarea>
                    <button class="btn-action btn-blue" style="width:100%" onclick="sendNotify()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</button>
                </div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h3>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>
        <div class="table-controls">
            <input type="text" id="search-inp" class="search-box" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ù†Ø§Ø®Ø¨ Ø£Ùˆ Ù…Ø±Ø´Ø­..." onkeyup="renderTable()">
            <button class="btn-action btn-green" onclick="exportExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
            <button class="btn-action btn-blue" onclick="filterTableByCommittee('all')">Ø§Ù„ÙƒÙ„</button>
            <button id="btn-reset" class="btn-action btn-red hidden" onclick="resetAllData()">âš ï¸ ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
        <div class="table-wrap">
            <table id="main-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ù„Ø¬Ù†Ø©</th>
                        <th>Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>ÙˆÙ‚Øª Ø§Ù„ØªØµÙˆÙŠØª</th>
                        <th class="admin-col hidden">ØªØ­ÙƒÙ…</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="edit-popup" class="overlay hidden">
    <div class="popup">
        <div class="popup-header">
            <span>ØªØ¹Ø¯ÙŠÙ„ ØµÙˆØª</span>
            <button class="close-btn" onclick="closePopup('edit-popup')">&times;</button>
        </div>
        <div style="margin-bottom:15px; font-weight:bold; color:var(--primary);" id="edit-voter-name"></div>
        <div id="edit-options-list"></div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-action btn-green" style="flex:1" onclick="saveEditVote()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            <button class="btn-action btn-red" onclick="deleteSingleVote()">Ø­Ø°Ù Ø§Ù„ØµÙˆØª</button>
        </div>
    </div>
</div>

<div id="details-popup" class="overlay hidden">
    <div class="popup">
        <div class="popup-header">
            <span id="dt-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù„Ø¬Ù†Ø©</span>
            <button class="close-btn" onclick="closePopup('details-popup')">&times;</button>
        </div>
        
        <div id="dt-status" class="status-indicator"></div>

        <div class="detail-grid">
            <div class="detail-box">
                <div class="detail-val" id="dt-total">0</div>
                <div class="detail-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª</div>
            </div>
            <div class="detail-box">
                <div class="detail-val" style="color:var(--primary)" id="dt-valid">0</div>
                <div class="detail-lbl">ØµØ­ÙŠØ­Ø©</div>
            </div>
            <div class="detail-box">
                <div class="detail-val" style="color:var(--danger)" id="dt-invalid">0</div>
                <div class="detail-lbl">Ø¨Ø§Ø·Ù„Ø©</div>
            </div>
            <div class="detail-box">
                <div class="detail-val" id="dt-avg-hour">0</div>
                <div class="detail-lbl">Ù…ØªÙˆØ³Ø· / Ø³Ø§Ø¹Ø©</div>
            </div>
            <div class="detail-box" style="grid-column: span 2;">
                <div class="detail-val" id="dt-avg-min">0</div>
                <div class="detail-lbl">Ù…ØªÙˆØ³Ø· / Ø¯Ù‚ÙŠÙ‚Ø©</div>
            </div>
        </div>
        
        <div style="margin-top:20px;">
             <button class="btn-action btn-blue" style="width:100%" onclick="filterTableFromPopup()">ğŸ” Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø¬Ù†Ø© ÙÙ‚Ø·</button>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, set, update, remove, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBmgHAmoZKm2RRXg42KWdQHD4e5hAUtBbc",
  authDomain: "azizaonly-2ab60.firebaseapp.com",
  databaseURL: "https://azizaonly-2ab60-default-rtdb.firebaseio.com",
  projectId: "azizaonly-2ab60",
  storageBucket: "azizaonly-2ab60.firebasestorage.app",
  messagingSenderId: "447237336190",
  appId: "1:447237336190:web:eab8a2b524b0dcdd5a3c2f",
  measurementId: "G-3DYLFJC5YH"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const candidatesList = [
  "Ø§ÙŠÙ‡Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø¯Ù‡","Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹ØªÙ…Ø§Ù†Ù‰","Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯Ù‰","Ø¹Ø§Ø¯Ù„ Ø§Ù„Ø¬ÙŠØ§Ø±",
  "Ø§Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø³Ù…Ø±Ù‡","ÙˆÙ„ÙŠØ¯ ØªÙŠØ³ÙŠØ± Ø§Ù„Ø§Ù…ÙŠØ±","ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹ÙŠØ³ÙˆÙ‰","Ø§Ù„Ø¨Ø¯ÙˆÙ‰ Ø¬Ù…ÙŠØ²",
  "Ø§Ø­Ù…Ø¯ Ø§Ù„Ø±ÙŠØ³","Ø£Ø­Ù…Ø¯ Ø¹ÙˆÙ","Ø­Ø³Ù† Ø§Ù„Ù…Ù„Ù‡Ø§Ø·","Ø¹Ù…Ø±Ùˆ Ù…Ø­Ù…Ø¯ Ø¨Ø­ÙŠØ±Ù‰",
  "Ø§Ù„Ø³ÙŠØ¯ Ø·Ù…Ø§Ù†","Ù…Ø­Ù…Ø¯ Ø¯Ù†Ø¯Ù†","Ù…Ø¬Ø¯Ù‰ Ø§Ù„Ø£Ù…ÙŠØ±"
];

let allVotes = [];
let currentFilter = 'all';
let isAdmin = false;
let charts = { bar: null, line: null };
let currentEditId = null;
let tempPopupCommittee = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø±Ù‚Ù… Ø§Ù„Ù„Ø¬Ù†Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹

window.unlockSystem = function() {
    const pass = document.getElementById('lock-pass').value;
    const err = document.getElementById('login-error');
    
    if(pass === 'aziza100') {
        isAdmin = false;
        enterDashboard("Ù…Ø±Ø§Ù‚Ø¨");
    } else if (pass === 'azizaadmin') {
        isAdmin = true;
        enterDashboard("Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…");
    } else {
        err.style.display = 'block';
    }
}

function enterDashboard(role) {
    document.getElementById('lock-screen').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    document.getElementById('user-role').textContent = role;
    
    if(isAdmin) {
        document.getElementById('btn-reset').classList.remove('hidden');
        document.querySelectorAll('.admin-col').forEach(el => el.classList.remove('hidden'));
    }
    
    startDataListener();
    checkConnection();
}

function checkConnection() {
    const connectedRef = ref(db, ".info/connected");
    onValue(connectedRef, (snap) => {
        const status = document.getElementById('conn-status');
        const badge = status.parentElement;
        if (snap.val() === true) {
            status.textContent = "Ù…ØªØµÙ„";
            badge.style.background = "#def7ec"; badge.style.color = "#03543f";
            badge.querySelector('.dot').style.background = "#38ef7d";
        } else {
            status.textContent = "Ù…Ù†Ù‚Ø·Ø¹";
            badge.style.background = "#feb2b2"; badge.style.color = "#742a2a";
            badge.querySelector('.dot').style.background = "#e53e3e";
        }
    });
}

function startDataListener() {
    const votesRef = ref(db, 'votes/aziza');
    onValue(votesRef, (snapshot) => {
        const data = snapshot.val();
        allVotes = [];
        if(data) {
            Object.keys(data).forEach(key => {
                allVotes.push({ id: key, ...data[key] });
            });
        }
        allVotes.sort((a, b) => b.timestamp - a.timestamp);
        
        updateUI();
    });
}

function updateUI() {
    updateStats();
    updateCharts();
    updateRanking();
    updateCommitteeBoxes();
    renderTable();
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù…ÙØªÙˆØ­Ø©ØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©
    if(!document.getElementById('details-popup').classList.contains('hidden') && tempPopupCommittee) {
        window.showCommitteeDetails(tempPopupCommittee);
    }
}

function updateStats() {
    const total = allVotes.length;
    const valid = allVotes.filter(v => v.vote_validity === "ØµØ­ÙŠØ­").length;
    const invalid = allVotes.filter(v => v.vote_validity === "Ø¨Ø§Ø·Ù„").length;
    
    const oneHourAgo = Date.now() - (60 * 60 * 1000);
    const lastHourCount = allVotes.filter(v => v.timestamp > oneHourAgo).length;
    
    let avgPerMin = 0;
    if (total > 0) {
        const firstVoteTime = allVotes[allVotes.length - 1].timestamp;
        const durationMinutes = (Date.now() - firstVoteTime) / 60000;
        
        if (durationMinutes > 0) {
            avgPerMin = (total / durationMinutes).toFixed(2);
        } else {
             avgPerMin = total;
        }
    }

    document.getElementById('total-votes').textContent = total;
    document.getElementById('valid-votes').textContent = valid;
    document.getElementById('invalid-votes').textContent = invalid;
    
    document.getElementById('last-hour-votes').textContent = lastHourCount;
    document.getElementById('avg-per-min').textContent = avgPerMin;
    
    document.getElementById('valid-percent').textContent = total ? Math.round((valid/total)*100)+"%" : "0%";
    document.getElementById('invalid-percent').textContent = total ? Math.round((invalid/total)*100)+"%" : "0%";
}

function updateCommitteeBoxes() {
    const c24 = allVotes.filter(v => v.committee == 24);
    const c25 = allVotes.filter(v => v.committee == 25);
    
    document.getElementById('comm-24-stats').textContent = `${c24.length} ØµÙˆØª (${c24.filter(v=>v.vote_validity=='ØµØ­ÙŠØ­').length} ØµØ­ÙŠØ­)`;
    document.getElementById('comm-25-stats').textContent = `${c25.length} ØµÙˆØª (${c25.filter(v=>v.vote_validity=='ØµØ­ÙŠØ­').length} ØµØ­ÙŠØ­)`;
}

// --- Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù„Ø¬Ù†Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ---
window.showCommitteeDetails = function(commId) {
    tempPopupCommittee = commId;
    const votes = allVotes.filter(v => v.committee == commId);
    
    const total = votes.length;
    const valid = votes.filter(v => v.vote_validity === 'ØµØ­ÙŠØ­').length;
    const invalid = votes.filter(v => v.vote_validity === 'Ø¨Ø§Ø·Ù„').length;
    
    // Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø²Ù…Ù†
    let avgHour = 0;
    let avgMin = 0;
    let isActive = false;

    if(total > 0) {
        // Ø§Ù„Ù…ØµÙÙˆÙØ© Ù…Ø±ØªØ¨Ø© ØªÙ†Ø§Ø²Ù„ÙŠØ§Ù‹ØŒ Ø¢Ø®Ø± Ø¹Ù†ØµØ± Ù‡Ùˆ Ø§Ù„Ø£Ù‚Ø¯Ù…
        const firstVoteTime = votes[votes.length - 1].timestamp;
        const lastVoteTime = votes[0].timestamp;
        const durationMs = Date.now() - firstVoteTime;
        
        // Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª
        const hours = durationMs / (1000 * 60 * 60);
        const minutes = durationMs / (1000 * 60);
        
        avgHour = hours > 0 ? (total / hours).toFixed(1) : total;
        avgMin = minutes > 0 ? (total / minutes).toFixed(2) : total;

        // Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø·: Ø¥Ø°Ø§ Ø¯Ø®Ù„ ØµÙˆØª ÙÙŠ Ø¢Ø®Ø± Ø³Ø§Ø¹Ø©
        if(Date.now() - lastVoteTime < (60 * 60 * 1000)) {
            isActive = true;
        }
    }

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù€ Popup
    document.getElementById('dt-title').textContent = commId == 24 ? "ØªÙØ§ØµÙŠÙ„ Ù„Ø¬Ù†Ø© 24 (Ø±Ø¬Ø§Ù„)" : "ØªÙØ§ØµÙŠÙ„ Ù„Ø¬Ù†Ø© 25 (Ù†Ø³Ø§Ø¡)";
    document.getElementById('dt-total').textContent = total;
    document.getElementById('dt-valid').textContent = valid;
    document.getElementById('dt-invalid').textContent = invalid;
    document.getElementById('dt-avg-hour').textContent = avgHour;
    document.getElementById('dt-avg-min').textContent = avgMin;

    const statusEl = document.getElementById('dt-status');
    if(isActive) {
        statusEl.className = "status-indicator is-active";
        statusEl.textContent = "ğŸŸ¢ Ø§Ù„Ù„Ø¬Ù†Ø© Ù†Ø´Ø·Ø© (Ø§Ø³ØªÙ‚Ø¨Ù„Øª Ø£ØµÙˆØ§Øª ÙÙŠ Ø¢Ø®Ø± Ø³Ø§Ø¹Ø©)";
    } else {
        statusEl.className = "status-indicator is-inactive";
        statusEl.textContent = "ğŸ”´ Ø§Ù„Ù„Ø¬Ù†Ø© ØºÙŠØ± Ù†Ø´Ø·Ø© (Ù„Ù… ØªØ³ØªÙ‚Ø¨Ù„ Ø£ØµÙˆØ§Øª Ù…Ù†Ø° Ø³Ø§Ø¹Ø©)";
    }

    document.getElementById('details-popup').classList.remove('hidden');
}

window.filterTableFromPopup = function() {
    if(tempPopupCommittee) {
        filterTableByCommittee(tempPopupCommittee);
        closePopup('details-popup');
    }
}

function updateRanking() {
    const container = document.getElementById('ranking-container');
    const counts = {};
    
    candidatesList.forEach(c => counts[c] = 0);
    
    allVotes.forEach(v => {
        if(v.selected && Array.isArray(v.selected)) {
            v.selected.forEach(cand => {
                if(counts[cand] !== undefined) counts[cand]++;
            });
        }
    });
    
    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    const maxVal = sorted[0] ? sorted[0][1] : 1;

    let html = '';
    sorted.forEach(([name, count], index) => {
        const percent = maxVal > 0 ? (count / maxVal) * 100 : 0;
        const medal = index === 0 ? 'ğŸ¥‡' : (index === 1 ? 'ğŸ¥ˆ' : (index === 2 ? 'ğŸ¥‰' : `#${index+1}`));
        
        html += `
        <div class="ranking-item">
            <div style="width:40px; font-weight:bold; color:#718096;">${medal}</div>
            <div style="width:140px; font-weight:bold; font-size:0.85rem;">${name}</div>
            <div class="rank-bar-bg"><div class="rank-bar-fill" style="width:${percent}%"></div></div>
            <div style="width:40px; text-align:left; font-weight:bold;">${count}</div>
        </div>`;
    });
    container.innerHTML = html;
}

window.filterTableByCommittee = function(c) {
    currentFilter = c;
    renderTable();
    showToast(c === 'all' ? "Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„" : `ØªÙ… Ø§Ù„ØªØµÙÙŠØ©: Ù„Ø¬Ù†Ø© ${c}`);
}

window.renderTable = function() {
    const tbody = document.getElementById('table-body');
    const search = document.getElementById('search-inp').value.toLowerCase();
    
    let filtered = allVotes;
    
    if(currentFilter !== 'all') {
        filtered = filtered.filter(v => v.committee == currentFilter);
    }
    
    if(search) {
        filtered = filtered.filter(v => 
            (v.name && v.name.toLowerCase().includes(search)) ||
            (v.selected && v.selected.join(" ").includes(search))
        );
    }

    let html = '';
    filtered.forEach((v, i) => {
        const statusClass = v.vote_validity === 'ØµØ­ÙŠØ­' ? 'status-ok' : 'status-bad';
        const time = new Date(v.timestamp).toLocaleTimeString('ar-EG');
        const cands = Array.isArray(v.selected) ? v.selected.join(" ØŒ ") : "";
        
        const adminBtn = isAdmin ? 
            `<button class="btn-action btn-blue" style="padding:5px 10px; font-size:0.7rem;" onclick="openEdit('${v.id}')">ØªØ¹Ø¯ÙŠÙ„</button>` 
            : '';

        html += `
        <tr>
            <td>${filtered.length - i}</td>
            <td style="font-weight:bold;">${v.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}</td>
            <td>${v.committee}</td>
            <td style="font-size:0.85rem; color:#4a5568;">${cands}</td>
            <td><span class="${statusClass}">${v.vote_validity}</span></td>
            <td style="direction:ltr;">${time}</td>
            <td class="${isAdmin ? '' : 'hidden'}">${adminBtn}</td>
        </tr>`;
    });
    
    tbody.innerHTML = html || '<tr><td colspan="7" style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
}

window.openEdit = function(id) {
    const vote = allVotes.find(v => v.id === id);
    if(!vote) return;
    
    currentEditId = id;
    document.getElementById('edit-voter-name').textContent = `Ø§Ù„Ù†Ø§Ø®Ø¨: ${vote.name}`;
    document.getElementById('edit-popup').classList.remove('hidden');
    
    const container = document.getElementById('edit-options-list');
    let html = '';
    candidatesList.forEach(cand => {
        const checked = vote.selected && vote.selected.includes(cand) ? 'checked' : '';
        html += `
        <label class="edit-option">
            <span>${cand}</span>
            <input type="checkbox" value="${cand}" ${checked}>
        </label>`;
    });
    container.innerHTML = html;
}

window.saveEditVote = function() {
    if(!currentEditId) return;
    
    const checked = Array.from(document.querySelectorAll('#edit-options-list input:checked')).map(i => i.value);
    if(checked.length > 2) { showToast("Ø®Ø·Ø£: Ø§Ø®ØªØ± Ù…Ø±Ø´Ø­ÙŠÙ† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰"); return; }
    
    update(ref(db, `votes/aziza/${currentEditId}`), {
        selected: checked
    }).then(() => {
        showToast("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØµÙˆÙŠØª Ø¨Ù†Ø¬Ø§Ø­");
        closePopup('edit-popup');
    });
}

window.deleteSingleVote = function() {
    if(!currentEditId || !confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙˆØª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
    remove(ref(db, `votes/aziza/${currentEditId}`)).then(() => {
        showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙˆØª");
        closePopup('edit-popup');
    });
}

window.resetAllData = function() {
    if(!confirm("ØªØ­Ø°ÙŠØ± Ø®Ø·ÙŠØ±!\nØ³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙˆØ§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
    remove(ref(db, 'votes/aziza')).then(() => showToast("ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„"));
}

window.sendNotify = function() {
    const msg = document.getElementById('notify-msg').value;
    const target = document.querySelector('input[name="n-target"]:checked').value;
    
    if(!msg.trim()) return showToast("Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹");
    
    const notifRef = push(ref(db, `notifications/committee_${target}`));
    set(notifRef, {
        message: msg,
        timestamp: Date.now(),
        sender: "Admin Control"
    }).then(() => {
        showToast(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø¬Ù†Ø© ${target}`);
        document.getElementById('notify-msg').value = '';
    });
}

window.closePopup = function(id) { 
    document.getElementById(id).classList.add('hidden'); 
    if(id === 'details-popup') tempPopupCommittee = null;
}

window.showToast = function(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 3000);
}

window.exportExcel = function() {
    let csv = '\uFEFFID,Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ù„Ø¬Ù†Ø©,Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†,Ø§Ù„Ø­Ø§Ù„Ø©,Ø§Ù„ÙˆÙ‚Øª\n'; 
    allVotes.forEach((v, i) => {
        const cands = v.selected ? `"${v.selected.join(" | ")}"` : "";
        const time = new Date(v.timestamp).toLocaleString();
        csv += `${i+1},"${v.name}",${v.committee},${cands},${v.vote_validity},"${time}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "aziza_votes_report.csv";
    link.click();
}

// Chart Configuration
function updateCharts() {
    const counts = candidatesList.map(c => {
        return allVotes.reduce((acc, v) => (v.selected && v.selected.includes(c)) ? acc + 1 : acc, 0);
    });
    
    const ctxBar = document.getElementById('barChart').getContext('2d');
    if(charts.bar) charts.bar.destroy();
    charts.bar = new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: candidatesList,
            datasets: [{
                label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª',
                data: counts,
                backgroundColor: '#11998e',
                borderRadius: 4
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    const timeData = {};
    allVotes.forEach(v => {
        const timeKey = new Date(v.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        timeData[timeKey] = (timeData[timeKey] || 0) + 1;
    });
    
    const keys = Object.keys(timeData).reverse().slice(0, 20).reverse();
    const values = keys.map(k => timeData[k]);

    const ctxLine = document.getElementById('lineChart').getContext('2d');
    if(charts.line) charts.line.destroy();
    charts.line = new Chart(ctxLine, {
        type: 'line',
        data: {
            labels: keys,
            datasets: [{
                label: 'Ù†Ø´Ø§Ø· Ø§Ù„ØªØµÙˆÙŠØª',
                data: values,
                borderColor: '#38ef7d',
                backgroundColor: 'rgba(56, 239, 125, 0.2)',
                fill: true,
                tension: 0.4
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}
</script>
</body>
</html>
