<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© - Ø§Ù„Ø¹Ø²ÙŠØ²Ø©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" />
    <style>
        :root {
            --primary: #11998e;
            --primary-dark: #0d7a71;
            --primary-light: #38ef7d;
            --secondary: #38ef7d;
            --accent: #667eea;
            --danger: #f5365c;
            --warning: #fbbf24;
            --info: #2dce89;
            --dark: #2d3748;
            --light: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e0;
            --gray-400: #a0aec0;
            --gray-500: #718096;
            --gray-600: #4a5568;
            --gray-700: #2d3748;
            --card-bg: #ffffff;
            --radius-sm: 0.5rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 50px rgba(0,0,0,0.15);
            --transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 15px; scroll-behavior: smooth; }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--dark);
            line-height: 1.7;
            min-height: 100vh;
            background-attachment: fixed;
        }

        /* ====================== Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„ ====================== */
        #lock-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            padding: 20px;
            backdrop-filter: blur(8px);
        }

        .lock-box {
            background: rgba(255, 255, 255, 0.97);
            padding: 50px 40px;
            width: 100%;
            max-width: 420px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            text-align: center;
            border: 1px solid rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
            animation: lockFadeIn 0.9s ease-out;
        }

        .lock-box::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 6px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .lock-box h2 {
            font-size: 2.4rem;
            font-weight: 900;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
        }

        .lock-box p { color: var(--gray-600); margin-bottom: 30px; font-size: 1.1rem; }

        .lock-box input {
            width: 100%;
            padding: 18px 20px;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-lg);
            font-size: 1.2rem;
            text-align: center;
            background: white;
            transition: var(--transition);
            margin-bottom: 20px;
        }

        .lock-box input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 5px rgba(17,153,142,0.15);
            transform: scale(1.02);
        }

        .lock-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1.25rem;
            font-weight: 800;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-lg);
        }

        .lock-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(17,153,142,0.35);
        }

        @keyframes lockFadeIn {
            from { opacity: 0; transform: translateY(50px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* ====================== Ø§Ù„Ù‡ÙŠØ¯Ø± ====================== */
        .container { max-width: 1480px; margin: auto; padding: 20px; }

        .header {
            background: var(--card-bg);
            padding: 32px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 24px;
            border: 1px solid var(--gray-200);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 10px;
            height: 100%;
            background: linear-gradient(var(--primary), var(--secondary));
        }

        .header-title h1 {
            font-size: 2.2rem;
            font-weight: 900;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-title p { color: var(--gray-600); font-size: 1.05rem; margin-top: 8px; }

        .header-badges { display: flex; gap: 14px; align-items: center; flex-wrap: wrap; }

        .badge {
            padding: 11px 20px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-sm);
        }

        .badge-live { background: #ecfdf5; color: #065f46; }
        .badge-admin { background: var(--gray-200); color: var(--dark); }

        .dot {
            width: 11px; height: 11px;
            background: var(--secondary);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.3); }
        }

        /* ====================== Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ====================== */
        .grid-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 26px;
            margin-bottom: 36px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 30px 26px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border-right: 6px solid var(--primary);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-12px);
            box-shadow: var(--shadow-xl);
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 6px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transform: scaleX(0);
            transform-origin: right;
            transition: transform 0.6s;
        }

        .stat-card:hover::after {
            transform: scaleX(1);
            transform-origin: left;
        }

        .stat-title {
            color: var(--gray-600);
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2.6rem;
            font-weight: 900;
            color: var(--dark);
            line-height: 1;
        }

        .stat-sub { color: var(--gray-500); font-size: 0.9rem; margin-top: 8px; }

        .stat-card:nth-child(2) { border-color: var(--info); }
        .stat-card:nth-child(3) { border-color: var(--warning); }
        .stat-card:nth-child(4) .stat-value { color: var(--primary); }
        .stat-card:nth-child(5) .stat-value { color: var(--danger); }

        /* ====================== Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ====================== */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 32px;
            margin-bottom: 36px;
        }

        .panel {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
            overflow: hidden;
            transition: var(--transition);
        }

        .panel:hover { box-shadow: var(--shadow-xl); }

        .panel h3 {
            padding: 22px 30px;
            margin: 0;
            background: linear-gradient(90deg, rgba(17,153,142,0.06), rgba(56,239,125,0.06));
            border-bottom: 1px solid var(--gray-200);
            font-size: 1.3rem;
            color: var(--primary);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .panel > div { padding: 30px; }

        canvas { border-radius: var(--radius-md); }

        /* ====================== Ø§Ù„Ù„Ø¬Ø§Ù† ====================== */
        .comm-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
        }

        .comm-box {
            background: var(--gray-100);
            padding: 28px;
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .comm-box:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-10px) scale(1.04);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary-dark);
        }

        /* ====================== Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„ ====================== */
        .btn-action {
            padding: 13px 22px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-sm);
        }

        .btn-blue { background: var(--info); color: white; }
        .btn-green { background: var(--secondary); color: white; }
        .btn-red { background: var(--danger); color: white; }

        .btn-action:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .table-wrap {
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-300);
        }

        table { width: 100%; border-collapse: collapse; background: white; }
        thead { background: linear-gradient(90deg, var(--primary), var(--secondary)); color: white; }
        th, td { padding: 16px 14px; text-align: right; }
        th { font-weight: 700; font-size: 0.98rem; }
        tr:hover { background: rgba(17,153,142,0.05); }

        .status-ok { background: #d1fae5; color: #065f46; padding: 6px 12px; border-radius: 20px; font-weight: bold; }
        .status-bad { background: #fee2e2; color: #991b1b; padding: 6px 12px; border-radius: 20px; font-weight: bold; }

        /* ====================== Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ÙˆØ§Ù„ØªÙˆØ³Øª ====================== */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(6px);
            padding: 20px;
        }

        .popup {
            background: white;
            width: 100%;
            max-width: 520px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            animation: popupIn 0.4s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes popupIn {
            from { opacity: 0; transform: scale(0.9) translateY(30px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--dark);
            color: white;
            padding: 16px 28px;
            border-radius: var(--radius-md);
            z-index: 10000;
            font-weight: bold;
            box-shadow: var(--shadow-xl);
            animation: toastIn 0.4s;
        }

        @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .hidden { display: none !important; }

        /* ====================== Ø§Ù„ØªØ¬Ø§ÙˆØ¨ ====================== */
        @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .grid-cards { grid-template-columns: 1fr 1fr; }
            .comm-grid { grid-template-columns: 1fr; }
            .table-controls { flex-direction: column; }
            .btn-action, .search-box { width: 100%; }
        }
        @media (max-width: 480px) {
            .grid-cards { grid-template-columns: 1fr; }
            .lock-box { padding: 40px 25px; }
            html { font-size: 14px; }
        }
    </style>
</head>
<body>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„ -->
    <div id="lock-screen">
        <div class="lock-box">
            <h2><i class="fas fa-shield-alt"></i> Ø§Ù„Ø¹Ø²ÙŠØ²Ø© ÙƒÙ†ØªØ±ÙˆÙ„</h2>
            <p>Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</p>
            <div class="lock-input-group">
                <input type="password" id="lock-pass" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            </div>
            <button class="lock-btn" onclick="unlockSystem()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            <div id="login-error" style="color: var(--danger); margin-top: 15px; display:none; font-weight:bold;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!</div>
        </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <div id="dashboard" class="container hidden">
        <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù€ HTML ÙƒÙ…Ø§ Ù‡Ùˆ ØªÙ…Ø§Ù…Ø§Ù‹ (Ù„Ø§ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ù‡ÙŠÙƒÙ„) -->
        <div class="header">
            <div class="header-title">
                <h1><i class="fas fa-landmark fa-fw"></i> Ù„ÙˆØ­Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø²ÙŠØ²Ø©</h1>
                <p>Ù…ØªØ§Ø¨Ø¹Ø© Ø­ÙŠØ© Ù„Ù„Ø¬Ù†Ø© 24 (Ø±Ø¬Ø§Ù„) ÙˆØ§Ù„Ù„Ø¬Ù†Ø© 25 (Ù†Ø³Ø§Ø¡)</p>
            </div>
            <div class="header-badges">
                <div class="badge badge-live"><div class="dot"></div> <span id="conn-status">Ù…ØªØµÙ„</span></div>
                <div class="badge badge-admin" id="user-role">Ø²Ø§Ø¦Ø±</div>
            </div>
        </div>

        <div class="grid-cards">
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-vote-yea"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª</div>
                <div class="stat-value" id="total-votes">0</div>
                <div class="stat-sub">ÙÙŠ Ø§Ù„Ù„Ø¬Ù†ØªÙŠÙ†</div>
            </div>
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-clock"></i> Ø£ØµÙˆØ§Øª Ø¢Ø®Ø± Ø³Ø§Ø¹Ø©</div>
                <div class="stat-value" id="last-hour-votes">0</div>
                <div class="stat-sub">Ù…Ø¤Ø´Ø± Ø§Ù„Ø²Ø®Ù…</div>
            </div>
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-chart-line"></i> Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©</div>
                <div class="stat-value" id="avg-per-min">0</div>
                <div class="stat-sub">Ù…Ù†Ø° Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙˆÙŠØª</div>
            </div>
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-check-circle"></i> Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</div>
                <div class="stat-value" id="valid-votes">0</div>
                <div class="stat-sub">Ø¨Ù†Ø³Ø¨Ø© <span id="valid-percent">0%</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-title"><i class="fas fa-times-circle"></i> Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ø¨Ø§Ø·Ù„Ø©</div>
                <div class="stat-value" id="invalid-votes">0</div>
                <div class="stat-sub">Ø¨Ù†Ø³Ø¨Ø© <span id="invalid-percent">0%</span></div>
            </div>
        </div>

        <div class="main-grid">
            <div style="display:flex;flex-direction:column;gap:32px;">
                <div class="panel">
                    <h3><i class="fas fa-chart-bar"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†</h3>
                    <div style="position:relative; flex:1;min-height:300px;">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
                <div class="panel">
                    <h3><i class="fas fa-chart-line"></i> Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ (Ø¨Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©)</h3>
                    <div style="position: relative; flex:1;min-height:220px;">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>
            </div>

            <div style="display:flex;flex-direction:column;gap:32px;">
                <div class="panel">
                    <h3><i class="fas fa-building"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¬Ø§Ù† (Ø§Ø¶ØºØ· Ù„Ù„ØªÙØ§ØµÙŠÙ„)</h3>
                    <div class="comm-grid">
                        <div class="comm-box" onclick="showCommitteeDetails(24)">
                            <h4>Ù„Ø¬Ù†Ø© 24 (Ø±Ø¬Ø§Ù„)</h4>
                            <div class="comm-stats" id="comm-24-stats">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                        </div>
                        <div class="comm-box" onclick="showCommitteeDetails(25)">
                            <h4>Ù„Ø¬Ù†Ø© 25 (Ù†Ø³Ø§Ø¡)</h4>
                            <div class="comm-stats" id="comm-25-stats">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                        </div>
                    </div>
                </div>

                <div class="panel" style="flex:1;">
                    <h3><i class="fas fa-trophy"></i> ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ¯Ø§Ø±Ø©</h3>
                    <div id="ranking-container" style="max-height:420px;overflow-y:auto;padding-top:10px;"></div>
                </div>

                <div class="panel">
                    <h3><i class="fas fa-bullhorn"></i> Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡</h3>
                    <div class="notify-area">
                        <div class="notify-options" style="display:flex;gap:15px;margin-bottom:15px;flex-wrap:wrap;">
                            <label><input type="radio" name="n-target" value="24"> Ø±Ø¬Ø§Ù„</label>
                            <label><input type="radio" name="n-target" value="25"> Ù†Ø³Ø§Ø¡</label>
                            <label><input type="radio" name="n-target" value="both" checked> Ù„Ù„Ø¬Ù†ØªÙŠÙ†</label>
                        </div>
                        <textarea id="notify-msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„ØªØ¸Ù‡Ø± ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„ØªØµÙˆÙŠØª..." style="width:100%;padding:14px;border:2px solid var(--gray-300);border-radius:var(--radius-md);resize:none;height:90px;"></textarea>
                        <button class="btn-action btn-blue" style="width:100%;margin-top:10px;" onclick="sendNotify()"><i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3><i class="fas fa-table"></i> Ø³Ø¬Ù„ Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>
            <div class="table-controls" style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;">
                <input type="text" id="search-inp" class="search-box" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ù†Ø§Ø®Ø¨ Ø£Ùˆ Ù…Ø±Ø´Ø­..." onkeyup="renderTable()" style="flex:1;padding:14px;border-radius:var(--radius-md);border:1px solid var(--gray-400);min-width:200px;background:var(--gray-100);">
                <button class="btn-action btn-green" onclick="exportExcel()"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel</button>
                <button class="btn-action btn-blue" onclick="filterTableByCommittee('all')"><i class="fas fa-list"></i> Ø§Ù„ÙƒÙ„</button>
                <button id="btn-reset" class="btn-action btn-red hidden" onclick="resetAllData()"><i class="fas fa-trash"></i> ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</button>
            </div>
            <div class="table-wrap">
                <table id="main-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ù„Ø¬Ù†Ø©</th>
                            <th>Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>ÙˆÙ‚Øª Ø§Ù„ØªØµÙˆÙŠØª</th>
                            <th class="admin-col hidden">ØªØ­ÙƒÙ…</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ÙˆØ§Ù„ØªÙˆØ³Øª -->
    <div id="edit-popup" class="overlay hidden">
        <div class="popup">
            <div class="popup-header" style="display:flex;justify-content:space-between;align-items:center;padding:20px 30px;border-bottom:1px solid var(--gray-200);font-size:1.4rem;font-weight:bold;">
                <span>ØªØ¹Ø¯ÙŠÙ„ ØµÙˆØª</span>
                <button class="close-btn" onclick="closePopup('edit-popup')" style="background:none;border:none;font-size:2rem;cursor:pointer;color:var(--gray-500);">&times;</button>
            </div>
            <div style="padding:30px;">
                <div style="margin-bottom:20px;font-weight:bold;color:var(--primary);font-size:1.1rem;" id="edit-voter-name"></div>
                <div id="edit-options-list"></div>
                <div style="display:flex;gap:12px;margin-top:25px;">
                    <button class="btn-action btn-green" style="flex:1" onclick="saveEditVote()"><i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                    <button class="btn-action btn-red" onclick="deleteSingleVote()"><i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„ØµÙˆØª</button>
                </div>
            </div>
        </div>
    </div>

    <div id="details-popup" class="overlay hidden">
        <div class="popup">
            <div class="popup-header" style="display:flex;justify-content:space-between;align-items:center;padding:20px 30px;border-bottom:1px solid var(--gray-200);font-size:1.4rem;font-weight:bold;">
                <span id="dt-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù„Ø¬Ù†Ø©</span>
                <button class="close-btn" onclick="closePopup('details-popup')" style="background:none;border:none;font-size:2rem;cursor:pointer;color:var(--gray-500);">&times;</button>
            </div>
            <div style="padding:30px;">
                <div id="dt-status" class="status-indicator" style="padding:16px;border-radius:var(--radius-md);text-align:center;margin-bottom:20px;font-weight:bold;font-size:1.1rem;"></div>
                <div class="detail-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                    <div class="detail-box" style="background:var(--gray-100);padding:20px;border-radius:var(--radius-md);text-align:center;">
                        <div class="detail-val" id="dt-total" style="font-size:2rem;font-weight:900;">0</div>
                        <div class="detail-lbl" style="color:var(--gray-600);margin-top:6px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª</div>
                    </div>
                    <div class="detail-box" style="background:var(--gray-100);padding:20px;border-radius:var(--radius-md);text-align:center;">
                        <div class="detail-val" style="font-size:2rem;font-weight:900;color:var(--primary);" id="dt-valid">0</div>
                        <div class="detail-lbl" style="color:var(--gray-600);margin-top:6px;">ØµØ­ÙŠØ­Ø©</div>
                    </div>
                    <div class="detail-box" style="background:var(--gray-100);padding:20px;border-radius:var(--radius-md);text-align:center;">
                        <div class="detail-val" style="font-size:2rem;font-weight:900;color:var(--danger);" id="dt-invalid">0</div>
                        <div class="detail-lbl" style="color:var(--gray-600);margin-top:6px;">Ø¨Ø§Ø·Ù„Ø©</div>
                    </div>
                    <div class="detail-box" style="background:var(--gray-100);padding:20px;border-radius:var(--radius-md);text-align:center;">
                        <div class="detail-val" style="font-size:2rem;font-weight:900;" id="dt-avg-hour">0</div>
                        <div class="detail-lbl" style="color:var(--gray-600);margin-top:6px;">Ù…ØªÙˆØ³Ø· / Ø³Ø§Ø¹Ø©</div>
                    </div>
                    <div class="detail-box" style="grid-column:span 2;background:var(--gray-100);padding:20px;border-radius:var(--radius-md);text-align:center;">
                        <div class="detail-val" style="font-size:2.2rem;font-weight:900;" id="dt-avg-min">0</div>
                        <div class="detail-lbl" style="color:var(--gray-600);margin-top:6px;">Ù…ØªÙˆØ³Ø· / Ø¯Ù‚ÙŠÙ‚Ø©</div>
                    </div>
                </div>
                <button class="btn-action btn-blue" style="width:100%;margin-top:25px;padding:15px;" onclick="filterTableFromPopup()"><i class="fas fa-search"></i> Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø¬Ù†Ø© ÙÙ‚Ø·</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­</div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, update, remove, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBmgHAmoZKm2RRXg42KWdQHD4e5hAUtBbc",
            authDomain: "azizaonly-2ab60.firebaseapp.com",
            databaseURL: "https://azizaonly-2ab60-default-rtdb.firebaseio.com",
            projectId: "azizaonly-2ab60",
            storageBucket: "azizaonly-2ab60.appspot.com",
            messagingSenderId: "447237336190",
            appId: "1:447237336190:web:eab8a2b524b0dcdd5a3c2f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const candidatesList = [
            "Ø§ÙŠÙ‡Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø¯Ù‡","Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹ØªÙ…Ø§Ù†Ù‰","Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯Ù‰","Ø¹Ø§Ø¯Ù„ Ø§Ù„Ø¬ÙŠØ§Ø±",
            "Ø§Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø³Ù…Ø±Ù‡","ÙˆÙ„ÙŠØ¯ ØªÙŠØ³ÙŠØ± Ø§Ù„Ø§Ù…ÙŠØ±","ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹ÙŠØ³ÙˆÙ‰","Ø§Ù„Ø¨Ø¯ÙˆÙ‰ Ø¬Ù…ÙŠØ²",
            "Ø§Ø­Ù…Ø¯ Ø§Ù„Ø±ÙŠØ³","Ø£Ø­Ù…Ø¯ Ø¹ÙˆÙ","Ø­Ø³Ù† Ø§Ù„Ù…Ù„Ù‡Ø§Ø·","Ø¹Ù…Ø±Ùˆ Ù…Ø­Ù…Ø¯ Ø¨Ø­ÙŠØ±Ù‰",
            "Ø§Ù„Ø³ÙŠØ¯ Ø·Ù…Ø§Ù†","Ù…Ø­Ù…Ø¯ Ø¯Ù†Ø¯Ù†","Ù…Ø¬Ø¯Ù‰ Ø§Ù„Ø£Ù…ÙŠØ±"
        ];

        let allVotes = [];
        let currentFilter = 'all';
        let isAdmin = false;
        let charts = { bar: null, line: null };
        let currentEditId = null;
        let tempPopupCommittee = null;

        window.unlockSystem = function() {
            const pass = document.getElementById('lock-pass').value;
            const err = document.getElementById('login-error');
            if(pass === 'aziza100') {
                isAdmin = false; enterDashboard("Ù…Ø±Ø§Ù‚Ø¨");
            } else if (pass === 'azizaadmin') {
                isAdmin = true; enterDashboard("Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…");
            } else {
                err.style.display = 'block';
            }
        }

        function enterDashboard(role) {
            document.getElementById('lock-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('user-role').textContent = role;
            if(isAdmin) {
                document.getElementById('btn-reset').classList.remove('hidden');
                document.querySelectorAll('.admin-col').forEach(el => el.classList.remove('hidden'));
            }
            startDataListener();
            checkConnection();
        }

        function checkConnection() {
            const connectedRef = ref(db, ".info/connected");
            onValue(connectedRef, (snap) => {
                const status = document.getElementById('conn-status');
                const badge = status.parentElement;
                if (snap.val() === true) {
                    status.textContent = "Ù…ØªØµÙ„";
                    badge.style.background = "#ecfdf5"; badge.style.color = "#065f46";
                    badge.querySelector('.dot').style.background = "#38ef7d";
                } else {
                    status.textContent = "Ù…Ù†Ù‚Ø·Ø¹";
                    badge.style.background = "#fee2e2"; badge.style.color = "#991b1b";
                    badge.querySelector('.dot').style.background = "#ef4444";
                }
            });
        }

        function startDataListener() {
            const votesRef = ref(db, 'votes/aziza');
            onValue(votesRef, (snapshot) => {
                const data = snapshot.val();
                allVotes = [];
                if(data) {
                    Object.keys(data).forEach(key => {
                        allVotes.push({ id: key, ...data[key] });
                    });
                }
                allVotes.sort((a, b) => b.timestamp - a.timestamp);
                updateUI();
            });
        }

        function updateUI() {
            updateStats(); updateCharts(); updateRanking(); updateCommitteeBoxes();
            renderTable();
            if(!document.getElementById('details-popup').classList.contains('hidden') && tempPopupCommittee) {
                window.showCommitteeDetails(tempPopupCommittee);
            }
        }

        function updateStats() {
            const total = allVotes.length;
            const valid = allVotes.filter(v => v.vote_validity === "ØµØ­ÙŠØ­").length;
            const invalid = allVotes.filter(v => v.vote_validity === "Ø¨Ø§Ø·Ù„").length;
            const oneHourAgo = Date.now() - (60 * 60 * 1000);
            const lastHourCount = allVotes.filter(v => v.timestamp > oneHourAgo).length;
            let avgPerMin = 0;
            if (total > 0) {
                const firstVoteTime = allVotes[allVotes.length - 1].timestamp;
                const durationMinutes = (Date.now() - firstVoteTime) / 60000;
                avgPerMin = durationMinutes > 0 ? (total / durationMinutes).toFixed(2) : total;
            }

            document.getElementById('total-votes').textContent = total;
            document.getElementById('valid-votes').textContent = valid;
            document.getElementById('invalid-votes').textContent = invalid;
            document.getElementById('last-hour-votes').textContent = lastHourCount;
            document.getElementById('avg-per-min').textContent = avgPerMin;
            document.getElementById('valid-percent').textContent = total ? Math.round((valid/total)*100)+"%" : "0%";
            document.getElementById('invalid-percent').textContent = total ? Math.round((invalid/total)*100)+"%" : "0%";
        }

        function updateCommitteeBoxes() {
            const c24 = allVotes.filter(v => v.committee == 24);
            const c25 = allVotes.filter(v => v.committee == 25);
            document.getElementById('comm-24-stats').textContent = `${c24.length} ØµÙˆØª (${c24.filter(v=>v.vote_validity=='ØµØ­ÙŠØ­').length} ØµØ­ÙŠØ­)`;
            document.getElementById('comm-25-stats').textContent = `${c25.length} ØµÙˆØª (${c25.filter(v=>v.vote_validity=='ØµØ­ÙŠØ­').length} ØµØ­ÙŠØ­)`;
        }

        window.showCommitteeDetails = function(commId) {
            tempPopupCommittee = commId;
            const votes = allVotes.filter(v => v.committee == commId);
            const total = votes.length;
            const valid = votes.filter(v => v.vote_validity === 'ØµØ­ÙŠØ­').length;
            const invalid = votes.filter(v => v.vote_validity === 'Ø¨Ø§Ø·Ù„').length;
            let avgHour = 0, avgMin = 0, isActive = false;
            if(total > 0) {
                const firstVoteTime = votes[votes.length - 1].timestamp;
                const lastVoteTime = votes[0].timestamp;
                const durationMs = Date.now() - firstVoteTime;
                const hours = durationMs / (1000 * 60 * 60);
                const minutes = durationMs / (1000 * 60);
                avgHour = hours > 0 ? (total / hours).toFixed(1) : total;
                avgMin = minutes > 0 ? (total / minutes).toFixed(2) : total;
                if(Date.now() - lastVoteTime < (60 * 60 * 1000)) isActive = true;
            }

            document.getElementById('dt-title').textContent = commId == 24 ? "ØªÙØ§ØµÙŠÙ„ Ù„Ø¬Ù†Ø© 24 (Ø±Ø¬Ø§Ù„)" : "ØªÙØ§ØµÙŠÙ„ Ù„Ø¬Ù†Ø© 25 (Ù†Ø³Ø§Ø¡)";
            document.getElementById('dt-total').textContent = total;
            document.getElementById('dt-valid').textContent = valid;
            document.getElementById('dt-invalid').textContent = invalid;
            document.getElementById('dt-avg-hour').textContent = avgHour;
            document.getElementById('dt-avg-min').textContent = avgMin;

            const statusEl = document.getElementById('dt-status');
            if(isActive) {
                statusEl.className = "status-indicator";
                statusEl.style.background = "#d1fae5"; statusEl.style.color = "#065f46";
                statusEl.textContent = "ğŸŸ¢ Ø§Ù„Ù„Ø¬Ù†Ø© Ù†Ø´Ø·Ø© (Ø§Ø³ØªÙ‚Ø¨Ù„Øª Ø£ØµÙˆØ§Øª ÙÙŠ Ø¢Ø®Ø± Ø³Ø§Ø¹Ø©)";
            } else {
                statusEl.className = "status-indicator";
                statusEl.style.background = "#fee2e2"; statusEl.style.color = "#991b1b";
                statusEl.textContent = "ğŸ”´ Ø§Ù„Ù„Ø¬Ù†Ø© ØºÙŠØ± Ù†Ø´Ø·Ø© (Ù„Ù… ØªØ³ØªÙ‚Ø¨Ù„ Ø£ØµÙˆØ§Øª Ù…Ù†Ø° Ø³Ø§Ø¹Ø©)";
            }

            document.getElementById('details-popup').classList.remove('hidden');
        }

        window.filterTableFromPopup = function() {
            if(tempPopupCommittee) {
                filterTableByCommittee(tempPopupCommittee);
                closePopup('details-popup');
            }
        }

        function updateRanking() {
            const container = document.getElementById('ranking-container');
            const counts = {};
            candidatesList.forEach(c => counts[c] = 0);
            allVotes.forEach(v => {
                if(v.selected && Array.isArray(v.selected)) {
                    v.selected.forEach(cand => { if(counts[cand] !== undefined) counts[cand]++; });
                }
            });

            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            const maxVal = sorted[0] ? sorted[0][1] : 1;
            let html = '';
            sorted.forEach(([name, count], index) => {
                const percent = maxVal > 0 ? (count / maxVal) * 100 : 0;
                const medal = index === 0 ? 'ğŸ¥‡' : (index === 1 ? 'ğŸ¥ˆ' : (index === 2 ? 'ğŸ¥‰' : `#${index+1}`));
                html += `<div style="display:flex;align-items:center;padding:14px 0;border-bottom:1px solid var(--gray-200);">
                    <div style="width:50px;font-weight:bold;color:var(--gray-600);font-size:1.3rem;">${medal}</div>
                    <div style="flex:1;font-weight:bold;">${name}</div>
                    <div style="width:60px;text-align:left;font-weight:bold;font-size:1.2rem;">${count}</div>
                    <div style="flex:2;margin:0 15px;height:10px;background:var(--gray-200);border-radius:5px;overflow:hidden;">
                        <div style="height:100%;background:var(--primary);width:${percent}%;border-radius:5px;transition:width 0.8s ease;"></div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        window.filterTableByCommittee = function(c) {
            currentFilter = c;
            renderTable();
            showToast(c === 'all' ? "Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„" : `ØªÙ… Ø§Ù„ØªØµÙÙŠØ©: Ù„Ø¬Ù†Ø© ${c}`);
        }

        window.renderTable = function() {
            const tbody = document.getElementById('table-body');
            const search = document.getElementById('search-inp').value.toLowerCase();
            let filtered = allVotes;
            if(currentFilter !== 'all') filtered = filtered.filter(v => v.committee == currentFilter);
            if(search) {
                filtered = filtered.filter(v =>
                    (v.name && v.name.toLowerCase().includes(search)) ||
                    (v.selected && v.selected.join(" ").toLowerCase().includes(search))
                );
            }

            let html = '';
            filtered.forEach((v, i) => {
                const statusClass = v.vote_validity === 'ØµØ­ÙŠØ­' ? 'status-ok' : 'status-bad';
                const time = new Date(v.timestamp).toLocaleTimeString('ar-EG');
                const cands = Array.isArray(v.selected) ? v.selected.join(" ØŒ ") : "";
                const adminBtn = isAdmin ? `<button class="btn-action btn-blue" style="padding:8px 14px;font-size:0.8rem;" onclick="openEdit('${v.id}')"><i class="fas fa-edit"></i></button>` : '';
                html += `<tr>
                    <td>${filtered.length - i}</td>
                    <td style="font-weight:bold;">${v.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}</td>
                    <td>${v.committee}</td>
                    <td style="font-size:0.9rem;color:var(--gray-600);">${cands}</td>
                    <td><span class="${statusClass}">${v.vote_validity}</span></td>
                    <td style="direction:ltr;">${time}</td>
                    <td class="${isAdmin ? '' : 'hidden'}">${adminBtn}</td>
                </tr>`;
            });
            tbody.innerHTML = html || '<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--gray-500);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
        }

        window.openEdit = function(id) {
            const vote = allVotes.find(v => v.id === id);
            if(!vote) return;
            currentEditId = id;
            document.getElementById('edit-voter-name').textContent = `Ø§Ù„Ù†Ø§Ø®Ø¨: ${vote.name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}`;
            document.getElementById('edit-popup').classList.remove('hidden');
            const container = document.getElementById('edit-options-list');
            let html = '';
            candidatesList.forEach(cand => {
                const checked = vote.selected && vote.selected.includes(cand) ? 'checked' : '';
                html += `<label style="display:flex;justify-content:space-between;align-items:center;padding:14px;border:1px solid var(--gray-300);border-radius:var(--radius-md);margin-bottom:10px;cursor:pointer;">
                    <span>${cand}</span>
                    <input type="checkbox" value="${cand}" ${checked} style="width:22px;height:22px;accent-color:var(--primary);">
                </label>`;
            });
            container.innerHTML = html;
        }

        window.saveEditVote = function() {
            if(!currentEditId) return;
            const checked = Array.from(document.querySelectorAll('#edit-options-list input:checked')).map(i => i.value);
            if(checked.length > 2) { showToast("Ø®Ø·Ø£: Ø§Ø®ØªØ± Ù…Ø±Ø´Ø­ÙŠÙ† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰"); return; }
            update(ref(db, `votes/aziza/${currentEditId}`), {selected: checked})
                .then(() => { showToast("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØµÙˆÙŠØª Ø¨Ù†Ø¬Ø§Ø­"); closePopup('edit-popup'); });
        }

        window.deleteSingleVote = function() {
            if(!currentEditId || !confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙˆØª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
            remove(ref(db, `votes/aziza/${currentEditId}`)).then(() => {
                showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙˆØª");
                closePopup('edit-popup');
            });
        }

        window.resetAllData = function() {
            if(!confirm("ØªØ­Ø°ÙŠØ± Ø®Ø·ÙŠØ±!\nØ³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙˆØ§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
            remove(ref(db, 'votes/aziza')).then(() => showToast("ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„"));
        }

        window.sendNotify = function() {
            const msg = document.getElementById('notify-msg').value.trim();
            const target = document.querySelector('input[name="n-target"]:checked').value;
            if(!msg) return showToast("Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹");
            let branches = target === "both" ? ["24","25"] : [target];
            Promise.all(
                branches.map(br => {
                    const notifRef = push(ref(db, `notifications/committee_${br}`));
                    return set(notifRef, {
                        message: msg,
                        timestamp: Date.now(),
                        sender: isAdmin ? "Ù…Ø¯ÙŠØ± Ø§Ù„ÙƒÙ†ØªØ±ÙˆÙ„" : "Ù…Ø±Ø§Ù‚Ø¨"
                    });
                })
            ).then(() => {
                showToast(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ù„Ø¬Ù†Ø© ${branches.length === 2 ? "24 Ùˆ 25" : branches[0]}`);
                document.getElementById('notify-msg').value = '';
            });
        }

        window.closePopup = function(id) {
            document.getElementById(id).classList.add('hidden');
            if(id === 'details-popup') tempPopupCommittee = null;
        }

        window.showToast = function(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3500);
        }

        window.exportExcel = function() {
            let csv = '\uFEFFØ§Ù„Ø±Ù‚Ù…,Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ù„Ø¬Ù†Ø©,Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†,Ø§Ù„Ø­Ø§Ù„Ø©,Ø§Ù„ÙˆÙ‚Øª\n';
            allVotes.forEach((v, i) => {
                const cands = v.selected ? `"${v.selected.join(" | ")}"` : "";
                const time = new Date(v.timestamp).toLocaleString('ar-EG');
                csv += `${i+1},"${v.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}",${v.committee},${cands},${v.vote_validity},"${time}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø¹Ø²ÙŠØ²Ø©_Ø§Ù„Ø£ØµÙˆØ§Øª.csv";
            link.click();
        }

        function updateCharts() {
            const counts = candidatesList.map(c => allVotes.reduce((acc, v) => (v.selected && v.selected.includes(c)) ? acc + 1 : acc, 0));

            const ctxBar = document.getElementById('barChart').getContext('2d');
            if(charts.bar) charts.bar.destroy();
            charts.bar = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: candidatesList,
                    datasets: [{
                        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª',
                        data: counts,
                        backgroundColor: 'rgba(17,153,142,0.8)',
                        borderColor: '#11998e',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            const timeData = {};
            allVotes.forEach(v => {
                const timeKey = new Date(v.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                timeData[timeKey] = (timeData[timeKey] || 0) + 1;
            });

            const keys = Object.keys(timeData).reverse().slice(0, 25).reverse();
            const values = keys.map(k => timeData[k]);

            const ctxLine = document.getElementById('lineChart').getContext('2d');
            if(charts.line) charts.line.destroy();
            charts.line = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: keys,
                    datasets: [{
                        label: 'Ù†Ø´Ø§Ø· Ø§Ù„ØªØµÙˆÙŠØª',
                        data: values,
                        borderColor: '#38ef7d',
                        backgroundColor: 'rgba(56,239,125,0.2)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#38ef7d',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }
    </script>
</body>
</html>
