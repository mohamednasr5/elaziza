<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø²ÙŠØ²Ø© Ø§Ù„Ø¥Ù†ØªØ®Ø§Ø¨ÙŠØ©</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
* {margin:0;padding:0;box-sizing:border-box;font-family:"Cairo",sans-serif;}
body {background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:#222;min-height:100vh;}
#lock-screen {position:fixed;inset:0;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,0.7);backdrop-filter:blur(10px);z-index:9999;}
.lock-box {background:#fff;width:90%;max-width:400px;padding:40px 30px;border-radius:20px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:slideUp 0.4s ease;}
@keyframes slideUp {from{opacity:0;transform:translateY(40px);}to{opacity:1;transform:translateY(0);}}
.lock-box h2 {color:#11998e;margin-bottom:10px;font-size:1.8em;}
.lock-box p {font-size:0.95em;color:#666;margin-bottom:30px;}
.lock-row {margin-bottom:15px;position:relative;}
.lock-row input {width:100%;padding:14px 16px;border-radius:12px;border:2px solid #d4f1e8;background:#f0fdf9;text-align:center;font-size:1.1em;transition:all 0.3s ease;}
.lock-row input:focus {outline:none;border-color:#11998e;box-shadow:0 0 0 3px rgba(17,153,142,0.1);}
.lock-toggle {position:absolute;left:15px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:1.3em;}
.lock-box button {margin-top:20px;width:100%;padding:13px;background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:#fff;border:none;border-radius:12px;font-size:1.05em;font-weight:700;cursor:pointer;transition:all 0.3s ease;}
.lock-box button:hover {transform:translateY(-2px);}
.lock-error {margin-top:15px;background:#ffebee;color:#c62828;padding:10px;font-weight:700;display:none;border-radius:10px;}
.hidden {display:none !important;}
.dashboard {max-width:1400px;margin:auto;padding:25px;}
.dash-header {display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:20px;margin-bottom:30px;background:rgba(255,255,255,0.95);padding:25px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.1);}
.dash-title {font-size:2.2em;font-weight:900;background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.dash-subtitle {font-size:0.95em;color:#999;}
.admin-badge {background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);padding:8px 14px;border-radius:50px;color:#fff;font-weight:700;font-size:0.9em;}
.live-badge {background:linear-gradient(135deg,#d4fc79 0%,#96f97b 100%);padding:10px 18px;border-radius:50px;color:#2d5016;font-weight:700;display:flex;gap:8px;align-items:center;}
.live-dot {width:12px;height:12px;border-radius:50%;background:#2d5016;animation:pulse 2s infinite;}
@keyframes pulse {0%,100%{transform:scale(1);}50%{transform:scale(1.2);}}
.cards {display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:25px;}
.card {background:rgba(255,255,255,0.95);padding:25px;border-radius:16px;border:1px solid rgba(17,153,142,0.1);box-shadow:0 8px 32px rgba(0,0,0,0.08);transition:all 0.3s;position:relative;overflow:hidden;}
.card::before {content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#11998e 0%,#38ef7d 100%);}
.card:hover {transform:translateY(-8px);box-shadow:0 16px 48px rgba(17,153,142,0.2);}
.card-title {font-size:0.85em;color:#999;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;}
.card-value {font-size:2.2em;font-weight:900;background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-top:10px;}
.card-note {font-size:0.75em;color:#bbb;margin-top:8px;}
.committee-stats-card {background:rgba(255,255,255,0.95);padding:25px;border-radius:16px;border:1px solid rgba(17,153,142,0.1);box-shadow:0 8px 32px rgba(0,0,0,0.08);margin-bottom:25px;}
.committee-stats-card h3 {background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:1.2em;margin-bottom:20px;font-weight:900;}
.committee-grid {display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;}
.committee-item {background:linear-gradient(135deg,#f0fdf9 0%,#d4f1e8 100%);padding:15px;border-radius:12px;transition:all 0.3s ease;cursor:pointer;border-left:4px solid #11998e;}
.committee-item:hover {background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:white;transform:scale(1.05);box-shadow:0 8px 24px rgba(17,153,142,0.3);}
.committee-num {font-size:1.1em;font-weight:900;margin-bottom:8px;}
.committee-name {font-size:0.85em;font-weight:700;margin-bottom:4px;opacity:0.9;}
.committee-count {font-size:0.75em;opacity:0.8;}
.notify-panel {background:rgba(255,255,255,0.95);padding:25px;border-radius:16px;border:1px solid rgba(17,153,142,0.1);box-shadow:0 8px 32px rgba(0,0,0,0.08);margin-bottom:25px;}
.notify-panel h3 {background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:1.2em;margin-bottom:20px;font-weight:900;}
.notify-option {display:flex;gap:10px;align-items:center;margin-bottom:12px;font-weight:600;color:#333;}
.notify-panel textarea {width:100%;min-height:100px;padding:14px;background:#f0fdf9;border:2px solid #d4f1e8;border-radius:12px;margin-bottom:15px;font-size:1em;resize:vertical;transition:all 0.3s ease;font-family:"Cairo",sans-serif;}
.notify-panel textarea:focus {outline:none;border-color:#11998e;box-shadow:0 0 0 3px rgba(17,153,142,0.1);}
#notify-result {display:none;margin-top:12px;font-weight:800;font-size:0.95em;padding:12px;border-radius:10px;}
.charts-grid {display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:25px;}
.chart-card {background:rgba(255,255,255,0.95);padding:25px;border-radius:16px;border:1px solid rgba(17,153,142,0.1);box-shadow:0 8px 32px rgba(0,0,0,0.08);transition:all 0.3s ease;}
.chart-card:hover {box-shadow:0 12px 40px rgba(17,153,142,0.15);}
.chart-card h3 {margin-bottom:18px;background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:1.05em;font-weight:900;}
.ranking-card {background:rgba(255,255,255,0.95);padding:25px;border-radius:16px;border:1px solid rgba(17,153,142,0.1);margin-bottom:25px;box-shadow:0 8px 32px rgba(0,0,0,0.08);}
.ranking-card h3 {margin-bottom:20px;background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:1.2em;font-weight:900;}
.ranking-list {max-height:500px;overflow-y:auto;padding:5px;}
.ranking-item {display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:15px;background:linear-gradient(135deg,#f0fdf9 0%,#d4f1e8 100%);border-radius:12px;transition:all 0.3s;border-left:4px solid #11998e;}
.ranking-item:hover {background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:white;transform:translateX(-5px);box-shadow:0 8px 24px rgba(17,153,142,0.3);}
.ranking-left {display:flex;align-items:center;gap:12px;flex:1;}
.ranking-medal {font-size:1.6em;min-width:35px;text-align:center;}
.ranking-name {font-weight:700;}
.ranking-right {display:flex;align-items:center;gap:15px;}
.ranking-bar {height:28px;border-radius:14px;background:linear-gradient(90deg,#11998e 0%,#38ef7d 100%);display:flex;align-items:center;justify-content:center;color:#fff;font-size:0.85em;font-weight:700;min-width:80px;}
.ranking-count {font-weight:900;min-width:45px;text-align:center;}
.table-card {background:rgba(255,255,255,0.95);padding:25px;border-radius:16px;border:1px solid rgba(17,153,142,0.1);box-shadow:0 8px 32px rgba(0,0,0,0.08);}
.table-header {display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:18px;}
.search-input {padding:12px 16px;border-radius:12px;border:2px solid #d4f1e8;background:#f0fdf9;min-width:220px;font-size:0.95em;transition:all 0.3s ease;}
.search-input:focus {outline:none;border-color:#11998e;}
.btn-sm {padding:11px 18px;border:none;border-radius:12px;background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:#fff;cursor:pointer;font-weight:700;font-size:0.9em;transition:all 0.3s ease;}
.btn-sm:hover {transform:translateY(-2px);}
.btn-export {background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%) !important;}
.btn-reset-all {background:linear-gradient(135deg,#eb3349 0%,#f45c43 100%) !important;}
.table-wrap {max-height:450px;overflow:auto;border:1px solid #d4f1e8;border-radius:12px;}
table {width:100%;border-collapse:collapse;font-size:0.9em;}
thead {background:linear-gradient(135deg,#f0fdf9 0%,#d4f1e8 100%);position:sticky;top:0;z-index:10;}
th, td {padding:12px 14px;border-bottom:1px solid #d4f1e8;}
th {background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;cursor:pointer;font-weight:900;user-select:none;}
tr:hover td {background:rgba(17,153,142,0.05);}
.status-valid {color:#11998e;font-weight:900;}
.status-invalid {color:#eb3349;font-weight:900;}
.clickable-name {text-decoration:underline;cursor:pointer;color:#11998e;}
.btn-mini-edit {padding:6px 12px;border-radius:8px;background:#11998e;color:#fff;border:none;cursor:pointer;font-weight:700;font-size:0.8em;transition:all 0.3s ease;}
.btn-mini-edit:hover {background:#0d6b63;}
.footer-note {margin-top:12px;color:#999;font-size:0.85em;font-weight:600;}
.overlay {position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;justify-content:center;align-items:center;z-index:9000;backdrop-filter:blur(5px);}
.overlay.hidden {display:none !important;}
.popup {background:#fff;width:92%;max-width:600px;border-radius:16px;padding:25px;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-height:85vh;overflow-y:auto;animation:slideUp 0.3s ease;}
.popup-header {display:flex;justify-content:space-between;align-items:center;font-weight:900;background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:18px;font-size:1.2em;}
.popup-close {background:none;border:none;font-size:1.5em;cursor:pointer;color:#11998e;transition:all 0.3s ease;}
.popup-close:hover {transform:scale(1.2);}
.edit-list {max-height:280px;overflow:auto;border:2px solid #d4f1e8;border-radius:12px;padding:12px;background:#f0fdf9;}
.edit-list label {display:flex;justify-content:space-between;align-items:center;margin:8px 0;font-weight:700;color:#333;cursor:pointer;padding:8px;border-radius:8px;transition:all 0.3s ease;}
.edit-list label:hover {background:#d4f1e8;}
.edit-list input[type="checkbox"] {width:18px;height:18px;accent-color:#11998e;cursor:pointer;}
@media(max-width:900px){.charts-grid{grid-template-columns:1fr;}.committee-grid{grid-template-columns:repeat(auto-fill,minmax(180px,1fr));}.dash-header{flex-direction:column;}}
@media(max-width:600px){.dashboard{padding:15px;}.dash-title{font-size:1.6em;}.committee-grid{grid-template-columns:1fr;}.table-header{flex-direction:column;align-items:flex-start;}.search-input{min-width:100%;}.lock-box{padding:30px 20px;}.lock-box h2{font-size:1.5em;}.cards{grid-template-columns:1fr;}.card-value{font-size:1.8em;}.table-wrap{max-height:300px;}th,td{padding:8px 10px;font-size:0.85em;}.btn-sm{padding:9px 14px;font-size:0.85em;}.popup{width:95%;max-width:90vw;}}
</style>
</head>
<body>

<div id="lock-screen">
  <div class="lock-box">
    <h2>ğŸ›ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø²ÙŠØ²Ø©</h2>
    <p>Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</p>
    <div class="lock-row">
      <input id="lock-pass" type="password" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" autocomplete="off">
      <span id="toggle-pass" class="lock-toggle">ğŸ‘</span>
    </div>
    <button id="unlock-btn">Ø¯Ø®ÙˆÙ„</button>
    <div id="lock-error" class="lock-error"></div>
  </div>
</div>

<div id="dashboard" class="dashboard hidden">
  <div class="dash-header">
    <div>
      <div class="dash-title">ğŸ›ï¸ Ù„ÙˆØ­Ø© Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ø²ÙŠØ²Ø©</div>
      <div class="dash-subtitle">Ø§Ù„Ù„Ø¬Ù†Ø© 24 (Ø§Ù„Ø±Ø¬Ø§Ù„) + Ø§Ù„Ù„Ø¬Ù†Ø© 25 (Ø§Ù„Ù†Ø³Ø§Ø¡) | Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆØ­ÙŠØ©</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;">
      <div class="live-badge">
        <span class="live-dot"></span>
        <span id="live-status">Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±</span>
      </div>
      <div id="admin-badge" class="admin-badge"></div>
    </div>
  </div>

  <div class="cards">
    <div class="card"><div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª</div><div id="total-votes" class="card-value">0</div><div class="card-note">Ù…Ù† Ø§Ù„Ù„Ø¬Ù†ØªÙŠÙ†</div></div>
    <div class="card"><div class="card-title">Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</div><div id="valid-votes" class="card-value">0</div><div class="card-note">ØµØ­ÙŠØ­</div></div>
    <div class="card"><div class="card-title">Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ø¨Ø§Ø·Ù„Ø©</div><div id="invalid-votes" class="card-value">0</div><div class="card-note">Ø¨Ø§Ø·Ù„</div></div>
    <div class="card"><div class="card-title">Ù…ØªÙˆØ³Ø· Ø£ØµÙˆØ§Øª/Ø¯Ù‚ÙŠÙ‚Ø©</div><div id="vpm" class="card-value">0</div><div class="card-note">Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</div></div>
    <div class="card"><div class="card-title">Ø¢Ø®Ø± 10 Ø¯Ù‚Ø§Ø¦Ù‚</div><div id="vpm10" class="card-value">0</div><div class="card-note">Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div></div>
  </div>

  <div class="committee-stats-card">
    <h3>ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù„Ø¬Ù†ØªÙŠÙ†</h3>
    <div class="committee-grid" id="committee-grid"></div>
  </div>

  <div class="notify-panel">
    <h3>ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø©</h3>
    <label class="notify-option">
      <input type="radio" name="notify-target" value="24" checked>
      <span>Ø§Ù„Ù„Ø¬Ù†Ø© 24 (Ø§Ù„Ø±Ø¬Ø§Ù„)</span>
    </label>
    <label class="notify-option">
      <input type="radio" name="notify-target" value="25">
      <span>Ø§Ù„Ù„Ø¬Ù†Ø© 25 (Ø§Ù„Ù†Ø³Ø§Ø¡)</span>
    </label>
    <textarea id="notify-message" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©..."></textarea>
    <button class="btn-sm" style="width:100%" onclick="sendNotification()">Ø¥Ø±Ø³Ø§Ù„</button>
    <div id="notify-result"></div>
  </div>

  <div class="charts-grid">
    <div class="chart-card"><h3>Ø§Ù„Ø£ØµÙˆØ§Øª Ù„ÙƒÙ„ Ù…Ø±Ø´Ø­</h3><canvas id="chartCandidates"></canvas></div>
    <div class="chart-card"><h3>Ù†Ø³Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­ ÙˆØ§Ù„Ø¨Ø§Ø·Ù„</h3><canvas id="chartValidity"></canvas></div>
  </div>
  <div class="chart-card"><h3>Ø§Ù„Ø£ØµÙˆØ§Øª Ù„ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©</h3><canvas id="chartVPM"></canvas></div>

  <div class="ranking-card"><h3>ğŸ† ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†</h3>
    <div id="ranking-list" class="ranking-list"><div style="padding:20px;text-align:center;color:#999">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
  </div>

  <div class="table-card">
    <div class="table-header">
      <input id="search" class="search-input" placeholder="Ø¨Ø­Ø«...">
      <div style="display:flex;gap:8px;">
        <button class="btn-sm btn-export" onclick="exportCSV()">ØªØµØ¯ÙŠØ± CSV</button>
        <button id="btn-reset-all" class="btn-sm btn-reset-all" onclick="resetAll()">ØªØµÙÙŠØ±</button>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ù„Ø¬Ù†Ø©</th>
            <th>Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„ÙˆÙ‚Øª</th>
            <th id="edit-col">ØªØ¹Ø¯ÙŠÙ„</th>
          </tr>
        </thead>
        <tbody id="votes-table"></tbody>
      </table>
    </div>
    <div id="footer-note" class="footer-note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>
  </div>
</div>

<div id="committee-popup" class="overlay hidden">
  <div class="popup">
    <div class="popup-header">
      <h3 id="committee-popup-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù„Ø¬Ù†Ø©</h3>
      <button class="popup-close" onclick="closeCommitteePopup()">x</button>
    </div>
    <div id="committee-popup-body" style="padding:10px;"></div>
  </div>
</div>

<div id="details-popup" class="overlay hidden">
  <div class="popup">
    <div class="popup-header">
      <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø§Ø®Ø¨</h3>
      <button class="popup-close" onclick="closeDetails()">x</button>
    </div>
    <div id="details-body" style="padding:10px;"></div>
  </div>
</div>
<div id="edit-popup" class="overlay hidden">
  <div class="popup">
    <div class="popup-header">
      <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†</h3>
      <button class="popup-close" onclick="closeEdit()">x</button>
    </div>
    <div style="padding:10px;">
      <p id="edit-name" style="font-weight:700;margin-bottom:10px;"></p>
      <div id="edit-candidates" class="edit-list"></div>
      <button class="btn-sm" style="width:100%;margin-top:12px;" onclick="saveEdit()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.umd.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, remove, update, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBmgHAmoZKm2RRXg42KWdQHD4e5hAUtBbc",
  authDomain: "azizaonly-2ab60.firebaseapp.com",
  databaseURL: "https://azizaonly-2ab60-default-rtdb.firebaseio.com",
  projectId: "azizaonly-2ab60",
  storageBucket: "azizaonly-2ab60.firebasestorage.app",
  messagingSenderId: "447237336190",
  appId: "1:447237336190:web:eab8a2b524b0dcdd5a3c2f",
  measurementId: "G-3DYLFJC5YH"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const committeeData = {
  24: { name: "Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ø²ÙŠØ²Ø© Ù„Ø¬Ù†Ø© Ø±Ø¬Ø§Ù„", address: "Ù…Ø¯Ø±Ø³Ø© Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ø²ÙŠØ²Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" },
  25: { name: "Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ø²ÙŠØ²Ø© Ù„Ø¬Ù†Ø© Ù†Ø³Ø§Ø¡", address: "Ù…Ø¯Ø±Ø³Ø© Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ø²ÙŠØ²Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©" }
};
const candidatesNames = [
  "Ø§ÙŠÙ‡Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø¯Ù‡","Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹ØªÙ…Ø§Ù†Ù‰","Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯Ù‰",
  "Ø¹Ø§Ø¯Ù„ Ø§Ù„Ø¬ÙŠØ§Ø±","Ø§Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø³Ù…Ø±Ù‡","ÙˆÙ„ÙŠØ¯ ØªÙŠØ³ÙŠØ± Ø§Ù„Ø§Ù…ÙŠØ±",
  "ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹ÙŠØ³ÙˆÙ‰","Ø§Ù„Ø¨Ø¯ÙˆÙ‰ Ø¬Ù…ÙŠØ²","Ø§Ø­Ù…Ø¯ Ø§Ù„Ø±ÙŠØ³",
  "Ø£Ø­Ù…Ø¯ Ø¹ÙˆÙ","Ø­Ø³Ù† Ø§Ù„Ù…Ù„Ù‡Ø§Ø·","Ø¹Ù…Ø±Ùˆ Ù…Ø­Ù…Ø¯ Ø¨Ø­ÙŠØ±Ù‰",
  "Ø§Ù„Ø³ÙŠØ¯ Ø·Ù…Ø§Ù†","Ù…Ø­Ù…Ø¯ Ø¯Ù†Ø¯Ù†","Ù…Ø¬Ø¯Ù‰ Ø§Ù„Ø£Ù…ÙŠØ±"
];

window.toggleLockPass = function(){
  const inp = document.getElementById("lock-pass");
  inp.type = inp.type === "password" ? "text" : "password";
};

window.unlockDashboard = function(){
  const value = document.getElementById("lock-pass").value.trim();
  const err = document.getElementById("lock-error");
  if(value === "aziza100"){
    window.adminLevel = 0;
    document.getElementById("lock-screen").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");
    document.getElementById("admin-badge").textContent = "ğŸ‘ Ù…Ø´Ø§Ù‡Ø¯";
    document.getElementById("btn-reset-all").style.display = "none";
    document.getElementById("edit-col").style.display = "none";
    setupVotesListener();
  } else if(value === "azizaadmin"){
    window.adminLevel = 1;
    document.getElementById("lock-screen").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");
    document.getElementById("admin-badge").textContent = "ğŸ”‘ Ø§Ø¯Ù…Ù† ÙƒØ§Ù…Ù„";
    document.getElementById("btn-reset-all").style.display = "inline-block";
    document.getElementById("edit-col").style.display = "table-cell";
    setupVotesListener();
  } else {
    err.textContent = "ÙƒÙ„Ù…Ø© Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
    err.style.display = "block";
    setTimeout(() => err.style.display = "none", 2300);
  }
};

document.getElementById("lock-pass").addEventListener("keydown", e => { if(e.key === "Enter") window.unlockDashboard(); });
document.getElementById("unlock-btn").addEventListener("click", window.unlockDashboard);
document.getElementById("toggle-pass").addEventListener("click", window.toggleLockPass);

function showNotification(msg){
  const box = document.createElement("div");
  box.style.cssText = "position:fixed;bottom:20px;right:20px;background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:#fff;padding:16px 20px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.3);z-index:99999;font-size:1em;max-width:300px;";
  box.innerText = msg;
  document.body.appendChild(box);
  setTimeout(() => box.remove(), 4000);
}

let allVotes = [];
let votesListener = null;
function setupVotesListener() {
  if(votesListener) votesListener();
  const votesRef = ref(db, "votes/aziza");
  votesListener = onValue(votesRef, snapshot => {
    const data = snapshot.val() || {};
    allVotes = Object.entries(data).map(([id, v], i) => ({
      id,
      index: i + 1,
      name: v.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…",
      candidates: Array.isArray(v.selected) ? v.selected : [],
      validity: v.vote_validity || "",
      timestamp: v.timestamp || 0,
      committee: v.committee || 0
    }));
    renderAll();
  });
}

function renderAll(){
  renderStats();
  renderCommitteeStats();
  renderCharts();
  renderRanking();
  renderTable();
}

function renderStats(){
  const total = allVotes.length;
  const valid = allVotes.filter(v => v.validity === "ØµØ­ÙŠØ­").length;
  const invalid = allVotes.filter(v => v.validity === "Ø¨Ø§Ø·Ù„").length;
  document.getElementById("total-votes").textContent = total;
  document.getElementById("valid-votes").textContent = valid;
  document.getElementById("invalid-votes").textContent = invalid;

  if(total > 1){
    const sorted = [...allVotes].sort((a,b) => a.timestamp - b.timestamp);
    const t0 = sorted[0].timestamp;
    const t1 = sorted[sorted.length-1].timestamp;
    const minutes = ((t1-t0)/60000) || 1;
    document.getElementById("vpm").textContent = Math.round(total/minutes);
  }else{
    document.getElementById("vpm").textContent = "0";
  }

  const now = Date.now();
  const last10 = allVotes.filter(v => now-v.timestamp < (10*60000));
  document.getElementById("vpm10").textContent = last10.length;
}

function renderCommitteeStats(){
  const grid = document.getElementById("committee-grid");
  grid.innerHTML = "";
  Object.entries(committeeData).forEach(([num, info]) => {
    const votes = allVotes.filter(v => v.committee == num);
    const valid = votes.filter(v => v.validity === "ØµØ­ÙŠØ­").length;
    const invalid = votes.filter(v => v.validity === "Ø¨Ø§Ø·Ù„").length;
    grid.innerHTML += `
      <div class="committee-item" onclick="showCommitteeDetails(${num})">
        <div class="committee-num">Ø§Ù„Ù„Ø¬Ù†Ø© ${num}</div>
        <div class="committee-name">${info.name}</div>
        <div class="committee-count">ğŸ“Š ${votes.length} ØµÙˆØª</div>
        <div class="committee-count">âœ“ ${valid} | âœ— ${invalid}</div>
      </div>`;
  });
}

let chartCandidates=null, chartValidity=null, chartVPM=null;

function renderCharts(){
  const candidateCounts = candidatesNames.map(name =>
    allVotes.filter(v => v.candidates.includes(name)).length
  );
  if(chartCandidates){chartCandidates.destroy();}
  chartCandidates = new Chart(document.getElementById("chartCandidates"), {
    type: "bar",
    data: {
      labels: candidatesNames,
      datasets: [{
        label: "Ø£ØµÙˆØ§Øª Ø§Ù„Ù…Ø±Ø´Ø­",
        data: candidateCounts,
        backgroundColor: "#11998e"
      }]
    },
    options: {
      scales: {x:{ticks:{color:"#222",font:{weight:"bold"}}},y:{beginAtZero:true}},
      plugins:{legend:{display:false},title:{display:false}}
    }
  });

  const valid = allVotes.filter(v => v.validity === "ØµØ­ÙŠØ­").length;
  const invalid = allVotes.filter(v => v.validity === "Ø¨Ø§Ø·Ù„").length;
  if(chartValidity){chartValidity.destroy();}
  chartValidity = new Chart(document.getElementById("chartValidity"), {
    type: "doughnut",
    data: {
      labels: ["ØµØ­ÙŠØ­","Ø¨Ø§Ø·Ù„"],
      datasets: [{
        data: [valid,invalid],
        backgroundColor: ["#38ef7d","#eb3349"]
      }]
    },
    options: {plugins:{legend:{position:"bottom"}}}
  });

  if(chartVPM){chartVPM.destroy();}
  const byMin = {};
  allVotes.forEach(v => {
    const min = Math.floor(v.timestamp/60000);
    byMin[min] = (byMin[min]||0)+1;
  });
  const minLabels = Object.keys(byMin).map(m => new Date(m*60000).toLocaleTimeString());
  const minData = Object.values(byMin);
  chartVPM = new Chart(document.getElementById("chartVPM"), {
    type:"line",
    data:{labels:minLabels,datasets:[{label:"Ø£ØµÙˆØ§Øª/Ø¯Ù‚ÙŠÙ‚Ø©",data:minData,fill:true,borderColor:"#11998e",backgroundColor:"rgba(56,239,125,0.12)"}]},
    options:{scales:{x:{ticks:{color:"#222"}},y:{beginAtZero:true}},plugins:{legend:{display:false}}}
  });
}

function renderRanking(){
  const list = document.getElementById("ranking-list");
  const counts = candidatesNames.map(name => ({
    name,
    count: allVotes.filter(v => v.candidates.includes(name)).length
  })).sort((a,b) => b.count - a.count);
  list.innerHTML = "";
  counts.forEach((cand, i) => {
    const medal = i==0 ? "ğŸ¥‡" : i==1 ? "ğŸ¥ˆ" : i==2 ? "ğŸ¥‰" : "";
    list.innerHTML += `<div class="ranking-item">
      <div class="ranking-left">
        <div class="ranking-medal">${medal}</div>
        <div class="ranking-name">${cand.name}</div>
      </div>
      <div class="ranking-right">
        <div class="ranking-bar" style="width:${60+cand.count*6}px">${cand.count}</div>
        <div class="ranking-count">${cand.count}</div>
      </div>
    </div>`;
  });
}

function renderTable(){
  const table = document.getElementById("votes-table");
  const footer = document.getElementById("footer-note");
  const query = document.getElementById("search").value.trim();
  let results = allVotes;
  if(query.length){
    results = results.filter(v =>
      v.name.includes(query) ||
      v.candidates.some(n => n.includes(query)) ||
      (""+v.committee).includes(query)
    );
  }
  table.innerHTML = "";
  results.forEach((v, i) => {
    table.innerHTML += `<tr>
      <td>${v.index}</td>
      <td class="clickable-name" onclick="showDetails('${v.id}')">${v.name}</td>
      <td>${v.committee}</td>
      <td>${v.candidates.join(" | ")}</td>
      <td class="${v.validity === 'ØµØ­ÙŠØ­' ? 'status-valid':'status-invalid'}">${v.validity || "-"}</td>
      <td>${new Date(v.timestamp).toLocaleTimeString()}</td>
      <td>${window.adminLevel==1 ? `<button class="btn-mini-edit" onclick="showEdit('${v.id}')">ØªØ¹Ø¯ÙŠÙ„</button>`:""}</td>
    </tr>`;
  });
  footer.textContent = results.length ? "" : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª";
}

document.getElementById("search").addEventListener("input", renderTable);

window.showCommitteeDetails = function(num){
  const popup = document.getElementById("committee-popup");
  const body = document.getElementById("committee-popup-body");
  const info = committeeData[num];
  const votes = allVotes.filter(v => v.committee==num);
  const valid = votes.filter(v => v.validity === "ØµØ­ÙŠØ­").length;
  const invalid = votes.filter(v => v.validity === "Ø¨Ø§Ø·Ù„").length;
  
  let vpm = 0;
  const sorted = [...votes].sort((a,b) => a.timestamp - b.timestamp);
  if(sorted.length > 1){
    const t0 = sorted[0].timestamp;
    const t1 = sorted[sorted.length-1].timestamp;
    const minutes = ((t1-t0)/60000) || 1;
    vpm = votes.length / minutes;
  }
  
  const now = Date.now();
  const last10 = votes.filter(v => now-v.timestamp < (10*60000));
  
  popup.classList.remove("hidden");
  document.getElementById("committee-popup-title").textContent = info.name;
  
  body.innerHTML = `
    <div style="background:#f0fdf9;padding:15px;border-radius:12px;margin-bottom:15px;border-left:4px solid #11998e;">
      <div style="margin-bottom:8px;font-size:0.9em;color:#11998e;font-weight:700;">${info.address}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
        <div><small style="color:#999;font-weight:600;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª</small><div style="font-size:1.5em;font-weight:900;color:#11998e;">${votes.length}</div></div>
        <div><small style="color:#999;font-weight:600;">Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¬Ù†Ø©</small><div style="font-size:1.2em;font-weight:900;color:#11998e;">ğŸŸ¢ Ù†Ø´Ø·Ø©</div></div>
      </div>
      <div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div><small style="color:#11998e;font-weight:600;">Ø£ØµÙˆØ§Øª ØµØ­ÙŠØ­Ø©</small><div style="font-size:1.3em;font-weight:900;color:#11998e;">${valid}</div></div>
        <div><small style="color:#eb3349;font-weight:600;">Ø£ØµÙˆØ§Øª Ø¨Ø§Ø·Ù„Ø©</small><div style="font-size:1.3em;font-weight:900;color:#eb3349;">${invalid}</div></div>
      </div>
    </div>
    
    <div style="background:#e8f5e9;padding:12px;border-radius:10px;margin-bottom:15px;border-left:4px solid #11998e;">
      <small style="color:#11998e;font-weight:600;">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£ØµÙˆØ§Øª/Ø¯Ù‚ÙŠÙ‚Ø© (Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©)</small>
      <div style="font-size:1.5em;font-weight:900;color:#11998e;">${vpm.toFixed(2)}</div>
    </div>
    
    <div style="background:#fff3e0;padding:12px;border-radius:10px;margin-bottom:15px;border-left:4px solid #ff9800;">
      <small style="color:#e65100;font-weight:600;">Ø£ØµÙˆØ§Øª Ø¢Ø®Ø± 10 Ø¯Ù‚Ø§Ø¦Ù‚</small>
      <div style="font-size:1.5em;font-weight:900;color:#e65100;">${last10.length}</div>
    </div>
    
    <h4 style="color:#11998e;margin:15px 0 10px 0;font-weight:900;border-bottom:2px solid #d4f1e8;padding-bottom:8px;">Ø§Ù„Ù†Ø§Ø®Ø¨ÙŠÙ† (${votes.length})</h4>
    <div style="max-height:300px;overflow-y:auto;">
      ${votes.map((v, i) => `
        <div style="padding:10px;margin-bottom:8px;background:${v.validity === 'ØµØ­ÙŠØ­' ? 'rgba(17,153,142,0.1)' : 'rgba(235,51,73,0.1)'};border-radius:10px;border-right:4px solid ${v.validity === 'ØµØ­ÙŠØ­' ? '#11998e' : '#eb3349'};">
          <div style="font-weight:700;color:#333;margin-bottom:4px;">${i + 1}. ${v.name}</div>
          <div style="font-size:0.85em;color:#666;margin-bottom:4px;">Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†: ${v.candidates.join(" Ùˆ ") || "â€”"}</div>
          <div style="display:flex;gap:8px;font-size:0.85em;">
            <span style="padding:3px 8px;background:${v.validity === 'ØµØ­ÙŠØ­' ? '#c8e6c9' : '#ffccbc'};border-radius:6px;color:#333;font-weight:700;">${v.validity === 'ØµØ­ÙŠØ­' ? 'âœ“' : 'âœ—'} ${v.validity}</span>
          </div>
        </div>
      `).join("")}
    </div>
  `;
};

window.closeCommitteePopup = function(){ 
  document.getElementById("committee-popup").classList.add("hidden"); 
};

window.showDetails = function(id){
  const popup = document.getElementById("details-popup");
  popup.classList.remove("hidden");
  const body = document.getElementById("details-body");
  const v = allVotes.find(x=>x.id===id);
  if(v){
    body.innerHTML = `<div><b>Ø§Ù„Ø§Ø³Ù…:</b> ${v.name}</div>
      <div><b>Ø§Ù„Ù„Ø¬Ù†Ø©:</b> ${v.committee}</div>
      <div><b>Ø§Ù„Ù…Ø±Ø´Ø­ÙˆÙ†:</b> ${v.candidates.join(" | ")}</div>
      <div><b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> <span class="${v.validity==='ØµØ­ÙŠØ­'?'status-valid':'status-invalid'}">${v.validity}</span></div>
      <div><b>Ø§Ù„ØªÙˆÙ‚ÙŠØª:</b> ${new Date(v.timestamp).toLocaleTimeString()}</div>`;
  }
};

window.closeDetails = function(){ 
  document.getElementById("details-popup").classList.add("hidden"); 
};

window.showEdit = function(id){
  const popup = document.getElementById("edit-popup");
  popup.classList.remove("hidden");
  const v = allVotes.find(x=>x.id===id);
  if(v){
    document.getElementById("edit-name").textContent = v.name;
    const editList = document.getElementById("edit-candidates");
    editList.innerHTML = "";
    candidatesNames.forEach(name => {
      editList.innerHTML += `<label>
        <span>${name}</span>
        <input type="checkbox" value="${name}" ${v.candidates.includes(name)?"checked":""}>
      </label>`;
    });
    window._editId = id;
  }
};

window.closeEdit = function(){ 
  document.getElementById("edit-popup").classList.add("hidden"); 
  window._editId = null; 
};

window.saveEdit = function(){
  const id = window._editId;
  if(id){
    const editList = document.getElementById("edit-candidates");
    const selected = [...editList.querySelectorAll("input:checked")].map(inp=>inp.value);
    if(selected.length === 0) return showNotification("Ø§Ø®ØªØ± Ù…Ø±Ø´Ø­ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
    if(selected.length > 2) return showNotification("Ø§Ø®ØªØ± Ù…Ø±Ø´Ø­ÙŠÙ† ÙÙ‚Ø·");
    update(ref(db, "votes/aziza/"+id), { selected });
    showNotification("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
    window.closeEdit();
  }
};

window.exportCSV = function(){
  if(!allVotes.length) { showNotification("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±"); return; }
  const header = ["#", "Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„Ù„Ø¬Ù†Ø©", "Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†", "Ø§Ù„Ø­Ø§Ù„Ø©", "Ø§Ù„ÙˆÙ‚Øª"];
  let csv = header.join(",") + "\n";
  allVotes.forEach(v => {
    csv += [
      v.index,
      `"${v.name.replace(/"/g, '""')}"`,
      v.committee,
      `"${v.candidates.join(" | ").replace(/"/g, '""')}"`,
      v.validity,
      new Date(v.timestamp).toLocaleTimeString()
    ].join(",") + "\n";
  });
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "aziza-votes.csv";
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>a.remove(), 600);
  showNotification("ØªÙ… ØªØµØ¯ÙŠØ± Ù…Ù„Ù CSV Ø¨Ù†Ø¬Ø§Ø­");
};

window.resetAll = function(){
  if(window.adminLevel!=1){ showNotification("ØµÙ„Ø§Ø­ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ©"); return; }
  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) return;
  remove(ref(db, "votes/aziza"))
    .then(()=>{ showNotification("ØªÙ… ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­"); })
    .catch(()=>{ showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø§Ù„ØªØµÙÙŠØ±"); });
};

window.sendNotification = async function(){
  const msg = document.getElementById("notify-message").value.trim();
  const target = document.querySelector("input[name='notify-target']:checked").value;
  const result = document.getElementById("notify-result");
  
  if(!msg){
    result.textContent = "Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©";
    result.style.color = "#eb3349";
    result.style.display = "block";
    return;
  }
  
  result.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
  result.style.color = "#667eea";
  result.style.display = "block";
  
  try {
    const timestamp = Date.now();
    const msgRef = ref(db, "notifications/committee_" + target + "/" + timestamp);
    
    await set(msgRef, {
      message: msg,
      topic: "committee_" + target,
      timestamp: timestamp,
      sentAt: new Date().toISOString()
    });
    
    result.textContent = "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ âœ“ Ù„Ù„Ø¬Ù†Ø© " + target;
    result.style.color = "#11998e";
    document.getElementById("notify-message").value = "";
    setTimeout(() => result.style.display = "none", 3500);
  } catch(err){
    result.textContent = "Ø®Ø·Ø£: " + err.message;
    result.style.color = "#eb3349";
    setTimeout(() => result.style.display = "none", 4000);
  }
};

</script>
</body>
</html>
