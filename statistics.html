<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة نتائج مجمع العزيزة - الإحصائيات</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:"Cairo",sans-serif;
  background:linear-gradient(135deg,#dbe5f3 20%,#eef1ff 80%);
  color:#222;
  min-height:100vh;
}
#password-overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.65); backdrop-filter:blur(8px);
  display:flex; align-items:center; justify-content:center; z-index:9999;
}
.password-box{
  background:#fff; padding:32px; border-radius:22px; width:90%; max-width:420px;
  box-shadow:0 15px 45px rgba(0,0,0,.4); text-align:center;
}
.password-box h2{font-size:1.8em; color:#1e3c72; margin-bottom:8px; font-weight:900}
.password-box p{color:#555; margin-bottom:18px; font-size:1.05em}
.pass-row{position:relative; margin:22px 0}
#pw-input{
  width:100%; padding:15px; border-radius:14px; border:2px solid #ced6f2;
  background:#f6f8ff; font-size:1.4em; text-align:center; font-weight:bold;
}
.pass-toggle{
  position:absolute; left:14px; top:50%; transform:translateY(-50%);
  font-size:1.6em; cursor:pointer; color:#1e3c72;
}
.password-box button{
  width:100%; padding:15px; background:#1e3c72; color:#fff;
  border:none; border-radius:14px; font-size:1.15em; font-weight:900; cursor:pointer;
  transition:.3s;
}
.password-box button:hover{background:#152d55}
.msg-warn{
  display:none; margin-top:12px; padding:10px; background:#ffd7dd;
  color:#8f0000; border-radius:10px; font-weight:bold; font-size:1em;
}
.hidden{display:none!important}
.dashboard{padding:20px; max-width:1380px; margin:auto}
.header{
  display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
  gap:18px; margin-bottom:22px; padding:18px; background:#fff;
  border-radius:18px; box-shadow:0 6px 20px rgba(0,0,0,.1);
}
.title{font-size:2em; font-weight:900; color:#1e3c72}
.current-view{
  font-size:1.15em; font-weight:bold; color:#e91e63; background:#fff0f5;
  padding:10px 20px; border-radius:40px;
}
.toggle-buttons{
  display:flex; gap:12px; flex-wrap:wrap; justify-content:center;
}
.toggle-btn{
  padding:11px 22px; border:none; border-radius:40px; cursor:pointer;
  font-weight:900; font-size:1em; transition:.3s;
}
.toggle-btn.active{
  background:#1e3c72; color:#fff;
}
.toggle-btn:not(.active){
  background:#e2e8f5; color:#1e3c72;
}
.badge-live{
  background:#d9ffee; padding:10px 18px; border-radius:40px; font-weight:900;
  color:#0b7040; display:flex; align-items:center; gap:10px; font-size:1.05em;
}
.dot{width:11px;height:11px;background:#0b7040;border-radius:50%;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.7);opacity:.6}}
.cards{
  display:grid; grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
  gap:18px; margin-bottom:24px;
}
.card{
  background:#fff; padding:20px; border-radius:18px; text-align:center;
  box-shadow:0 6px 18px rgba(0,0,0,.08); border:1px solid #e4e8f5;
}
.card-title{font-size:1em; color:#607089; font-weight:700}
.card-value{font-size:2.4em; font-weight:900; color:#1e3c72; margin:10px 0}
.card-note{font-size:.88em; color:#777}
.charts-grid{
  display:grid; grid-template-columns:2fr 1fr; gap:20px; margin-bottom:24px;
}
.chart-card{
  background:#fff; padding:20px; border-radius:18px;
  box-shadow:0 6px 18px rgba(0,0,0,.08); border:1px solid #e4e8f5;
}
.chart-card h3{margin-bottom:14px; color:#1e3c72; font-weight:900; font-size:1.1em}
.ranking-card{
  background:#fff; padding:20px; border-radius:18px; margin-bottom:24px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}
.ranking-list{max-height:500px; overflow-y:auto; padding-right:8px}
.ranking-item{
  display:flex; justify-content:space-between; align-items:center;
  padding:14px; margin-bottom:12px; background:#f7f9ff;
  border-radius:14px; border-left:6px solid #1e3c72; transition:.25s;
}
.ranking-item:hover{background:#eef2ff; transform:translateY(-2px)}
.ranking-item.rank-1{border-left-color:#ffd700}
.ranking-item.rank-2{border-left-color:#c0c0c0}
.ranking-item.rank-3{border-left-color:#cd7f32}
.ranking-medal{font-size:1.8em}
.ranking-name{font-weight:900; color:#1e3c72; font-size:1.05em}
.ranking-bar{
  height:32px; background:linear-gradient(90deg,#1e3c72,#2a5298);
  border-radius:14px; min-width:130px; color:#fff; font-weight:900;
  display:flex; align-items:center; justify-content:center; font-size:.95em;
}
.ranking-count{font-size:1.3em; font-weight:900; color:#1e3c72; min-width:60px; text-align:center}
.table-card{background:#fff; padding:20px; border-radius:18px; box-shadow:0 6px 18px rgba(0,0,0,.08)}
.table-header{
  display:flex; justify-content:space-between; flex-wrap:wrap; gap:14px; margin-bottom:14px;
}
.search-input{padding:12px 16px; border:2px solid #d8e0f8; border-radius:12px; min-width:220px; font-size:1em}
.btn-sm{padding:12px 20px; background:#1e3c72; color:#fff; border:none; border-radius:12px; cursor:pointer; font-weight:900; font-size:1em}
.btn-export{background:#1f8f4f}
.btn-reset-all{background:#c0392b}
.table-wrap{max-height:460px; overflow:auto; border:1px solid #e4e8f5; border-radius:12px}
table{width:100%; border-collapse:collapse; font-size:.95em}
thead{background:#eef2ff; position:sticky; top:0; z-index:10}
th,td{padding:12px 10px; border-bottom:1px solid #eef2ff; text-align:right}
th{cursor:pointer; color:#1e3c72; font-weight:900}
.status-valid{color:#0b7040; font-weight:900}
.status-invalid{color:#b00020; font-weight:900}
.section-men{color:#1565c0; font-weight:700}
.section-women{color:#c2185b; font-weight:700}
.footer-note{margin-top:12px; color:#555; font-size:.9em; text-align:center}
@media(max-width:900px){
  .charts-grid{grid-template-columns:1fr}
  .toggle-buttons{justify-content:center}
}
</style>
</head>
<body>

<!-- Password Overlay -->
<div id="password-overlay">
  <div class="password-box">
    <h2>مجمع العزيزة الانتخابي</h2>
    <p>لوحة التحكم والإحصائيات المباشرة</p>
    <div class="pass-row">
      <input id="pw-input" type="password" placeholder="••••••" autocomplete="off">
      <span class="pass-toggle" onclick="togglePass()">View</span>
    </div>
    <button onclick="unlock()">دخول</button>
    <div id="pw-error" class="msg-warn"></div>
  </div>
</div>

<!-- Dashboard -->
<div class="dashboard hidden" id="dashboard">
  <div class="header">
    <div>
      <div class="title">لوحة نتائج الانتخابات</div>
      <div class="current-view" id="current-view-text">إحصائيات عامة (رجال + نساء)</div>
    </div>
    <div class="badge-live">
      <span class="dot"></span>
      <span id="live-status">بث مباشر</span>
    </div>
  </div>

  <!-- Toggle View -->
  <div style="text-align:center; margin-bottom:25px">
    <div class="toggle-buttons">
      <button class="toggle-btn active" data-view="all">الكل (عام)</button>
      <button class="toggle-btn" data-view="men">رجال فقط</button>
      <button class="toggle-btn" data-view="women">نساء فقط</button>
    </div>
  </div>

  <!-- Cards -->
  <div class="cards">
    <div class="card"><div class="card-title">إجمالي الأصوات</div><div id="total-votes" class="card-value">0</div></div>
    <div class="card"><div class="card-title">الأصوات الصحيحة</div><div id="valid-votes" class="card-value">0</div></div>
    <div class="card"><div class="card-title">الأصوات الباطلة</div><div id="invalid-votes" class="card-value">0</div></div>
    <div class="card"><div class="card-title">متوسط الأصوات/دقيقة</div><div id="vpm" class="card-value">0</div></div>
  </div>

  <!-- Charts -->
  <div class="charts-grid">
    <div class="chart-card">
      <h3>عدد الأصوات لكل مرشح</h3>
      <canvas id="chartCandidates"></canvas>
    </div>
    <div class="chart-card">
      <h3>نسبة الصحيح والباطل</h3>
      <canvas id="chartValidity"></canvas>
    </div>
  </div>

  <!-- Ranking -->
  <div class="ranking-card">
    <h3>ترتيب المرشحين حسب عدد الأصوات</h3>
    <div class="ranking-list" id="ranking-list"></div>
  </div>

  <!-- Table -->
  <div class="table-card">
    <div class="table-header">
      <input id="search" class="search-input" placeholder="بحث بالاسم أو المرشح...">
      <div>
        <button class="btn-sm btn-export" onclick="exportCSV()">تصدير CSV</button>
        <button class="btn-sm btn-reset-all" onclick="resetAll()">تصفير الكل</button>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>الناخب</th>
            <th>المرشحون</th>
            <th>الحالة</th>
            <th>الوقت</th>
            <th>القسم</th>
          </tr>
        </thead>
        <tbody id="votes-table"></tbody>
      </table>
    </div>
    <div class="footer-note" id="footer-note">جاري تحميل البيانات...</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC9j__hwloitAcYuLOyP-ydoB3ffHng0wM",
  authDomain: "elaziza-9c09f.firebaseapp.com",
  databaseURL: "https://elaziza-9c09f-default-rtdb.firebaseio.com",
  projectId: "elaziza-9c09f",
  storageBucket: "elaziza-9c09f.firebasestorage.app",
  messagingSenderId: "166855726580",
  appId: "1:166855726580:web:f9ced2806b65265a8e95a1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let votesMen = [], votesWomen = [], currentView = "all";
let chartCandidates = null, chartValidity = null;

const candidateNames = [
  "ايهاب العمده","محمد العتمانى","أحمد الحديدى","عادل الجيار",
  "احمد محمد محمد سمره","وليد تيسير الامير","كمال العيسوى","البدوى جميز",
  "احمد الريس","أحمد عوف","حسن الملهاط","عمرو محمد بحيرى",
  "السيد طمان","محمد دندن","مجدى الأمير"
];

// Password
window.togglePass = () => {
  const x = document.getElementById("pw-input");
  x.type = x.type === "password" ? "text" : "password";
};

window.unlock = () => {
  const pw = document.getElementById("pw-input").value.trim();
  const err = document.getElementById("pw-error");
  if(["205050", "506070", "521988"].includes(pw)){
    document.getElementById("password-overlay").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");
    loadData();
  } else {
    err.textContent = "كلمة السر غير صحيحة";
    err.style.display = "block";
    setTimeout(()=>err.style.display="none", 3000);
  }
};

// Load Data
function loadData(){
  onValue(ref(db, "votes_men"), snap => {
    votesMen = objectToArray(snap.val(), "رجال");
    renderAll();
  });
  onValue(ref(db, "votes_women"), snap => {
    votesWomen = objectToArray(snap.val(), "نساء");
    renderAll();
  });
}

function objectToArray(obj, section){
  if(!obj) return [];
  return Object.entries(obj).map(([id, v]) => ({
    id,
    name: v.name || "",
    selected: Array.isArray(v.selected) ? v.selected : [],
    validity: v.vote_validity || "",
    timestamp: v.timestamp || 0,
    section
  }));
}

function getCurrentVotes(){
  if(currentView === "men") return votesMen;
  if(currentView === "women") return votesWomen;
  return [...votesMen, ...votesWomen];
}

// Render All
function renderAll(){
  const data = getCurrentVotes();
  updateViewText();
  renderCards(data);
  renderCharts(data);
  renderRanking(data);
  renderTable(data);
}

function updateViewText(){
  const texts = {
    all: "إحصائيات عامة (رجال + نساء)",
    men: "إحصائيات قسم الرجال فقط",
    women: "إحصائيات قسم النساء فقط"
  };
  document.getElementById("current-view-text").textContent = texts[currentView];
}

function renderCards(data){
  const total = data.length;
  const valid = data.filter(v => v.validity === "صحيح").length;
  const invalid = data.filter(v => v.validity === "باطل").length;
  document.getElementById("total-votes").textContent = total;
  document.getElementById("valid-votes").textContent = valid;
  document.getElementById("invalid-votes").textContent = invalid;

  let vpm = 0;
  if(total > 0 && data[0].timestamp){
    const first = data.reduce((min, v) => v.timestamp < min ? v.timestamp : min, data[0].timestamp);
    const minutes = (Date.now() - first) / 60000;
    vpm = minutes > 0 ? (total / minutes).toFixed(2) : total;
  }
  document.getElementById("vpm").textContent = vpm;
}

function renderCharts(data){
  const candCount = {};
  data.forEach(v => v.selected.forEach(c => candCount[c] = (candCount[c]||0) + 1));
  const labels = Object.keys(candCount);
  const values = Object.values(candCount);
  const valid = data.filter(v => v.validity === "صحيح").length;
  const invalid = data.filter(v => v.validity === "باطل").length;

  if(chartCandidates){
    chartCandidates.data.labels = labels;
    chartCandidates.data.datasets[0].data = values;
    chartCandidates.update();
  } else {
    chartCandidates = new Chart(document.getElementById("chartCandidates"), {
      type: "bar",
      data: { labels, datasets: [{ label: "الأصوات", data: values, backgroundColor: "#1e3c72" }] },
      options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
  }

  if(chartValidity){
    chartValidity.data.datasets[0].data = [valid, invalid];
    chartValidity.update();
  } else {
    chartValidity = new Chart(document.getElementById("chartValidity"), {
      type: "doughnut",
      data: { labels: ["صحيح", "باطل"], datasets: [{ data: [valid, invalid], backgroundColor: ["#0b7040", "#b00020"] }] },
      options: { responsive: true, cutout: "60%" }
    });
  }
}

function renderRanking(data){
  const candCount = {};
  data.forEach(v => v.selected.forEach(c => candCount[c] = (candCount[c]||0) + 1));
  const sorted = Object.entries(candCount)
    .map(([name, count]) => ({name, count}))
    .sort((a,b) => b.count - a.count);

  const list = document.getElementById("ranking-list");
  if(sorted.length === 0){
    list.innerHTML = "<div style='text-align:center;color:#999;padding:30px'>لا توجد أصوات بعد</div>";
    return;
  }
  const max = sorted[0].count;
  list.innerHTML = sorted.map((item, i) => {
    const rank = i + 1;
    const medal = rank === 1 ? "1st" : rank === 2 ? "2nd" : rank === 3 ? "3rd" : `${rank}th`;
    const width = (item.count / max) * 100;
    return `
      <div class="ranking-item ${i < 3 ? `rank-${i+1}` : ''}">
        <div style="display:flex; align-items:center; gap:12px">
          <div class="ranking-medal">${medal}</div>
          <div class="ranking-name">${item.name}</div>
        </div>
        <div style="display:flex; align-items:center; gap:14px">
          <div class="ranking-bar" style="width:${Math.max(width,20)}%">${item.count}</div>
          <div class="ranking-count">${item.count}</div>
        </div>
      </div>`;
  }).join("");
}

function renderTable(data){
  const search = (document.getElementById("search").value || "").toLowerCase().trim();
  let filtered = data.filter(v => {
    if(!search) return true;
    return v.name.toLowerCase().includes(search) || 
           v.selected.some(c => c.toLowerCase().includes(search));
  });

  const tbody = document.getElementById("votes-table");
  tbody.innerHTML = "";
  filtered.forEach((v, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${v.name}</td>
      <td>${v.selected.length ? v.selected.join(" و ") : "—"}</td>
      <td class="${v.validity === "صحيح" ? "status-valid" : "status-invalid"}">${v.validity}</td>
      <td>${new Date(v.timestamp).toLocaleTimeString("ar-EG", {hour:"2-digit", minute:"2-digit", second:"2-digit"})}</td>
      <td class="section-${v.section === "رجال" ? "men" : "women"}">${v.section}</td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById("footer-note").textContent = 
    filtered.length ? `تم عرض ${filtered.length} صوت` : "لا توجد نتائج مطابقة";
}

// Toggle Buttons
document.querySelectorAll(".toggle-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".toggle-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    currentView = btn.dataset.view;
    renderAll();
  });
});

// Export CSV
window.exportCSV = () => {
  const data = getCurrentVotes();
  if(data.length === 0) return alert("لا توجد بيانات للتصدير");
  let csv = "رقم,الاسم,المرشحون,الحالة,الوقت,القسم\n";
  data.forEach((v, i) => {
    csv += `${i+1},"${v.name}", "${v.selected.join(" | ")}", ${v.validity}, ${new Date(v.timestamp).toLocaleString("ar-EG")}, ${v.section}\n`;
  });
  const blob = new Blob(["\uFEFF" + csv], {type: "text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `نتائج_العزيزة_${currentView}_${new Date().toLocaleDateString("ar-EG")}.csv`;
  a.click();
};

// Reset All - كود التصفير 742018
window.resetAll = () => {
  const pw = prompt("أدخل كلمة سر التصفير الكامل (خطير جدًا)");
  if(pw !== "742018"){
    return alert("كلمة السر غير صحيحة");
  }
  if(!confirm("تحذير: سيتم حذف جميع الأصوات من قسم الرجال والنساء نهائيًا!\nهل أنت متأكد تمامًا؟")){
    return;
  }
  Promise.all([
    remove(ref(db, "votes_men")),
    remove(ref(db, "votes_women"))
  ]).then(() => {
    alert("تم تصفير جميع الإحصائيات بنجاح");
  }).catch(() => {
    alert("حدث خطأ أثناء التصفير");
  });
};

</script>
</body>
</html>