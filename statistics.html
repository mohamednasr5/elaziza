<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ù†ØªØ§Ø¦Ø¬ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ø²ÙŠØ²Ø© - Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:"Cairo",sans-serif;
  background:linear-gradient(135deg,#dbe5f3 20%,#eef1ff 80%);
  color:#222;
  min-height:100vh;
}

/* ========== Password Overlay ========== */
#password-overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.65); backdrop-filter:blur(8px);
  display:flex; align-items:center; justify-content:center; z-index:9999;
}
.password-box{
  background:#fff; padding:32px; border-radius:22px; width:90%; max-width:420px;
  box-shadow:0 15px 45px rgba(0,0,0,.4); text-align:center;
}
.password-box h2{font-size:1.8em; color:#1e3c72; margin-bottom:8px; font-weight:900}
.password-box p{color:#555; margin-bottom:18px; font-size:1.05em}
.pass-row{position:relative; margin:22px 0}
#pw-input{
  width:100%; padding:15px; border-radius:14px; border:2px solid #ced6f2;
  background:#f6f8ff; font-size:1.4em; text-align:center; font-weight:bold;
}
.pass-toggle{
  position:absolute; left:14px; top:50%; transform:translateY(-50%);
  font-size:1.6em; cursor:pointer; color:#1e3c72;
}
.password-box button{
  width:100%; padding:15px; background:#1e3c72; color:#fff;
  border:none; border-radius:14px; font-size:1.15em; font-weight:900; cursor:pointer;
  transition:.3s;
}
.password-box button:hover{background:#152d55}
.msg-warn{
  display:none; margin-top:12px; padding:10px; background:#ffd7dd;
  color:#8f0000; border-radius:10px; font-weight:bold; font-size:1em;
}
.hidden{display:none!important}

/* ========== Dashboard Layout ========== */
.dashboard{padding:20px; max-width:1380px; margin:auto}
.header{
  display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
  gap:18px; margin-bottom:22px; padding:18px; background:#fff;
  border-radius:18px; box-shadow:0 6px 20px rgba(0,0,0,.1);
}
.title{font-size:2em; font-weight:900; color:#1e3c72}
.current-view{
  font-size:1.15em; font-weight:bold; color:#e91e63; background:#fff0f5;
  padding:10px 20px; border-radius:40px;
}
.badge-live{
  background:#d9ffee; padding:10px 18px; border-radius:40px; font-weight:900;
  color:#0b7040; display:flex; align-items:center; gap:10px; font-size:1.05em;
}
.dot{width:11px;height:11px;background:#0b7040;border-radius:50%;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.7);opacity:.6}}

/* ========== Toggle Buttons ========== */
.toggle-buttons{
  display:flex; gap:12px; flex-wrap:wrap; justify-content:center;
}
.toggle-btn{
  padding:11px 22px; border:none; border-radius:40px; cursor:pointer;
  font-weight:900; font-size:1em; transition:.3s;
}
.toggle-btn.active{
  background:#1e3c72; color:#fff;
}
.toggle-btn:not(.active){
  background:#e2e8f5; color:#1e3c72;
}

/* ========== Cards ========== */
.cards{
  display:grid; grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
  gap:18px; margin-bottom:24px;
}
.card{
  background:#fff; padding:20px; border-radius:18px; text-align:center;
  box-shadow:0 6px 18px rgba(0,0,0,.08); border:1px solid #e4e8f5;
}
.card-title{font-size:1em; color:#607089; font-weight:700}
.card-value{font-size:2.4em; font-weight:900; color:#1e3c72; margin:10px 0}

/* ========== Charts ========== */
.charts-grid{
  display:grid; grid-template-columns:2fr 1fr; gap:20px; margin-bottom:24px;
}
.chart-card{
  background:#fff; padding:20px; border-radius:18px;
  box-shadow:0 6px 18px rgba(0,0,0,.08); border:1px solid #e4e8f5;
}
.chart-card h3{margin-bottom:14px; color:#1e3c72; font-weight:900; font-size:1.1em}

/* ========== Ranking List ========== */
.ranking-card{
  background:#fff; padding:20px; border-radius:18px; margin-bottom:24px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}
.ranking-list{max-height:500px; overflow-y:auto; padding-right:8px}
.ranking-item{
  display:flex; justify-content:space-between; align-items:center;
  padding:14px; margin-bottom:12px; background:#f7f9ff;
  border-radius:14px; border-left:6px solid #1e3c72; transition:.25s;
}
.ranking-item:hover{background:#eef2ff; transform:translateY(-2px)}
.ranking-item.rank-1{border-left-color:#ffd700}
.ranking-item.rank-2{border-left-color:#c0c0c0}
.ranking-item.rank-3{border-left-color:#cd7f32}

/* ========== Table ========== */
.table-card{background:#fff; padding:20px; border-radius:18px; box-shadow:0 6px 18px rgba(0,0,0,.08)}
.table-header{
  display:flex; justify-content:space-between; flex-wrap:wrap; gap:14px; margin-bottom:14px;
}
.search-input{padding:12px 16px; border:2px solid #d8e0f8; border-radius:12px; min-width:220px; font-size:1em}
.btn-sm{padding:12px 20px; background:#1e3c72; color:#fff; border:none; border-radius:12px; cursor:pointer; font-weight:900; font-size:1em}
.btn-export{background:#1f8f4f}
.btn-reset-all{background:#c0392b}
.table-wrap{max-height:460px; overflow:auto; border:1px solid #e4e8f5; border-radius:12px}
table{width:100%; border-collapse:collapse; font-size:.95em}
thead{background:#eef2ff; position:sticky; top:0; z-index:10}
th,td{padding:12px 10px; border-bottom:1px solid #eef2ff; text-align:right}

/* ========== Status Colors ========== */
.status-valid{color:#0b7040; font-weight:900}
.status-invalid{color:#b00020; font-weight:900}
.section-men{color:#1565c0; font-weight:700}
.section-women{color:#c2185b; font-weight:700}

/* ========== Footer ========== */
.footer-note{margin-top:12px; color:#555; font-size:.9em; text-align:center}

/* ========== MARQUEE (Ø´Ø±ÙŠØ· Ù…ØªØ­Ø±Ùƒ) ========== */
.marquee-container{
  width:100%;
  background:#1e3c72;
  padding:12px 0;
  margin-top:25px;
  border-radius:12px;
  box-shadow:0 4px 15px rgba(0,0,0,.15);
  overflow:hidden;
}

.marquee-text{
  white-space:nowrap;
  display:inline-block;
  padding-right:100%; /* Ø¨Ø¯Ù„ padding-left */
  font-size:1.25em;
  font-weight:900;
  color:#fff;
  animation:scrollRight 28s linear infinite;  /* Ø¨Ø·Ø¡ Ø£ÙƒØ«Ø± */
}

@keyframes scrollRight{
  0%{ transform:translateX(-100%); }
  100%{ transform:translateX(100%); }
}

/* RESPONSIVE */
@media(max-width:900px){
  .charts-grid{grid-template-columns:1fr}
  .toggle-buttons{justify-content:center}
}
</style>
</head>

<body>

<!-- ========== Password Overlay ========== -->
<div id="password-overlay">
  <div class="password-box">
    <h2>Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ø²ÙŠØ²Ø© Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨ÙŠ</h2>
    <p>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</p>
    <div class="pass-row">
      <input id="pw-input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
      <span class="pass-toggle" onclick="togglePass()">ğŸ‘</span>
    </div>
    <button onclick="unlock()">Ø¯Ø®ÙˆÙ„</button>
    <div id="pw-error" class="msg-warn"></div>
  </div>
</div>

<!-- ========== Dashboard ========== -->
<div class="dashboard hidden" id="dashboard">

  <div class="header">
    <div>
      <div class="title">Ù„ÙˆØ­Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª</div>
      <div class="current-view" id="current-view-text">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø© (Ø±Ø¬Ø§Ù„ + Ù†Ø³Ø§Ø¡)</div>
    </div>
    <div class="badge-live">
      <span class="dot"></span>
      <span id="live-status">Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±</span>
    </div>
  </div>

  <!-- Toggle -->
  <div style="text-align:center; margin-bottom:25px">
    <div class="toggle-buttons">
      <button class="toggle-btn active" data-view="all">Ø§Ù„ÙƒÙ„ (Ø¹Ø§Ù…)</button>
      <button class="toggle-btn" data-view="men">Ø±Ø¬Ø§Ù„ ÙÙ‚Ø·</button>
      <button class="toggle-btn" data-view="women">Ù†Ø³Ø§Ø¡ ÙÙ‚Ø·</button>
    </div>
  </div>

  <!-- Cards -->
  <div class="cards">
    <div class="card"><div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª</div><div id="total-votes" class="card-value">0</div></div>
    <div class="card"><div class="card-title">Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</div><div id="valid-votes" class="card-value">0</div></div>
    <div class="card"><div class="card-title">Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ø¨Ø§Ø·Ù„Ø©</div><div id="invalid-votes" class="card-value">0</div></div>
    <div class="card"><div class="card-title">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£ØµÙˆØ§Øª/Ø¯Ù‚ÙŠÙ‚Ø©</div><div id="vpm" class="card-value">0</div></div>
  </div>

  <!-- Charts -->
  <div class="charts-grid">
    <div class="chart-card">
      <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª Ù„ÙƒÙ„ Ù…Ø±Ø´Ø­</h3>
      <canvas id="chartCandidates"></canvas>
    </div>
    <div class="chart-card">
      <h3>Ù†Ø³Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­ ÙˆØ§Ù„Ø¨Ø§Ø·Ù„</h3>
      <canvas id="chartValidity"></canvas>
    </div>
  </div>

  <!-- Ranking -->
  <div class="ranking-card">
    <h3>ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†</h3>
    <div class="ranking-list" id="ranking-list"></div>
  </div>

  <!-- Votes Table -->
  <div class="table-card">
    <div class="table-header">
      <input id="search" class="search-input" placeholder="Ø¨Ø­Ø«...">
      <div>
        <button class="btn-sm btn-export" onclick="exportCSV()">ØªØµØ¯ÙŠØ± CSV</button>
        <button class="btn-sm btn-reset-all" onclick="resetAll()">ØªØµÙÙŠØ± Ø§Ù„ÙƒÙ„</button>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th><th>Ø§Ù„Ù†Ø§Ø®Ø¨</th><th>Ø§Ù„Ù…Ø±Ø´Ø­ÙˆÙ†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù‚Ø³Ù…</th>
          </tr>
        </thead>
        <tbody id="votes-table"></tbody>
      </table>
    </div>
    <div id="footer-note" class="footer-note">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
  </div>

  <!-- ========== MARQUEE BAR ========== -->
  <div class="marquee-container">
    <div class="marquee-text">
      ÙƒÙ„ Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ø­Ø¨ ÙˆØ§Ù„Ø§Ø­ØªØ±Ø§Ù… Ù„Ù„Ø§Ø³ØªØ§Ø° Ø§Ù„Ø¨Ø¯ÙˆÙŠ Ø¬Ù…ÙŠØ² Ø±Ù…Ø² Ø§Ù„Ø­ÙˆØª Ø±Ù‚Ù… 8 â€” Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¥Ù‡Ø¯Ø§Ø¡ Ù…Ù† Ø§Ø¨Ù† Ø§Ù„Ø£Ø­Ù…Ø¯ÙŠØ© Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ù†ØµØ±
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø§Ø®Ø¨ -->
<div id="popup-modal" class="hidden" style="position:fixed;inset:0;z-index:10000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6)">
  <div id="popup-box" style="background:#fff;padding:36px 25px;max-width:400px;width:96%;border-radius:16px;box-shadow:0 12px 48px #0002;color:#333;position:relative;text-align:center">
    <span style="position:absolute;left:15px;top:15px;font-size:1.7em;cursor:pointer;color:#e91e63" onclick="closePopup()">âœ•</span>
    <div id="popup-content"></div>
  </div>
</div>

<!-- Firebase + Logic -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC9j__hwloitAcYuLOyP-ydoB3ffHng0wM",
  authDomain: "elaziza-9c09f.firebaseapp.com",
  databaseURL: "https://elaziza-9c09f-default-rtdb.firebaseio.com",
  projectId: "elaziza-9c09f",
  storageBucket: "elaziza-9c09f.appspot.com",
  messagingSenderId: "166855726580",
  appId: "1:166855726580:web:f9ced2806b65265a8e95a1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let votesMen = [], votesWomen = [], currentView = "all";
let chartCandidates = null, chartValidity = null;

function togglePass(){ const x=document.getElementById("pw-input"); x.type=x.type==="password"?"text":"password"; }
window.togglePass = togglePass;

window.unlock = () => {
  const pw=document.getElementById("pw-input").value.trim();
  if(["205050","506070","521988"].includes(pw)){
    document.getElementById("password-overlay").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");
    loadData();
  } else {
    const err=document.getElementById("pw-error");
    err.textContent="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
    err.style.display="block";
    setTimeout(()=>err.style.display="none",3000);
  }
};

function loadData(){
  onValue(ref(db,"votes_men"), snap=>{ votesMen=toArr(snap.val(),"Ø±Ø¬Ø§Ù„"); renderAll(); });
  onValue(ref(db,"votes_women"), snap=>{ votesWomen=toArr(snap.val(),"Ù†Ø³Ø§Ø¡"); renderAll(); });
}

function toArr(obj,section){
  if(!obj) return [];
  return Object.entries(obj).map(([id,v])=>({
    id, name:v.name, selected:v.selected||[],
    validity:v.vote_validity, timestamp:v.timestamp, section
  }));
}

function currentVotes(){
  if(currentView==="men") return votesMen;
  if(currentView==="women") return votesWomen;
  return [...votesMen,...votesWomen];
}
function renderAll(){
  const data=currentVotes();
  renderCards(data);
  renderCharts(data);
  renderRanking(data);
  renderTable(data);
}

// ========== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ==========
function renderTable(data){
  const q=(document.getElementById("search").value||"").toLowerCase();
  const filtered=data.filter(v=>
    v.name.toLowerCase().includes(q) ||
    v.selected.some(c=>c.toLowerCase().includes(q))
  );
  const tbody=document.getElementById("votes-table");
  tbody.innerHTML=filtered.map((v,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>
        ${v.name}
        <button onclick="showVoter(${JSON.stringify(v).replace(/"/g,"&quot;")})" style="margin-right:6px;padding:2px 8px;background:#e3e8f6;border-radius:8px;cursor:pointer;font-size:0.93em;border:0">Ø¹Ø±Ø¶</button>
        <button onclick="editVoter('${v.id}','${v.section}')" style="padding:2px 8px;margin-right:3px;background:#eee;border-radius:8px;cursor:pointer;font-size:0.93em;border:0">ØªØ¹Ø¯ÙŠÙ„</button>
      </td>
      <td>${v.selected.join(" Ùˆ ")}</td>
      <td class="${v.validity==="ØµØ­ÙŠØ­"?"status-valid":"status-invalid"}">${v.validity}</td>
      <td>${new Date(v.timestamp).toLocaleTimeString("ar-EG")}</td>
      <td class="section-${v.section==="Ø±Ø¬Ø§Ù„"?"men":"women"}">${v.section}</td>
    </tr>
  `).join("");
  document.getElementById("footer-note").textContent =
    filtered.length ? `ØªÙ… Ø¹Ø±Ø¶ ${filtered.length} ØµÙˆØª` : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©";
}
// Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ù†Ø§Ø®Ø¨ Ø¨ÙƒÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
window.closePopup = function() {
  document.getElementById("popup-modal").classList.add("hidden");
};

window.showVoter = function(voter) {
  let msg = `<h2 style="color:#1e3c72">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø§Ø®Ø¨</h2>
    <div><b>Ø§Ù„Ø§Ø³Ù…:</b> ${voter.name}</div>
    <div><b>Ø§Ù„Ù…Ø±Ø´Ø­ÙˆÙ†:</b> ${voter.selected.join("ØŒ ") || '<span style="color:#999">---</span>'}</div>
    <div><b>Ø§Ù„ÙˆÙ‚Øª:</b> ${new Date(voter.timestamp).toLocaleString("ar-EG")}</div>
    <div><b>Ø§Ù„Ù‚Ø³Ù…:</b> ${voter.section}</div>`;

  // Ø¥Ø´Ø¹Ø§Ø± "Ø¨ÙŠØ¯Ø¹Ù…Ù†Ø§" Ù„Ù„Ø£Ø³ØªØ§Ø° Ø§Ù„Ø¨Ø¯ÙˆÙŠ Ø¬Ù…ÙŠØ²
  if (voter.selected.includes("Ø§Ù„Ø¨Ø¯ÙˆÙ‰ Ø¬Ù…ÙŠØ²")) {
    msg += `<div style="background:#d4edda;margin:18px 0;padding:11px;border-radius:12px;color:#137d37;font-weight:700">Ø¨ÙŠØ¯Ø¹Ù…Ù†Ø§</div>`;
  }
  // Ø¥Ø´Ø¹Ø§Ø± "Ø¨ÙŠÙƒØ±Ù‡Ù†Ø§" Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± Ø§Ø«Ù†ÙŠÙ† ÙˆÙ„ÙŠØ³ Ø¨ÙŠÙ†Ù‡Ù… Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯Ù‰ (Ø±Ù‚Ù… 3)
  if (voter.selected.length === 2 && !voter.selected.includes("Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯Ù‰")) {
    msg += `<div style="background:#ffd7dd;padding:11px;margin:18px 0;border-radius:12px;color:#b00020;font-weight:700">Ø¨ÙŠÙƒØ±Ù‡Ù†Ø§</div>`;
  }

  document.getElementById("popup-content").innerHTML = msg;
  document.getElementById("popup-modal").classList.remove("hidden");
};

// Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† Ù„Ø£ÙŠ Ù†Ø§Ø®Ø¨
window.editVoter = async function(voteId, section) {
  const refPath = section === "Ø±Ø¬Ø§Ù„" ? "votes_men" : "votes_women";
  const voteSnap = await get(ref(db, `${refPath}/${voteId}`));
  if (!voteSnap.exists()) {
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø§Ø®Ø¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"); return;
  }
  const data = voteSnap.val();
  let candidates = [
    "Ø§ÙŠÙ‡Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø¯Ù‡","Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹ØªÙ…Ø§Ù†Ù‰","Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ¯Ù‰","Ø¹Ø§Ø¯Ù„ Ø§Ù„Ø¬ÙŠØ§Ø±","Ø§Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø³Ù…Ø±Ù‡",
    "ÙˆÙ„ÙŠØ¯ ØªÙŠØ³ÙŠØ± Ø§Ù„Ø§Ù…ÙŠØ±","ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹ÙŠØ³ÙˆÙ‰","Ø§Ù„Ø¨Ø¯ÙˆÙ‰ Ø¬Ù…ÙŠØ²","Ø§Ø­Ù…Ø¯ Ø§Ù„Ø±ÙŠØ³","Ø£Ø­Ù…Ø¯ Ø¹ÙˆÙ",
    "Ø­Ø³Ù† Ø§Ù„Ù…Ù„Ù‡Ø§Ø·","Ø¹Ù…Ø±Ùˆ Ù…Ø­Ù…Ø¯ Ø¨Ø­ÙŠØ±Ù‰","Ø§Ù„Ø³ÙŠØ¯ Ø·Ù…Ø§Ù†","Ù…Ø­Ù…Ø¯ Ø¯Ù†Ø¯Ù†","Ù…Ø¬Ø¯Ù‰ Ø§Ù„Ø£Ù…ÙŠØ±"
  ];
  let html = `<h2 style="color:#1e3c72;font-size:1.2em;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ù†Ø§Ø®Ø¨</h2>
    <div><b>Ø§Ù„Ø§Ø³Ù…:</b> ${data.name}</div>
    <form id="edit-vote-form" style="margin-top:11px">
      <div style="text-align:right"><b>Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 2):</b></div>
      ${candidates.map(c => `
        <label style="margin-right:7px">
          <input type="checkbox" name="selected" value="${c}" ${data.selected && data.selected.includes(c) ? "checked" : ""}>
          ${c}
        </label>
      `).join("<br>")}
      <div style="margin-top:15px"><button type="submit" style="background:#1565c0;color:white;padding:8px 22px;border-radius:10px;border:none;font-size:1em">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button></div>
    </form>
    <div id="edit-msg" style="margin-top:10px;font-weight:700;color:#c00"></div>
  `;
  document.getElementById("popup-content").innerHTML = html;
  document.getElementById("popup-modal").classList.remove("hidden");
  document.getElementById("edit-vote-form").onsubmit = async function(e){
    e.preventDefault();
    let sel = Array.from(document.querySelectorAll('#edit-vote-form input[name="selected"]:checked')).map(x=>x.value);
    if (sel.length < 1 || sel.length > 2) {
      document.getElementById("edit-msg").textContent = "ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± 1 Ø¥Ù„Ù‰ 2 Ù…Ø±Ø´Ø­!";
      return;
    }
    await update(ref(db, `${refPath}/${voteId}`), { selected: sel });
    document.getElementById("edit-msg").textContent = "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­...";
    setTimeout(closePopup,1400);
  };
};

function renderCards(data){
  const total=data.length;
  const valid=data.filter(v=>v.validity==="ØµØ­ÙŠØ­").length;
  const invalid=data.filter(v=>v.validity==="Ø¨Ø§Ø·Ù„").length;
  document.getElementById("total-votes").textContent=total;
  document.getElementById("valid-votes").textContent=valid;
  document.getElementById("invalid-votes").textContent=invalid;
  let vpm=0;
  if(total>0 && data[0].timestamp){
    const first=Math.min(...data.map(v=>v.timestamp));
    const mins=(Date.now()-first)/60000;
    vpm=mins>0?(total/mins).toFixed(2):total;
  }
  document.getElementById("vpm").textContent=vpm;
}
function renderCharts(data){
  const cand={};
  data.forEach(v=>v.selected.forEach(c=>cand[c]=(cand[c]||0)+1));
  const labels=Object.keys(cand);
  const values=Object.values(cand);
  const valid=data.filter(v=>v.validity==="ØµØ­ÙŠØ­").length;
  const invalid=data.filter(v=>v.validity==="Ø¨Ø§Ø·Ù„").length;

  if(!chartCandidates){
    chartCandidates=new Chart(document.getElementById("chartCandidates"),{
      type:"bar",
      data:{labels,datasets:[{data:values,backgroundColor:"#1e3c72"}]},
      options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
  } else {
    chartCandidates.data.labels=labels;
    chartCandidates.data.datasets[0].data=values;
    chartCandidates.update();
  }

  if(!chartValidity){
    chartValidity=new Chart(document.getElementById("chartValidity"),{
      type:"doughnut",
      data:{labels:["ØµØ­ÙŠØ­","Ø¨Ø§Ø·Ù„"],datasets:[{data:[valid,invalid],backgroundColor:["#0b7040","#b00020"]}]},
      options:{responsive:true,cutout:"60%"}
    });
  } else {
    chartValidity.data.datasets[0].data=[valid,invalid];
    chartValidity.update();
  }
}
function renderRanking(data){
  const cand={};
  data.forEach(v=>v.selected.forEach(c=>cand[c]=(cand[c]||0)+1));
  const sorted=Object.entries(cand)
    .map(([name,count])=>({name,count}))
    .sort((a,b)=>b.count-a.count);
  const list=document.getElementById("ranking-list");
  list.innerHTML = sorted.length
  ? sorted.map((x,i)=>`
      <div class="ranking-item ${i<3?`rank-${i+1}`:""}">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="ranking-medal">${i+1}</div>
          <div class="ranking-name">${x.name}</div>
        </div>
        <div style="display:flex;align-items:center;gap:14px">
          <div class="ranking-bar" style="width:${Math.max((x.count/sorted[0].count)*100,25)}%">${x.count}</div>
        </div>
      </div>`
    ).join("")
  : "<div style='text-align:center;color:#999;padding:30px'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙˆØ§Øª Ø¨Ø¹Ø¯</div>";
}
document.querySelectorAll(".toggle-btn").forEach(btn=>{
  btn.onclick=()=>{document.querySelectorAll(".toggle-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    currentView=btn.dataset.view;
    renderAll();
  };
});
window.exportCSV = () => {
  const data=currentVotes();
  if(!data.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª");
  let csv="Ø±Ù‚Ù…,Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ù…Ø±Ø´Ø­ÙˆÙ†,Ø§Ù„Ø­Ø§Ù„Ø©,Ø§Ù„ÙˆÙ‚Øª,Ø§Ù„Ù‚Ø³Ù…\n";
  data.forEach((v,i)=>{
    csv+=`${i+1},"${v.name}","${v.selected.join(" | ")}",${v.validity},${new Date(v.timestamp).toLocaleString("ar-EG")},${v.section}\n`;
  });
  const blob=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="Ù†ØªØ§Ø¦Ø¬_Ø§Ù„Ø¹Ø²ÙŠØ²Ø©.csv";
  a.click();
};
window.resetAll = () => {
  const pw=prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„ØªØµÙÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„");
  if(pw!=="742018") return alert("Ø®Ø·Ø£ ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±");
  if(confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§!")){
    remove(ref(db,"votes_men"));
    remove(ref(db,"votes_women"));
    alert("ØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø¨Ù†Ø¬Ø§Ø­");
  }
};
</script>
</body>
</html>
